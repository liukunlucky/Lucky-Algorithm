import { ProblemModel, TestCase, ChoiceOption, ProblemType } from '../model/ProblemModel';
import { UserProgressModel, ProblemStatus } from '../model/UserProgressModel';
import { ProblemMockData } from '../mock/ProblemMockData';
import { UserProgressDao } from '../dao/UserProgressDao';
import { AppButton, AppButtonType } from '../components/AppButton';
import { TimeUtils } from '../utils/TimeUtils';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

interface TestResult {
  id: string;
  passed: boolean;
  executionTime: number;
  error?: string;
}

interface RouterParams {
  problemId: number;
}

@Entry
@Component
struct DailyProblemPage {
  @State problem: ProblemModel | null = null;
  @State userProgress: UserProgressModel | null = null;
  @State userCode: string = '';
  @State userAnswer: string[] = []; // é€‰æ‹©é¢˜ç­”æ¡ˆï¼Œæ”¯æŒå¤šé€‰
  @State testResults: TestResult[] = [];
  @State isRunning: boolean = false;
  @State showSubmitDialog: boolean = false;
  @State isSubmitted: boolean = false;
  @State isLoading: boolean = true;
  @State isFavorite: boolean = false;
  @State problemId: number = 0;
  @State showResultDialog: boolean = false;
  @State isCorrect: boolean = false;
  @State hasAnswered: boolean = false; // æ˜¯å¦å·²ç­”é¢˜
  
  private userProgressDao: UserProgressDao = new UserProgressDao();

  aboutToAppear() {
    const params = router.getParams() as RouterParams;
    if (params && params.problemId) {
      this.problemId = params.problemId;
      this.loadProblemDetail(params.problemId);
    }
  }

  build() {
    Stack() {
      Column() {
        this.buildHeader()

        if (this.problem) {
          Scroll() {
            Column({ space: 16 }) {
              // é¢˜ç›®ä¿¡æ¯å¡ç‰‡
              this.buildProblemInfo()
              
              // é¢˜ç›®å†…å®¹
              this.buildProblemContent()
              
              // ç­”é¢˜åŒºåŸŸ
              if (this.problem.type === ProblemType.SINGLE_CHOICE || this.problem.type === ProblemType.MULTIPLE_CHOICE) {
                this.buildChoiceOptions()
              }
              
              // è§£æåŒºåŸŸï¼ˆåªæœ‰ç­”é¢˜åæ‰æ˜¾ç¤ºï¼‰
              if (this.hasAnswered) {
                this.buildSolutionSection()
              }
            }
            .width('100%')
            .padding(16)
          }
          .layoutWeight(1)
          .width('100%')

          // åº•éƒ¨æ“ä½œæŒ‰é’®
          if (!this.hasAnswered) {
            this.buildBottomActions()
          }
        } else {
          this.buildLoadingState()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f5f5f5')

      if (this.showSubmitDialog) {
        this.buildSubmitDialog()
      }

      if (this.showResultDialog) {
        this.buildResultDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildHeader() {
    Row({ space: 16 }) {
      // è¿”å›æŒ‰é’®
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(40)
      .height(40)
      .backgroundColor('transparent')
      .onClick(() => {
        router.back();
      })

      // æ ‡é¢˜
      Text('æ¯æ—¥ä¸€é¢˜')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // æ”¶è—æŒ‰é’®
      Button() {
        Image(this.isFavorite ? $r('app.media.icon_like_full') : $r('app.media.icon_like'))
          .width(24)
          .height(24)
          .fillColor(this.isFavorite ? '#ff4757' : '#666666')
      }
      .width(40)
      .height(40)
      .backgroundColor('transparent')
      .onClick(() => {
        this.toggleFavorite();
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildProblemInfo() {
    Column({ space: 12 }) {
      // é¢˜ç›®æ ‡é¢˜
      Text(this.problem!.title)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .width('100%')
        .textAlign(TextAlign.Start)

      // é¢˜ç›®æ ‡ç­¾ï¼šç±»å‹ã€éš¾åº¦ã€ç±»åˆ«ç»Ÿä¸€åœ¨ä¸€è¡Œ
      Row({ space: 8 }) {
        // é¢˜ç›®ç±»å‹æ ‡æ³¨
        Row({ space: 6 }) {
          Text(this.problem!.type === ProblemType.SINGLE_CHOICE ? 'å•é€‰é¢˜' : 'å¤šé€‰é¢˜')
            .fontSize(12)
            .fontColor('#ffffff')
            .fontWeight(FontWeight.Medium)
        }
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor(this.problem!.type === ProblemType.SINGLE_CHOICE ? '#1890ff' : '#52c41a')
        .borderRadius(12)
        .border({
          width: 1,
          color: this.problem!.type === ProblemType.SINGLE_CHOICE ? '#1890ff' : '#52c41a'
        })

        // é¢˜ç›®éš¾åº¦
        Text(this.problem!.getDifficultyText())
          .fontSize(12)
          .fontColor('#ffffff')
          .backgroundColor(this.problem!.getDifficultyColor())
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(12)

        // é¢˜ç›®ç±»åˆ«
        Text(this.problem!.getCategoryText())
          .fontSize(12)
          .fontColor('#FFFFFF')
          .backgroundColor('#787408')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(12)
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .alignItems(HorizontalAlign.Start)
  }



  @Builder
  buildProblemContent() {
    Column({ space: 12 }) {
      Text('é¢˜ç›®æè¿°')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')

      Text(this.problem!.description)
        .fontSize(14)
        .fontColor('#666666')
        .lineHeight(22)
        .width('100%')

      // çº¦æŸæ¡ä»¶
      if (this.problem!.constraints) {
        Column({ space: 8 }) {
          Text('çº¦æŸæ¡ä»¶')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')

          Text(this.problem!.constraints)
            .fontSize(12)
            .fontColor('#333333')
            .backgroundColor('#f8f9fa')
            .padding(8)
            .borderRadius(4)
            .width('100%')
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildChoiceOptions() {
    Column({ space: 12 }) {
      Text('è¯·é€‰æ‹©ç­”æ¡ˆ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')

      Column({ space: 8 }) {
        ForEach(this.problem!.choices || [], (option: ChoiceOption) => {
          this.buildOptionItem(option)
        }, (option: ChoiceOption) => option.id)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildOptionItem(option: ChoiceOption) {
    Row({ space: 12 }) {
      // é€‰æ‹©æ¡†
      if (this.problem!.type === ProblemType.MULTIPLE_CHOICE) {
        // å¤šé€‰æ¡†
        Checkbox({ name: option.id, group: 'choices' })
          .select(this.isOptionSelected(option.id))
          .selectedColor('#F34F40')
          .onChange((value: boolean) => {
            this.selectOption(option.id, value);
          })
      } else {
        // å•é€‰æ¡†
        Radio({ value: option.id, group: 'choices' })
          .checked(this.isOptionSelected(option.id))
          .radioStyle({ checkedBackgroundColor: '#F34F40' })
          .onChange((isChecked: boolean) => {
            if (isChecked) {
              this.selectOption(option.id, true);
            }
          })
      }

      // é€‰é¡¹å†…å®¹
      Text(option.text)
        .fontSize(14)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Start)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(this.isOptionSelected(option.id) ? '#e6f7ff' : '#ffffff')
    .borderRadius(8)
    .border({
      width: 1,
      color: this.isOptionSelected(option.id) ? '#F34F40' : '#e0e0e0'
    })
    .onClick(() => {
      this.selectOption(option.id, !this.isOptionSelected(option.id));
    })
  }

  @Builder
  buildCodeEditor() {
    Column({ space: 12 }) {
      Text('ğŸ’» ä»£ç ç¼–è¾‘å™¨')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')

      TextArea({
        text: this.userCode,
        placeholder: 'è¯·åœ¨æ­¤å¤„ç¼–å†™æ‚¨çš„ä»£ç ...'
      })
        .width('100%')
        .height(300)
        .fontSize(14)
        .fontFamily('monospace')
        .backgroundColor('#f8f9fa')
        .borderRadius(8)
        .padding(12)
        .onChange((value: string) => {
          this.userCode = value;
        })

      // è¿è¡ŒæŒ‰é’®
      AppButton({
        buttonText: this.isRunning ? 'è¿è¡Œä¸­...' : 'è¿è¡Œä»£ç ',
        type: AppButtonType.PRIMARY,
        buttonWidth: 120,
        onButtonClick: () => {
          this.runCode();
        }
      })

      // æµ‹è¯•ç»“æœ
      if (this.testResults.length > 0) {
        this.buildTestResults()
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildTestResults() {
    Column({ space: 8 }) {
      Text('ğŸ§ª æµ‹è¯•ç»“æœ')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      ForEach(this.testResults, (result: TestResult) => {
        Row({ space: 8 }) {
          Image(result.passed ? $r('app.media.icon_correct_color') : $r('app.media.icon_error_color'))
            .width(16)
            .height(16)

          Text(`æµ‹è¯•ç”¨ä¾‹ ${result.id}`)
            .fontSize(12)
            .fontColor('#666666')
            .layoutWeight(1)

          Text(result.passed ? 'é€šè¿‡' : 'å¤±è´¥')
            .fontSize(12)
            .fontColor(result.passed ? '#52c41a' : '#f5222d')

          Text(`${result.executionTime}ms`)
            .fontSize(12)
            .fontColor('#999999')
        }
        .width('100%')
        .padding(8)
        .backgroundColor(result.passed ? '#f6ffed' : '#fff2f0')
        .borderRadius(4)
      }, (result: TestResult) => result.id)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }



  @Builder
  buildLoadingState() {
    Column({ space: 16 }) {
      Text('â³')
        .fontSize(48)
        .fontColor('#cccccc')

      Text('åŠ è½½ä¸­...')
        .fontSize(16)
        .fontColor('#999999')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildSolutionSection() {
    Column({ space: 16 }) {
      // è§£ææ ‡é¢˜
      Row({ space: 8 }) {
        Image($r('app.media.bulb_icon'))
          .width(20)
          .height(20)
          .fillColor('#ff6b35')
        
        Text('é¢˜ç›®è§£æ')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .width('100%')

      // è§£é¢˜æ€è·¯
      Column({ space: 8 }) {
        Text('è§£é¢˜æ€è·¯')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        Text(this.problem!.explanation || 'æš‚æ— è§£é¢˜æ€è·¯')
          .fontSize(14)
          .fontColor('#666666')
          .lineHeight(22)
          .width('100%')
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // å‚è€ƒä»£ç 
      if (this.problem!.solutionCode) {
        Column({ space: 8 }) {
          Text('ğŸ”§ å‚è€ƒä»£ç ')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')

          Text(this.problem!.solutionCode)
            .fontSize(12)
            .fontFamily('monospace')
            .fontColor('#333333')
            .backgroundColor('#f8f9fa')
            .padding(12)
            .borderRadius(8)
            .width('100%')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildBottomActions() {
    Row({ space: 12 }) {
      AppButton({
        buttonText: 'æäº¤ç­”æ¡ˆ',
        type: AppButtonType.PRIMARY,
        buttonWidth: 200,
        onButtonClick: () => {
          this.submitAnswer();
        }
      })
    }
    .width('100%')
    .height(80)
    .padding(16)
    .backgroundColor('#ffffff')
    .border({ width: { top: 1 }, color: '#f0f0f0' })
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildDailyBottomActions() {
    Row({ space: 12 }) {
      AppButton({
        buttonText: 'æäº¤ç­”æ¡ˆ',
        type: AppButtonType.PRIMARY,
        buttonWidth: 200,
        onButtonClick: () => {
          this.showSubmitDialog = true;
        }
      })
    }
    .width('100%')
    .height(80)
    .padding(16)
    .backgroundColor('#ffffff')
    .border({ width: { top: 1 }, color: '#f0f0f0' })
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildSubmitDialog() {
    Column()
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0, 0, 0, 0.5)')
      .onClick(() => {
        this.showSubmitDialog = false;
      })
      .position({ x: 0, y: 0 })
      .zIndex(999)

    Column({ space: 20 }) {
      Text('æäº¤ç­”æ¡ˆ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')

      Text('ç¡®å®šè¦æäº¤å½“å‰ç­”æ¡ˆå—ï¼Ÿæäº¤åå°†æ˜¾ç¤ºç­”é¢˜ç»“æœã€‚')
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .lineHeight(20)

      Row({ space: 12 }) {
        AppButton({
          buttonText: 'å–æ¶ˆ',
          type: AppButtonType.SECONDARY,
          buttonWidth: 100,
          onButtonClick: () => {
            this.showSubmitDialog = false;
          }
        })

        AppButton({
          buttonText: 'ç¡®å®šæäº¤',
          type: AppButtonType.PRIMARY,
          buttonWidth: 100,
          onButtonClick: () => {
            this.showSubmitDialog = false;
            this.submitAnswer();
          }
        })
      }
    }
    .width(280)
    .padding(24)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 })
    .position({ x: '50%', y: '50%' })
    .translate({ x: '-50%', y: '-50%' })
    .zIndex(1000)
  }

  @Builder
  buildResultDialog() {
    Column()
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0, 0, 0, 0.5)')
      .onClick(() => {
        this.showResultDialog = false;
      })
      .position({ x: 0, y: 0 })
      .zIndex(999)

    Column({ space: 20 }) {
      // ç»“æœå›¾æ ‡
      Image(this.isCorrect ? $r('app.media.icon_correct_color') : $r('app.media.icon_error_color'))
        .width(40)
        .height(40)

      Text(this.isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.isCorrect ? '#52c41a' : '#f5222d')

      Text(this.isCorrect ? 'æ­å–œæ‚¨å®Œæˆä»Šæ—¥æŒ‘æˆ˜ï¼' : 'ä¸è¦æ°”é¦ï¼ŒæŸ¥çœ‹è§£æç»§ç»­å­¦ä¹ å§ï¼')
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)

      Row({ space: 12 }) {
        AppButton({
          buttonText: 'æŸ¥çœ‹è§£æ',
          type: AppButtonType.SECONDARY,
          buttonWidth: 100,
          onButtonClick: () => {
            this.showResultDialog = false;
          }
        })

        AppButton({
          buttonText: 'å®Œæˆ',
          type: AppButtonType.PRIMARY,
          buttonWidth: 100,
          onButtonClick: () => {
            this.showResultDialog = false;
            router.back(); // è¿”å›é¦–é¡µ
          }
        })
      }
    }
    .width(300)
    .padding(24)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 })
    .position({ x: '50%', y: '50%' })
    .translate({ x: '-50%', y: '-50%' })
    .zIndex(1000)
  }

  private async loadProblemDetail(problemId: number): Promise<void> {
    try {
      this.isLoading = true;
      
      // åŠ è½½é¢˜ç›®æ•°æ®
      this.problem = ProblemMockData.getProblemById(problemId);
      
      if (this.problem) {
        // åˆå§‹åŒ–ç”¨æˆ·ç­”æ¡ˆ
        this.userAnswer = [];
        
        // åŠ è½½ç”¨æˆ·è¿›åº¦
        await this.loadUserProgress();
      }
    } catch (error) {
      console.error('Failed to load problem detail:', error);
    } finally {
      this.isLoading = false;
    }
  }

  private async loadUserProgress(): Promise<void> {
    try {
      this.userProgress = await this.userProgressDao.getUserProgress(this.problemId);
      if (this.userProgress) {
        this.isFavorite = this.userProgress.isFavorite;
        this.isSubmitted = this.userProgress.status !== ProblemStatus.NOT_ATTEMPTED;
      }
    } catch (error) {
      console.error('Failed to load user progress:', error);
    }
  }

  private isOptionSelected(optionId: string): boolean {
    return this.userAnswer.includes(optionId);
  }

  private selectOption(optionId: string, isSelected: boolean): void {
    if (this.problem!.type === ProblemType.SINGLE_CHOICE) {
      // å•é€‰ï¼šæ›¿æ¢é€‰æ‹©
      if (isSelected) {
        this.userAnswer = [optionId];
      }
    } else {
      // å¤šé€‰ï¼šæ ¹æ®isSelectedå‚æ•°æ·»åŠ æˆ–ç§»é™¤
      const index = this.userAnswer.indexOf(optionId);
      if (isSelected && index < 0) {
        this.userAnswer.push(optionId);
      } else if (!isSelected && index >= 0) {
        this.userAnswer.splice(index, 1);
      }
    }
  }

  private async runCode(): Promise<void> {
    if (!this.userCode.trim()) {
      return;
    }

    this.isRunning = true;
    this.testResults = [];

    try {
      // æ¨¡æ‹Ÿä»£ç è¿è¡Œ
      await new Promise<void>((resolve) => {
        setTimeout(() => {
          resolve();
        }, 1000);
      });

      // æ¨¡æ‹Ÿæµ‹è¯•ç»“æœ
      const testCases = this.problem!.testCases || [];
      const results: TestResult[] = [];

      for (let i = 0; i < testCases.length; i++) {
        const testCase = testCases[i];
        const result: TestResult = {} as TestResult;
        result.id = (i + 1).toString();
        result.passed = Math.random() > 0.3; // 70%é€šè¿‡ç‡
        result.executionTime = Math.floor(Math.random() * 100) + 10;
        results.push(result);
      }

      this.testResults = results;
    } catch (error) {
      console.error('Failed to run code:', error);
    } finally {
      this.isRunning = false;
    }
  }

  private async submitAnswer(): Promise<void> {
    if (!this.problem) return;

    // æ£€æŸ¥æ˜¯å¦æœ‰ç­”æ¡ˆ
    if (this.problem.type === ProblemType.SINGLE_CHOICE || this.problem.type === ProblemType.MULTIPLE_CHOICE) {
      if (this.userAnswer.length === 0) {
        return;
      }
    }

    try {
      let isCorrect = false;

      if (this.problem.type === ProblemType.SINGLE_CHOICE || this.problem.type === ProblemType.MULTIPLE_CHOICE) {
        // é€‰æ‹©é¢˜ï¼šæ£€æŸ¥ç­”æ¡ˆ
        const correctAnswers = this.problem.getCorrectOptions().map(option => option.id);
        isCorrect = this.userAnswer.length === correctAnswers.length && 
                   this.userAnswer.every(answer => correctAnswers.includes(answer));
      } else {
        // ç¼–ç¨‹é¢˜ï¼šæ£€æŸ¥æµ‹è¯•ç»“æœ
        isCorrect = this.testResults.length > 0 && this.testResults.every(result => result.passed);
      }

      this.isCorrect = isCorrect;

      // ä¿å­˜ç”¨æˆ·è¿›åº¦
      await this.saveUserProgress(isCorrect);

      // æ ‡è®°ä¸ºå·²ç­”é¢˜ï¼Œæ˜¾ç¤ºè§£æ
      this.hasAnswered = true;
      this.isSubmitted = true;

      // æ˜¾ç¤ºç»“æœå¯¹è¯æ¡†
      this.showResultDialog = true;

    } catch (error) {
      console.error('Failed to submit answer:', error);
    }
  }

  private async saveUserProgress(isCorrect: boolean): Promise<void> {
    try {
      const progress = new UserProgressModel();
      progress.problemId = this.problemId;
      progress.status = isCorrect ? ProblemStatus.COMPLETED : ProblemStatus.WRONG;
      progress.isFavorite = this.isFavorite;
      progress.lastAttempted = TimeUtils.getLocalISOString();
      progress.attemptCount = (this.userProgress?.attemptCount || 0) + 1;

      // è®°å½•ç­”é¢˜å°è¯•
      progress.recordAttempt(isCorrect);

      await this.userProgressDao.saveUserProgress(progress);
      this.userProgress = progress;
    } catch (error) {
      console.error('Failed to save user progress:', error);
    }
  }

  private async toggleFavorite(): Promise<void> {
    try {
      this.isFavorite = !this.isFavorite;
      
      if (this.userProgress) {
        this.userProgress.isFavorite = this.isFavorite;
        await this.userProgressDao.saveUserProgress(this.userProgress);
      } else {
        // åˆ›å»ºæ–°çš„ç”¨æˆ·è¿›åº¦è®°å½•
        const progress = new UserProgressModel();
        progress.problemId = this.problemId;
        progress.status = ProblemStatus.NOT_ATTEMPTED;
        progress.isFavorite = this.isFavorite;
        progress.lastAttempted = TimeUtils.getLocalISOString();
        progress.attemptCount = 0;
        
        await this.userProgressDao.saveUserProgress(progress);
        this.userProgress = progress;
      }
      
      // æ˜¾ç¤ºtoastæç¤º
      promptAction.showToast({
        message: this.isFavorite ? 'å·²æ·»åŠ åˆ°æ”¶è—å¤¹' : 'å·²å–æ¶ˆæ”¶è—',
        duration: 2000
      });
    } catch (error) {
      console.error('Failed to toggle favorite:', error);
      // å›æ»šçŠ¶æ€
      this.isFavorite = !this.isFavorite;
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      promptAction.showToast({
        message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }
}
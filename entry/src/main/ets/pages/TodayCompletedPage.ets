import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';
import { UserProgressDao } from '../dao/UserProgressDao';
import { UserProgressModel, ProblemStatus } from '../model/UserProgressModel';
import { ProblemMockData } from '../mock/ProblemMockData';
import { ProblemModel } from '../model/ProblemModel';

interface TodayProgress {
  progress: UserProgressModel;
  problem: ProblemModel | null;
}

interface TodayStats {
  totalCompleted: number;
  correctCount: number;
  wrongCount: number;
  accuracy: number;
  studyTime: number; // åˆ†é’Ÿ
  targetCount: number; // ä»Šæ—¥ç›®æ ‡
}

@Entry
@Component
struct TodayCompletedPage {
  @State todayStats: TodayStats = {
    totalCompleted: 0,
    correctCount: 0,
    wrongCount: 0,
    accuracy: 0,
    studyTime: 0,
    targetCount: 10
  };
  @State todayProgress: TodayProgress[] = [];
  @State selectedFilter: number = 0; // 0: å…¨éƒ¨, 1: ç­”å¯¹, 2: ç­”é”™
  @State isLoading: boolean = true;

  private userProgressDao: UserProgressDao = new UserProgressDao();

  aboutToAppear(): void {
    this.loadTodayData();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()

      if (this.isLoading) {
        this.buildLoadingState()
      } else {
        // å†…å®¹åŒºåŸŸ
        Column({ space: 16 }) {
          // ä»Šæ—¥ç»Ÿè®¡å¡ç‰‡
          this.buildStatsCard()

          // ä»Šæ—¥ç›®æ ‡è¿›åº¦
          this.buildTargetProgress()

          // è¿‡æ»¤å™¨
          this.buildFilterTabs()

          // ä»Šæ—¥å®Œæˆåˆ—è¡¨
          this.buildTodayList()
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row() {
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(32)
      .backgroundColor('transparent')
      .onClick(() => {
        router.back();
      })

      Text('ä»Šæ—¥å®Œæˆ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Blank().width(32)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
    .shadow({
      radius: 2,
      color: '#00000010',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  buildLoadingState() {
    Column({ space: 16 }) {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#F34F40')

      Text('æ­£åœ¨åŠ è½½ä»Šæ—¥æ•°æ®...')
        .fontSize(14)
        .fontColor('#666666')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildStatsCard() {
    Row() {
      Column({ space: 8 }) {
        Text(this.todayStats.totalCompleted.toString())
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#F34F40')

        Text('ä»Šæ—¥å®Œæˆ')
          .fontSize(14)
          .fontColor('#666666')
      }
      .alignItems(HorizontalAlign.Center)
      .layoutWeight(1)

      Divider()
        .vertical(true)
        .height(50)
        .strokeWidth(1)
        .color('#E5E7EB')

      Column({ space: 8 }) {
        Text(this.todayStats.correctCount.toString())
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#52c41a')

        Text('ç­”å¯¹é¢˜æ•°')
          .fontSize(14)
          .fontColor('#666666')
      }
      .alignItems(HorizontalAlign.Center)
      .layoutWeight(1)

      Divider()
        .vertical(true)
        .height(50)
        .strokeWidth(1)
        .color('#E5E7EB')

      Column({ space: 8 }) {
        Text(`${this.todayStats.accuracy}%`)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1890ff')

        Text('æ­£ç¡®ç‡')
          .fontSize(14)
          .fontColor('#666666')
      }
      .alignItems(HorizontalAlign.Center)
      .layoutWeight(1)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  buildTargetProgress() {
    Column({ space: 12 }) {
      Row() {
        Text('ä»Šæ—¥ç›®æ ‡è¿›åº¦')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)

        Text(`${this.todayStats.totalCompleted}/${this.todayStats.targetCount}`)
          .fontSize(14)
          .fontColor('#F34F40')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')

      Progress({
        value: this.todayStats.totalCompleted,
        total: this.todayStats.targetCount,
        type: ProgressType.Linear
      })
        .width('100%')
        .height(12)
        .color('#F34F40')
        .backgroundColor('#E5E7EB')
        .borderRadius(6)

      Row() {
        if (this.todayStats.totalCompleted >= this.todayStats.targetCount) {
          Row({ space: 8 }) {
            Image($r('app.media.icon_check'))
              .width(16)
              .height(16)
              .fillColor('#52c41a')

            Text('æ­å–œï¼ä»Šæ—¥ç›®æ ‡å·²è¾¾æˆ')
              .fontSize(12)
              .fontColor('#52c41a')
          }
        } else {
          Text(`è¿˜éœ€å®Œæˆ ${this.todayStats.targetCount - this.todayStats.totalCompleted} é“é¢˜ç›®`)
            .fontSize(12)
            .fontColor('#666666')
        }

        Blank()

        Text(`å­¦ä¹ æ—¶é•¿: ${this.formatStudyTime(this.todayStats.studyTime)}`)
          .fontSize(12)
          .fontColor('#666666')
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  buildFilterTabs() {
    Row() {
      this.buildFilterTab('å…¨éƒ¨', 0, this.todayStats.totalCompleted)
      this.buildFilterTab('ç­”å¯¹', 1, this.todayStats.correctCount)
      this.buildFilterTab('ç­”é”™', 2, this.todayStats.wrongCount)
    }
    .height(44)
    .backgroundColor('#ffffff')
    .borderRadius(22)
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  buildFilterTab(title: string, index: number, count: number) {
    Row({ space: 4 }) {
      Text(title)
        .fontSize(14)
        .fontColor(this.selectedFilter === index ? '#ffffff' : '#666666')
        .fontWeight(this.selectedFilter === index ? FontWeight.Medium : FontWeight.Normal)

      if (count > 0) {
        Text(count.toString())
          .fontSize(12)
          .fontColor(this.selectedFilter === index ? '#ffffff' : '#999999')
          .padding({ left: 4, right: 4, top: 1, bottom: 1 })
          .backgroundColor(this.selectedFilter === index ? 'rgba(255,255,255,0.2)' : '#F5F5F5')
          .borderRadius(8)
      }
    }
    .justifyContent(FlexAlign.Center)
    .layoutWeight(1)
    .height('100%')
    .backgroundColor(this.selectedFilter === index ? '#F34F40' : 'transparent')
    .borderRadius(22)
    .onClick(() => {
      this.selectedFilter = index;
    })
  }

  @Builder
  buildTodayList() {
    if (this.getFilteredProgress().length === 0) {
      this.buildEmptyState()
    } else {
      List({ space: 12 }) {
        ForEach(this.getFilteredProgress(), (item: TodayProgress, index: number) => {
          ListItem() {
            this.buildProgressItem(item, index + 1)
          }
        })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
    }
  }

  @Builder
  buildEmptyState() {
    Column({ space: 16 }) {
      Image($r('app.media.icon_empty'))
        .width(120)
        .height(90)

      Text(this.getEmptyText())
        .fontSize(16)
        .fontColor('#666666')

      Text('ç»§ç»­åŠªåŠ›ï¼Œå®Œæˆæ›´å¤šé¢˜ç›®å§ï¼')
        .fontSize(14)
        .fontColor('#999999')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildProgressItem(item: TodayProgress, sequence: number) {
    Row({ space: 12 }) {
      // åºå·å’ŒçŠ¶æ€
      Stack() {
        Circle()
          .width(28)
          .height(28)
          .fill(item.progress.status === ProblemStatus.COMPLETED ? '#52c41a' : '#ff4757')

        if (item.progress.status === ProblemStatus.COMPLETED) {
          Image($r('app.media.icon_check'))
            .width(16)
            .height(16)
            .fillColor('#ffffff')
        } else {
          Text('Ã—')
            .fontSize(16)
            .fontColor('#ffffff')
            .fontWeight(FontWeight.Bold)
        }
      }

      // é¢˜ç›®ä¿¡æ¯
      Column({ space: 6 }) {
        Row() {
          Text(`${sequence}. ${item.problem?.title || 'æœªçŸ¥é¢˜ç›®'}`)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)

          Text(item.problem?.getDifficultyText() || '')
            .fontSize(12)
            .fontColor('#ffffff')
            .backgroundColor(item.problem?.getDifficultyColor() || '#999999')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
        }
        .width('100%')

        Row({ space: 12 }) {
          Text(item.problem?.getCategoryText() || '')
            .fontSize(12)
            .fontColor('#666666')

          Text(this.formatTime(item.progress.lastAttempted))
            .fontSize(12)
            .fontColor('#999999')

          Text('ç”¨æ—¶: ä¼°ç®—' + (item.progress.attemptCount * 2) + 'åˆ†é’Ÿ') // æ ¹æ®å°è¯•æ¬¡æ•°ä¼°ç®—
            .fontSize(12)
            .fontColor('#999999')
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
      Button() {
        Image($r('app.media.icon_right_arrow'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .backgroundColor('transparent')
      .width(32)
      .height(32)
      .onClick(() => {
        this.navigateToProblemDetail(item.problem?.id || 0);
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  // åŠ è½½ä»Šæ—¥æ•°æ®
  private async loadTodayData(): Promise<void> {
    try {
      this.isLoading = true;
      console.info('ğŸ“… å¼€å§‹åŠ è½½ä»Šæ—¥å®Œæˆæ•°æ®');

      // è·å–ä»Šæ—¥å®Œæˆçš„é¢˜ç›®è¿›åº¦
      const todayProgressList = await this.userProgressDao.getTodayCompletedProgress();
      
      // å…³è”é¢˜ç›®ä¿¡æ¯
      const progressWithProblems: TodayProgress[] = [];
      for (const progress of todayProgressList) {
        const problem = ProblemMockData.getProblemById(progress.problemId);
        progressWithProblems.push({
          progress: progress,
          problem: problem
        });
      }

      this.todayProgress = progressWithProblems;

      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      this.calculateTodayStats();

      console.info('âœ… ä»Šæ—¥å®Œæˆæ•°æ®åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('âŒ åŠ è½½ä»Šæ—¥å®Œæˆæ•°æ®å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  // è®¡ç®—ä»Šæ—¥ç»Ÿè®¡
  private calculateTodayStats(): void {
    const totalCompleted = this.todayProgress.length;
    const correctCount = this.todayProgress.filter((item: TodayProgress): boolean => {
      return item.progress.status === ProblemStatus.COMPLETED;
    }).length;
    const wrongCount = totalCompleted - correctCount;
    const accuracy = totalCompleted > 0 ? Math.round((correctCount / totalCompleted) * 100) : 0;
    
    // è®¡ç®—å­¦ä¹ æ—¶é•¿ï¼ˆæ ¹æ®å°è¯•æ¬¡æ•°ä¼°ç®—ï¼‰
    const studyTime = this.todayProgress.reduce((total: number, item: TodayProgress): number => {
      return total + (item.progress.attemptCount * 2); // ä¼°ç®—æ¯æ¬¡å°è¯•2åˆ†é’Ÿ
    }, 0);

    this.todayStats = {
      totalCompleted: totalCompleted,
      correctCount: correctCount,
      wrongCount: wrongCount,
      accuracy: accuracy,
      studyTime: Math.ceil(studyTime / 60), // è½¬æ¢ä¸ºåˆ†é’Ÿ
      targetCount: 10
    };
  }

  // è·å–è¿‡æ»¤åçš„è¿›åº¦åˆ—è¡¨
  private getFilteredProgress(): TodayProgress[] {
    switch (this.selectedFilter) {
      case 1: // ç­”å¯¹
        return this.todayProgress.filter((item: TodayProgress): boolean => {
          return item.progress.status === ProblemStatus.COMPLETED;
        });
      case 2: // ç­”é”™
        return this.todayProgress.filter((item: TodayProgress): boolean => {
          return item.progress.status === ProblemStatus.WRONG;
        });
      default: // å…¨éƒ¨
        return this.todayProgress;
    }
  }

  // è·å–ç©ºçŠ¶æ€æ–‡æœ¬
  private getEmptyText(): string {
    switch (this.selectedFilter) {
      case 1:
        return 'ä»Šæ—¥è¿˜æ²¡æœ‰ç­”å¯¹çš„é¢˜ç›®';
      case 2:
        return 'ä»Šæ—¥æ²¡æœ‰ç­”é”™é¢˜ç›®ï¼ŒçœŸæ£’ï¼';
      default:
        return 'ä»Šæ—¥è¿˜æ²¡æœ‰å®Œæˆä»»ä½•é¢˜ç›®';
    }
  }

  // æ ¼å¼åŒ–å­¦ä¹ æ—¶é•¿
  private formatStudyTime(minutes: number): string {
    if (minutes < 60) {
      return `${minutes}åˆ†é’Ÿ`;
    } else {
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;
      return `${hours}å°æ—¶${remainingMinutes > 0 ? remainingMinutes + 'åˆ†é’Ÿ' : ''}`;
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(dateString: string): string {
    const date = new Date(dateString);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // æ ¼å¼åŒ–åšé¢˜ç”¨æ—¶
  private formatDuration(seconds: number): string {
    if (seconds < 60) {
      return `${seconds}ç§’`;
    } else {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}åˆ†${remainingSeconds}ç§’`;
    }
  }

  // å¯¼èˆªåˆ°é¢˜ç›®è¯¦æƒ…
  private navigateToProblemDetail(problemId: number): void {
    if (problemId > 0) {
      router.pushUrl({
        url: 'pages/ProblemDetailPage',
        params: {
          problemId: problemId,
          fromToday: true
        }
      }).catch((error: Error) => {
        console.error('å¯¼èˆªå¤±è´¥:', error);
      });
    }
  }
}
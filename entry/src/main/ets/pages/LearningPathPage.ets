import { ProblemCategory } from '../model/ProblemModel';
import { ProblemStatus } from '../model/UserProgressModel';
import { ProblemMockData } from '../mock/ProblemMockData';
import { UserProgressDao } from '../dao/UserProgressDao';
import { TabNavigationService } from '../service/TabNavigationService';
import router from '@ohos.router';

interface LearningPath {
  category: ProblemCategory;
  title: string;
  description: string;
  icon: Resource;
  totalProblems: number;
  completedProblems: number;
  difficulty: string;
  estimatedTime: string;
  color: string;
}

interface PathConfig {
  category: ProblemCategory;
  title: string;
  description: string;
  icon: Resource;
  difficulty: string;
  estimatedTime: string;
  color: string;
}

@Entry
@Component
export struct LearningPathPage {
  @State learningPaths: LearningPath[] = [];
  @State selectedPath: LearningPath | null = null;
  @State isLoading: boolean = true;
  @StorageLink('learningPathRefreshTrigger') @Watch('onRefreshTriggerChange') refreshTrigger: number = 0;
  
  // ä½¿ç”¨mockæ•°æ®ï¼Œä¸å†éœ€è¦æ•°æ®åº“å®ä¾‹
  private userProgressDao: UserProgressDao = new UserProgressDao();

  aboutToAppear() {
    this.loadLearningPaths();
  }

  /**
   * ç›‘å¬refreshTriggerå˜åŒ–ï¼Œå®ç°Tabåˆ‡æ¢æ—¶è‡ªåŠ¨åˆ·æ–°
   */
  onRefreshTriggerChange() {
    if (this.refreshTrigger > 0) {
      this.loadLearningPaths();
    }
  }

  /**
   * åˆ·æ–°å­¦ä¹ è·¯çº¿æ•°æ®
   * ä¾›å¤–éƒ¨è°ƒç”¨ï¼Œç”¨äºTabåˆ‡æ¢æ—¶æ›´æ–°æ•°æ®
   */
  refreshData(): void {
    this.loadLearningPaths();
  }

  build() {
    Column({ space: 16 }) {
      // é¡µé¢æ ‡é¢˜
      // this.buildHeader()

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        this.buildLoadingState()
      } else {
        // å­¦ä¹ è·¯çº¿åˆ—è¡¨
        this.buildPathList()
      }

      Blank()
    }
    .width('100%')
    .height('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Column({ space: 8 }) {
      Text('ğŸ—ºï¸ å­¦ä¹ è·¯çº¿')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .textAlign(TextAlign.Center)

      Text('ç³»ç»ŸåŒ–å­¦ä¹ ç®—æ³•ï¼Œå¾ªåºæ¸è¿›æå‡èƒ½åŠ›')
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .padding({ top: 20, bottom: 20 })
  }

  @Builder
  buildLoadingState() {
    Column({ space: 16 }) {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#1890ff')

      Text('æ­£åœ¨åŠ è½½å­¦ä¹ è·¯çº¿...')
        .fontSize(14)
        .fontColor('#666666')
    }
    .width('100%')
    .height(200)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildPathList() {
    List({ space: 12 }) {
      ForEach(this.learningPaths, (path: LearningPath) => {
        ListItem() {
          this.buildPathCard(path)
        }
      }, (path: LearningPath) => path.category.toString())
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildPathCard(path: LearningPath) {
    Column({ space: 12 }) {
      // å¡ç‰‡å¤´éƒ¨
      Row({ space: 12 }) {
        Column({ space: 4 }) {
          Text(path.title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)

          Text(path.description)
            .fontSize(14)
            .fontColor('#666666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .alignSelf(ItemAlign.Start)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        Column({ space: 4 }) {
          Text(path.difficulty)
            .fontSize(12)
            .fontColor('#ffffff')
            .backgroundColor(this.getDifficultyColor(path.difficulty))
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(10)

          Text(path.estimatedTime)
            .fontSize(12)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      // è¿›åº¦æ¡
      Column({ space: 8 }) {
        Row() {
          Text('å­¦ä¹ è¿›åº¦')
            .fontSize(14)
            .fontColor('#666666')

          Blank()

          Text(path.completedProblems + '/' + path.totalProblems)
            .fontSize(14)
            .fontColor('#333333')
            .fontWeight(FontWeight.Medium)
        }
        .width('100%')

        Progress({
          value: path.completedProblems,
          total: path.totalProblems,
          type: ProgressType.Linear
        })
        .width('100%')
        .height(6)
        .color(path.color)
        .backgroundColor('#f0f0f0')
      }

      // æ“ä½œæŒ‰é’®
      Row({ space: 12 }) {
        Button('æŸ¥çœ‹è¯¦æƒ…')
          .layoutWeight(1)
          .height(36)
          .backgroundColor('#ffffff')
          .fontColor(path.color)
          .border({ width: 1, color: path.color })
          .borderRadius(8)
          .onClick(() => {
            this.showPathDetail(path);
          })

        Button(path.completedProblems > 0 ? 'ç»§ç»­å­¦ä¹ ' : 'å¼€å§‹å­¦ä¹ ')
          .layoutWeight(1)
          .height(36)
          .backgroundColor(path.color)
          .fontColor('#ffffff')
          .borderRadius(8)
          .onClick(() => {
            this.startLearning(path);
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
    .onClick(() => {
      this.showPathDetail(path);
    })
  }

  private async loadLearningPaths(): Promise<void> {
    try {
      this.isLoading = true;
      
      // è·å–åŸºç¡€è·¯çº¿é…ç½®
      const pathConfigs = this.getPathConfigs();
      const paths: LearningPath[] = [];
      
      // ä¸ºæ¯ä¸ªè·¯çº¿åŠ è½½çœŸå®æ•°æ®
      for (const config of pathConfigs) {
        const allProblems = ProblemMockData.getAllProblems();
        const totalProblems = allProblems.filter(p => p.category === config.category).length;
        const completedProblems = await this.userProgressDao.getCompletedCountByCategory(config.category);
        
        const path: LearningPath = {
          category: config.category,
          title: config.title,
          description: config.description,
          icon: config.icon,
          totalProblems: totalProblems,
          completedProblems: completedProblems,
          difficulty: config.difficulty,
          estimatedTime: config.estimatedTime,
          color: config.color
        };
        
        paths.push(path);
      }
      
      this.learningPaths = paths;
    } catch (error) {
      console.error('Failed to load learning paths:', error);
      // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
      this.learningPaths = this.getDefaultPaths();
    } finally {
      this.isLoading = false;
    }
  }

  private getPathConfigs(): PathConfig[] {
    const configs: PathConfig[] = [];
    
    const config1: PathConfig = {
      category: ProblemCategory.ARRAY,
      title: 'æ•°ç»„ä¸å­—ç¬¦ä¸²',
      description: 'æŒæ¡åŸºç¡€æ•°æ®ç»“æ„æ“ä½œï¼Œå­¦ä¹ åŒæŒ‡é’ˆã€æ»‘åŠ¨çª—å£ç­‰ç»å…¸æŠ€å·§',
      icon: $r('app.media.chart_icon'),
      difficulty: 'å…¥é—¨',
      estimatedTime: '2-3å‘¨',
      color: '#1890ff'
    };
    
    const config2: PathConfig = {
      category: ProblemCategory.LINKED_LIST,
      title: 'é“¾è¡¨æ“ä½œ',
      description: 'ç†è§£æŒ‡é’ˆæ¦‚å¿µï¼ŒæŒæ¡é“¾è¡¨çš„å¢åˆ æ”¹æŸ¥ã€åè½¬ã€åˆå¹¶ç­‰æ“ä½œ',
      icon: $r('app.media.search_icon'),
      difficulty: 'åŸºç¡€',
      estimatedTime: '1-2å‘¨',
      color: '#52c41a'
    };
    
    const config3: PathConfig = {
      category: ProblemCategory.STRING,
      title: 'å­—ç¬¦ä¸²ç®—æ³•',
      description: 'å­¦ä¹ å­—ç¬¦ä¸²åŒ¹é…ã€ç¼–è¾‘è·ç¦»ã€å›æ–‡ç­‰ç»å…¸å­—ç¬¦ä¸²é—®é¢˜',
      icon: $r('app.media.note_icon'),
      difficulty: 'åŸºç¡€',
      estimatedTime: '1-2å‘¨',
      color: '#fa8c16'
    };
    
    const config4: PathConfig = {
      category: ProblemCategory.BINARY_TREE,
      title: 'äºŒå‰æ ‘',
      description: 'æŒæ¡æ ‘çš„éå†ã€æœç´¢ã€æ„å»ºï¼Œç†è§£äºŒå‰æœç´¢æ ‘çš„æ€§è´¨',
      icon: $r('app.media.book_icon'),
      difficulty: 'è¿›é˜¶',
      estimatedTime: '2-3å‘¨',
      color: '#13c2c2'
    };
    
    const config5: PathConfig = {
      category: ProblemCategory.TWO_POINTERS,
      title: 'åŒæŒ‡é’ˆæŠ€å·§',
      description: 'å­¦ä¹ å¿«æ…¢æŒ‡é’ˆã€å·¦å³æŒ‡é’ˆç­‰æŠ€å·§ï¼Œè§£å†³æ•°ç»„å’Œé“¾è¡¨é—®é¢˜',
      icon: $r('app.media.target_icon'),
      difficulty: 'è¿›é˜¶',
      estimatedTime: '2-3å‘¨',
      color: '#722ed1'
    };
    
    const config6: PathConfig = {
      category: ProblemCategory.DYNAMIC_PROGRAMMING,
      title: 'åŠ¨æ€è§„åˆ’',
      description: 'æŒæ¡çŠ¶æ€è½¬ç§»æ€æƒ³ï¼Œè§£å†³èƒŒåŒ…ã€è·¯å¾„ã€åºåˆ—ç­‰ç»å…¸DPé—®é¢˜',
      icon: $r('app.media.computer_icon'),
      difficulty: 'é«˜çº§',
      estimatedTime: '4-5å‘¨',
      color: '#eb2f96'
    };
    
    const config7: PathConfig = {
      category: ProblemCategory.BINARY_SEARCH,
      title: 'äºŒåˆ†æŸ¥æ‰¾',
      description: 'å­¦ä¹ äºŒåˆ†æŸ¥æ‰¾æ€æƒ³ï¼Œè§£å†³æœç´¢ã€è¾¹ç•ŒæŸ¥æ‰¾ç­‰é—®é¢˜',
      icon: $r('app.media.search_icon'),
      difficulty: 'è¿›é˜¶',
      estimatedTime: '2-3å‘¨',
      color: '#f5222d'
    };
    
    const config8: PathConfig = {
      category: ProblemCategory.MATH,
      title: 'æ•°å­¦ç®—æ³•',
      description: 'æŒæ¡æ•°å­¦æ€ç»´ï¼Œè§£å†³æ•°è®ºã€å‡ ä½•ã€æ¦‚ç‡ç­‰æ•°å­¦é—®é¢˜',
      icon: $r('app.media.computer_icon'),
      difficulty: 'è¿›é˜¶',
      estimatedTime: '2-3å‘¨',
      color: '#fa541c'
    };
    
    const config9: PathConfig = {
      category: ProblemCategory.STACK,
      title: 'æ ˆä¸é˜Ÿåˆ—',
      description: 'æŒæ¡æ ˆå’Œé˜Ÿåˆ—çš„åŸºæœ¬æ“ä½œï¼Œå­¦ä¹ å•è°ƒæ ˆã€ä¼˜å…ˆé˜Ÿåˆ—ç­‰é«˜çº§åº”ç”¨',
      icon: $r('app.media.book_icon'),
      difficulty: 'åŸºç¡€',
      estimatedTime: '2-3å‘¨',
      color: '#52c41a'
    };
    
    configs.push(config1, config2, config3, config4, config5, config6, config7, config8, config9);
    return configs;
  }

  private getDefaultPaths(): LearningPath[] {
    const paths: LearningPath[] = [];
    
    const path1: LearningPath = {
      category: ProblemCategory.ARRAY,
      title: 'æ•°ç»„ä¸å­—ç¬¦ä¸²',
      description: 'æŒæ¡åŸºç¡€æ•°æ®ç»“æ„æ“ä½œï¼Œå­¦ä¹ åŒæŒ‡é’ˆã€æ»‘åŠ¨çª—å£ç­‰ç»å…¸æŠ€å·§',
      icon: $r('app.media.chart_icon'),
      totalProblems: 25,
      completedProblems: 0,
      difficulty: 'å…¥é—¨',
      estimatedTime: '2-3å‘¨',
      color: '#1890ff'
    };
    
    const path2: LearningPath = {
      category: ProblemCategory.LINKED_LIST,
      title: 'é“¾è¡¨æ“ä½œ',
      description: 'ç†è§£æŒ‡é’ˆæ¦‚å¿µï¼ŒæŒæ¡é“¾è¡¨çš„å¢åˆ æ”¹æŸ¥ã€åè½¬ã€åˆå¹¶ç­‰æ“ä½œ',
      icon: $r('app.media.book_icon'),
      totalProblems: 18,
      completedProblems: 0,
      difficulty: 'åŸºç¡€',
      estimatedTime: '1-2å‘¨',
      color: '#52c41a'
    };
    
    const path3: LearningPath = {
      category: ProblemCategory.STRING,
      title: 'å­—ç¬¦ä¸²ç®—æ³•',
      description: 'å­¦ä¹ å­—ç¬¦ä¸²åŒ¹é…ã€ç¼–è¾‘è·ç¦»ã€å›æ–‡ç­‰ç»å…¸å­—ç¬¦ä¸²é—®é¢˜',
      icon: $r('app.media.note_icon'),
      totalProblems: 20,
      completedProblems: 0,
      difficulty: 'åŸºç¡€',
      estimatedTime: '1-2å‘¨',
      color: '#fa8c16'
    };
    
    const path4: LearningPath = {
      category: ProblemCategory.BINARY_TREE,
      title: 'äºŒå‰æ ‘',
      description: 'æŒæ¡æ ‘çš„éå†ã€æœç´¢ã€æ„å»ºï¼Œç†è§£äºŒå‰æœç´¢æ ‘çš„æ€§è´¨',
      icon: $r('app.media.book_icon'),
      totalProblems: 22,
      completedProblems: 0,
      difficulty: 'è¿›é˜¶',
      estimatedTime: '2-3å‘¨',
      color: '#13c2c2'
    };
    
    const path5: LearningPath = {
      category: ProblemCategory.TWO_POINTERS,
      title: 'åŒæŒ‡é’ˆæŠ€å·§',
      description: 'å­¦ä¹ å¿«æ…¢æŒ‡é’ˆã€å·¦å³æŒ‡é’ˆç­‰æŠ€å·§ï¼Œè§£å†³æ•°ç»„å’Œé“¾è¡¨é—®é¢˜',
      icon: $r('app.media.target_icon'),
      totalProblems: 15,
      completedProblems: 0,
      difficulty: 'è¿›é˜¶',
      estimatedTime: '2-3å‘¨',
      color: '#722ed1'
    };
    
    const path6: LearningPath = {
      category: ProblemCategory.DYNAMIC_PROGRAMMING,
      title: 'åŠ¨æ€è§„åˆ’',
      description: 'æŒæ¡çŠ¶æ€è½¬ç§»æ€æƒ³ï¼Œè§£å†³èƒŒåŒ…ã€è·¯å¾„ã€åºåˆ—ç­‰ç»å…¸DPé—®é¢˜',
      icon: $r('app.media.computer_icon'),
      totalProblems: 30,
      completedProblems: 0,
      difficulty: 'é«˜çº§',
      estimatedTime: '4-5å‘¨',
      color: '#eb2f96'
    };
    
    const path7: LearningPath = {
      category: ProblemCategory.BINARY_SEARCH,
      title: 'äºŒåˆ†æŸ¥æ‰¾',
      description: 'æŒæ¡äºŒåˆ†æŸ¥æ‰¾æ€æƒ³ï¼Œè§£å†³æœç´¢ã€è¾¹ç•ŒæŸ¥æ‰¾ç­‰é—®é¢˜',
      icon: $r('app.media.search_icon'),
      totalProblems: 12,
      completedProblems: 0,
      difficulty: 'è¿›é˜¶',
      estimatedTime: '1-2å‘¨',
      color: '#f5222d'
    };
    
    const path8: LearningPath = {
      category: ProblemCategory.MATH,
      title: 'æ•°å­¦ç®—æ³•',
      description: 'å­¦ä¹ æ•°è®ºã€ç»„åˆæ•°å­¦ã€æ¦‚ç‡ç­‰æ•°å­¦ç›¸å…³ç®—æ³•',
      icon: $r('app.media.computer_icon'),
      totalProblems: 18,
      completedProblems: 0,
      difficulty: 'è¿›é˜¶',
      estimatedTime: '2-3å‘¨',
      color: '#fa541c'
    };
    
    const path9: LearningPath = {
      category: ProblemCategory.STACK,
      title: 'æ ˆä¸é˜Ÿåˆ—',
      description: 'æŒæ¡æ ˆå’Œé˜Ÿåˆ—çš„åŸºæœ¬æ“ä½œï¼Œå­¦ä¹ å•è°ƒæ ˆã€ä¼˜å…ˆé˜Ÿåˆ—ç­‰é«˜çº§åº”ç”¨',
      icon: $r('app.media.book_icon'),
      totalProblems: 20,
      completedProblems: 0,
      difficulty: 'åŸºç¡€',
      estimatedTime: '2-3å‘¨',
      color: '#52c41a'
    };
    
    paths.push(path1, path2, path3, path4, path5, path6, path7, path8, path9);
    return paths;
  }

  private getDifficultyColor(difficulty: string): string {
    switch (difficulty) {
      case 'å…¥é—¨':
        return '#52c41a';
      case 'åŸºç¡€':
        return '#1890ff';
      case 'è¿›é˜¶':
        return '#fa8c16';
      case 'é«˜çº§':
        return '#f5222d';
      default:
        return '#666666';
    }
  }

  private showPathDetail(path: LearningPath): void {
    // åˆ‡æ¢åˆ°ç»ƒä¹ ä¸­å¿ƒTabï¼Œå¹¶ä¼ é€’åˆ†ç±»å‚æ•°
    const tabNavigationService = TabNavigationService.getInstance();
    tabNavigationService.switchToPracticeCenter();
    
    // ä½¿ç”¨AppStorageæ¥ä¼ é€’å‚æ•°åˆ°ç»ƒä¹ ä¸­å¿ƒé¡µé¢
    AppStorage.setOrCreate('selectedCategory', path.category);
    AppStorage.setOrCreate('selectedCategoryTitle', path.title);
  }

  private async startLearning(path: LearningPath): Promise<void> {
    try {
      // è·å–è¯¥åˆ†ç±»çš„ç¬¬ä¸€é“æœªå®Œæˆé¢˜ç›®
      const allProblems = ProblemMockData.getAllProblems();
      const problems = allProblems.filter(p => p.category === path.category);
      if (problems.length === 0) {
        console.info('No problems found for category:', path.category);
        return;
      }

      // æŸ¥æ‰¾ç¬¬ä¸€é“æœªå®Œæˆçš„é¢˜ç›®
      let targetProblem = problems[0];
      for (const problem of problems) {
        const progress = await this.userProgressDao.getUserProgress(problem.id);
        if (!progress || progress.status !== ProblemStatus.COMPLETED) {
          targetProblem = problem;
          break;
        }
      }

      // è·³è½¬åˆ°é¢˜ç›®è¯¦æƒ…é¡µé¢
      router.pushUrl({
        url: 'pages/ProblemDetailPage',
        params: {
          problemId: targetProblem.id,
          fromPath: true,
          pathCategory: path.category
        }
      }).catch((error: Error) => {
        console.error('Failed to navigate to problem detail:', error);
      });
    } catch (error) {
      console.error('Failed to start learning:', error);
    }
  }
}
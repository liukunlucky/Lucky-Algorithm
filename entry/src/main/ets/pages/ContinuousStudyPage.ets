import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';
import { UserProgressDao } from '../dao/UserProgressDao';

interface StudyDayInfo {
  date: Date;
  dayOfMonth: number;
  isStudied: boolean;
  studyCount: number;
  isToday: boolean;
  isCurrentMonth: boolean;
}

@Entry
@Component
struct ContinuousStudyPage {
  @State currentDate: Date = new Date();
  @State studyDays: StudyDayInfo[] = [];
  @State continuousDays: number = 0;
  @State totalStudyDays: number = 0;
  @State isLoading: boolean = true;
  @State currentYear: number = new Date().getFullYear();
  @State currentMonth: number = new Date().getMonth();
  @State studyDataMap: Map<string, number> = new Map(); // å­˜å‚¨å­¦ä¹ æ•°æ®
  
  private userProgressDao: UserProgressDao = new UserProgressDao();

  aboutToAppear(): void {
    this.loadStudyCalendar();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()

      if (this.isLoading) {
        this.buildLoadingState()
      } else {
        // å†…å®¹åŒºåŸŸ
        Column({ space: 16 }) {
          // ç»Ÿè®¡å¡ç‰‡
          this.buildStatsCard()

          // æœˆä»½å¯¼èˆª
          this.buildMonthNavigation()

          // æ—¥å†
          this.buildCalendar()

          // æ‰“å¡è¯´æ˜
          this.buildLegend()
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row() {
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(32)
      .backgroundColor('transparent')
      .onClick(() => {
        router.back();
      })

      Text('è¿ç»­å­¦ä¹ ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Blank().width(32)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
    .shadow({
      radius: 2,
      color: '#00000010',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  buildLoadingState() {
    Column({ space: 16 }) {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#F34F40')

      Text('æ­£åœ¨åŠ è½½å­¦ä¹ è®°å½•...')
        .fontSize(14)
        .fontColor('#666666')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildStatsCard() {
    Column({ space: 16 }) {
      Row() {
        Column({ space: 4 }) {
          Text(this.continuousDays.toString())
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#F34F40')

          Text('è¿ç»­å­¦ä¹ å¤©æ•°')
            .fontSize(14)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)

        Divider()
          .vertical(true)
          .height(40)
          .strokeWidth(1)
          .color('#E5E7EB')

        Column({ space: 4 }) {
          Text(this.totalStudyDays.toString())
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#52c41a')

          Text('ç´¯è®¡å­¦ä¹ å¤©æ•°')
            .fontSize(14)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
      }
      .width('100%')

      Text('åšæŒæ¯æ—¥å­¦ä¹ ï¼Œå…»æˆè‰¯å¥½ä¹ æƒ¯ï¼')
        .fontSize(12)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  buildMonthNavigation() {
    Row() {
      Button() {
        Image($r('app.media.icon_left_arrow'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .backgroundColor('transparent')
      .width(40)
      .height(40)
      .onClick(() => {
        this.changeMonth(-1);
      })

      Text(`${this.currentYear}å¹´${this.currentMonth + 1}æœˆ`)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button() {
        Image($r('app.media.icon_right_arrow'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .backgroundColor('transparent')
      .width(40)
      .height(40)
      .onClick(() => {
        this.changeMonth(1);
      })
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildCalendar() {
    Column({ space: 8 }) {
      // æ˜ŸæœŸæ ‡é¢˜
      Row() {
        ForEach(['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'], (dayName: string) => {
          Text(dayName)
            .fontSize(12)
            .fontColor('#999999')
            .width(40)
            .height(40)
            .textAlign(TextAlign.Center)
            .layoutWeight(1)
        })
      }
      .width('100%')

      // æ—¥å†ç½‘æ ¼
      this.buildCalendarGrid()
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  buildCalendarGrid() {
    Grid() {
      ForEach(this.studyDays, (dayInfo: StudyDayInfo, index: number) => {
        GridItem() {
          this.buildDayItem(dayInfo)
        }
      })
    }
    .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr')
    .rowsGap(8)
    .columnsGap(8)
    .width('100%')
  }

  @Builder
  buildDayItem(dayInfo: StudyDayInfo) {
    Stack() {
      Circle()
        .width(36)
        .height(36)
        .fill(this.getDayBackgroundColor(dayInfo))

      Text(dayInfo.dayOfMonth.toString())
        .fontSize(14)
        .fontColor(this.getDayTextColor(dayInfo))
        .fontWeight(dayInfo.isToday ? FontWeight.Bold : FontWeight.Normal)

      if (dayInfo.isStudied && dayInfo.studyCount > 0) {
        Circle()
          .width(6)
          .height(6)
          .fill('#52c41a')
          .position({ x: 26, y: 8 })
      }
    }
    .width(40)
    .height(40)
    .onClick(() => {
      if (dayInfo.isStudied && dayInfo.studyCount > 0) {
        this.showDayDetail(dayInfo);
      }
    })
  }

  @Builder
  buildLegend() {
    Column({ space: 12 }) {
      Text('æ‰“å¡è¯´æ˜')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      Row({ space: 20 }) {
        Row({ space: 8 }) {
          Circle()
            .width(16)
            .height(16)
            .fill('#52c41a')

          Text('å·²å­¦ä¹ ')
            .fontSize(12)
            .fontColor('#666666')
        }

        Row({ space: 8 }) {
          Circle()
            .width(16)
            .height(16)
            .fill('#F34F40')

          Text('ä»Šå¤©')
            .fontSize(12)
            .fontColor('#666666')
        }

        Row({ space: 8 }) {
          Circle()
            .width(16)
            .height(16)
            .fill('#E5E7EB')

          Text('æœªå­¦ä¹ ')
            .fontSize(12)
            .fontColor('#666666')
        }
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#00000008',
      offsetX: 0,
      offsetY: 1
    })
  }

  // åŠ è½½å­¦ä¹ æ—¥å†æ•°æ®
  private async loadStudyCalendar(): Promise<void> {
    try {
      this.isLoading = true;
      console.info('ğŸ“… å¼€å§‹åŠ è½½å­¦ä¹ æ—¥å†æ•°æ®');

      // è·å–è¿ç»­å­¦ä¹ å¤©æ•°
      this.continuousDays = await this.userProgressDao.getContinuousDays();

      // è·å–æ€»å­¦ä¹ å¤©æ•°
      this.totalStudyDays = await this.userProgressDao.getTotalStudyDays();

      // è·å–å½“å‰æœˆä»½çš„å­¦ä¹ æ•°æ®
      this.studyDataMap = await this.userProgressDao.getStudyCalendarData(this.currentYear, this.currentMonth);

      // ç”Ÿæˆå½“å‰æœˆä»½çš„æ—¥å†æ•°æ®
      this.generateCalendarData();

      console.info('âœ… å­¦ä¹ æ—¥å†æ•°æ®åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('âŒ åŠ è½½å­¦ä¹ æ—¥å†æ•°æ®å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  // ç”Ÿæˆæ—¥å†æ•°æ®
  private generateCalendarData(): void {
    const year = this.currentYear;
    const month = this.currentMonth;
    
    // ä½¿ç”¨æœ¬åœ°æ—¶é—´ï¼Œé¿å…æ—¶åŒºé—®é¢˜
    const today = new Date();
    today.setHours(0, 0, 0, 0); // é‡ç½®æ—¶é—´ä¸ºå½“å¤©0ç‚¹
    
    console.log(`ç”Ÿæˆæ—¥å†æ•°æ®: ${year}å¹´${month + 1}æœˆ, ä»Šå¤©: ${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`);
    
    // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // è·å–ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=æ˜ŸæœŸæ—¥ï¼‰
    const firstDayOfWeek = firstDay.getDay();
    
    // è·å–å½“æœˆå¤©æ•°
    const daysInMonth = lastDay.getDate();

    const studyDays: StudyDayInfo[] = [];

    // æ·»åŠ ä¸Šä¸ªæœˆçš„æ—¥æœŸå¡«å……
    const prevMonth = new Date(year, month - 1, 0);
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
      const date = new Date(year, month - 1, prevMonth.getDate() - i);
      date.setHours(0, 0, 0, 0); // ç¡®ä¿æ—¶é—´ä¸º0ç‚¹
      studyDays.push({
        date: date,
        dayOfMonth: date.getDate(),
        isStudied: false,
        studyCount: 0,
        isToday: false,
        isCurrentMonth: false
      });
    }

    // æ·»åŠ å½“æœˆçš„æ—¥æœŸ
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      date.setHours(0, 0, 0, 0); // ç¡®ä¿æ—¶é—´ä¸º0ç‚¹
      
      const isToday = this.isSameDay(date, today);
      const isStudied = this.checkIfStudiedOnDate(date);
      const studyCount = this.getStudyCountOnDate(date);

      console.log(`æ—¥æœŸ ${year}-${month + 1}-${day}: isToday=${isToday}, isStudied=${isStudied}, studyCount=${studyCount}`);

      studyDays.push({
        date: date,
        dayOfMonth: day,
        isStudied: isStudied,
        studyCount: studyCount,
        isToday: isToday,
        isCurrentMonth: true
      });
    }

    // æ·»åŠ ä¸‹ä¸ªæœˆçš„æ—¥æœŸå¡«å……ï¼ˆç¡®ä¿6è¡Œ42ä¸ªæ ¼å­ï¼‰
    const totalCells = 42;
    const remainingCells = totalCells - studyDays.length;
    for (let day = 1; day <= remainingCells; day++) {
      const date = new Date(year, month + 1, day);
      date.setHours(0, 0, 0, 0); // ç¡®ä¿æ—¶é—´ä¸º0ç‚¹
      studyDays.push({
        date: date,
        dayOfMonth: day,
        isStudied: false,
        studyCount: 0,
        isToday: false,
        isCurrentMonth: false
      });
    }

    this.studyDays = studyDays;
    console.log('lucky å­¦ä¹ æ—¥å†æ•°æ®æ˜¯ ' + JSON.stringify(studyDays))
  }

  // åˆ‡æ¢æœˆä»½
  private async changeMonth(delta: number): Promise<void> {
    const newDate = new Date(this.currentYear, this.currentMonth + delta);
    this.currentYear = newDate.getFullYear();
    this.currentMonth = newDate.getMonth();
    
    // é‡æ–°åŠ è½½è¯¥æœˆçš„æ•°æ®
    this.studyDataMap = await this.userProgressDao.getStudyCalendarData(this.currentYear, this.currentMonth);
    this.generateCalendarData();
  }

  // æ£€æŸ¥æ—¥æœŸæ˜¯å¦ç›¸åŒ
  private isSameDay(date1: Date, date2: Date): boolean {
    // ç¡®ä¿ä¸¤ä¸ªæ—¥æœŸéƒ½é‡ç½®ä¸º0ç‚¹è¿›è¡Œæ¯”è¾ƒ
    const d1 = new Date(date1);
    d1.setHours(0, 0, 0, 0);
    const d2 = new Date(date2);
    d2.setHours(0, 0, 0, 0);
    
    const isSame = d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
    
    console.log(`æ¯”è¾ƒæ—¥æœŸ: ${d1.getFullYear()}-${d1.getMonth() + 1}-${d1.getDate()} vs ${d2.getFullYear()}-${d2.getMonth() + 1}-${d2.getDate()}, ç»“æœ: ${isSame}`);
    
    return isSame;
  }

  // æ£€æŸ¥æŒ‡å®šæ—¥æœŸæ˜¯å¦å­¦ä¹ äº†
  private checkIfStudiedOnDate(date: Date): boolean {
    // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ ¼å¼ï¼Œé¿å…æ—¶åŒºé—®é¢˜
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`; // YYYY-MM-DDæ ¼å¼
    
    const hasData = this.studyDataMap.has(dateStr);
    const count = this.studyDataMap.get(dateStr) || 0;
    const isStudied = hasData && count > 0;
    
    console.log(`æ£€æŸ¥å­¦ä¹ çŠ¶æ€ ${dateStr}: hasData=${hasData}, count=${count}, isStudied=${isStudied}`);
    
    return isStudied;
  }

  // è·å–æŒ‡å®šæ—¥æœŸçš„å­¦ä¹ é¢˜ç›®æ•°
  private getStudyCountOnDate(date: Date): number {
    // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ ¼å¼ï¼Œé¿å…æ—¶åŒºé—®é¢˜
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`; // YYYY-MM-DDæ ¼å¼
    
    return this.studyDataMap.get(dateStr) || 0;
  }

  // è·å–æ—¥æœŸèƒŒæ™¯é¢œè‰²
  private getDayBackgroundColor(dayInfo: StudyDayInfo): string {
    if (!dayInfo.isCurrentMonth) {
      return 'transparent';
    }
    
    if (dayInfo.isToday) {
      return '#F34F40';
    }
    
    if (dayInfo.isStudied) {
      return '#52c41a';
    }
    
    return '#E5E7EB';
  }

  // è·å–æ—¥æœŸæ–‡å­—é¢œè‰²
  private getDayTextColor(dayInfo: StudyDayInfo): string {
    if (!dayInfo.isCurrentMonth) {
      return '#D1D5DB';
    }
    
    if (dayInfo.isToday || dayInfo.isStudied) {
      return '#ffffff';
    }
    
    return '#374151';
  }

  // æ˜¾ç¤ºæ—¥æœŸè¯¦æƒ…
  private showDayDetail(dayInfo: StudyDayInfo): void {
    const dateStr = `${dayInfo.date.getMonth() + 1}æœˆ${dayInfo.date.getDate()}æ—¥`;
    promptAction.showToast({
      message: `${dateStr} å®Œæˆäº† ${dayInfo.studyCount} é“é¢˜ç›®`,
      duration: 2000
    });
  }
}
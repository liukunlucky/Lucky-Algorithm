import { StudyDiaryModel, DiaryMood } from '../model/StudyDiaryModel';
import { StudyDiaryDao } from '../dao/StudyDiaryDao';
import router from '@ohos.router';

interface MoodOption {
  mood: DiaryMood;
  emoji: string;
  text: string;
}

@Entry
@Component
struct StudyDiaryPage {
  @State diaries: StudyDiaryModel[] = [];
  @State isLoading: boolean = true;
  @State showAddDialog: boolean = false;
  @State showEditDialog: boolean = false;
  @State showDetailDialog: boolean = false;
  @State currentEditDiary: StudyDiaryModel | null = null;
  @State currentDetailDiary: StudyDiaryModel | null = null;
  @State searchKeyword: string = '';
  
  // è¡¨å•æ•°æ®
  @State formTitle: string = '';
  @State formContent: string = '';
  @State formMood: DiaryMood = DiaryMood.NORMAL;
  @State formStudyDuration: string = '';
  @State formProblemsSolved: string = '';
  @State formTags: string = '';

  private studyDiaryDao: StudyDiaryDao = new StudyDiaryDao();

  async aboutToAppear() {
    await this.loadDiaries();
  }

  async onPageShow() {
    await this.loadDiaries();
  }

  async loadDiaries() {
    try {
      this.isLoading = true;
      if (this.searchKeyword.trim()) {
        this.diaries = await this.studyDiaryDao.searchDiaries(this.searchKeyword.trim());
      } else {
        this.diaries = await this.studyDiaryDao.getAllDiaries();
      }
      console.info('åŠ è½½å­¦ä¹ æ—¥è®°æˆåŠŸï¼Œæ•°é‡:', this.diaries.length);
    } catch (error) {
      console.error('åŠ è½½å­¦ä¹ æ—¥è®°å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()

      // æœç´¢æ 
      this.buildSearchBar()

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // æ—¥è®°åˆ—è¡¨
        this.buildDiariesList()
      }

      // æ·»åŠ æ—¥è®°å¯¹è¯æ¡†
      if (this.showAddDialog) {
        this.buildAddDiaryDialog()
      }

      // ç¼–è¾‘æ—¥è®°å¯¹è¯æ¡†
      if (this.showEditDialog) {
        this.buildEditDiaryDialog()
      }

      // æ—¥è®°è¯¦æƒ…å¯¹è¯æ¡†
      if (this.showDetailDialog) {
        this.buildDetailDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row() {
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back();
      })

      Text('å­¦ä¹ æ—¥è®°')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button() {
        Image($r('app.media.icon_add'))
          .width(36)
          .height(36)
          .fillColor('#FF6B35')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.pushUrl({
          url: 'pages/AddEditStudyDiaryPage'
        }).catch((error: Error) => {
          console.error('è·³è½¬åˆ°æ·»åŠ æ—¥è®°é¡µé¢å¤±è´¥:', error);
        });
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .justifyContent(FlexAlign.SpaceBetween)
  }

  @Builder
  buildSearchBar() {
    Row({ space: 12 }) {
      TextInput({ placeholder: 'æœç´¢æ—¥è®°æ ‡é¢˜ã€å†…å®¹æˆ–æ ‡ç­¾...' })
        .fontSize(14)
        .backgroundColor('#F8F9FA')
        .borderRadius(20)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .layoutWeight(1)
        .onChange((value: string) => {
          this.searchKeyword = value;
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
  }

  @Builder
  buildDiariesList() {
    if (this.diaries.length === 0) {
      Column() {
        Image($r('app.media.icon_empty'))
          .width(173)
          .height(128)

        Text(this.searchKeyword.trim() ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ—¥è®°' : 'è¿˜æ²¡æœ‰å­¦ä¹ æ—¥è®°')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ top: 16 })
        Text(this.searchKeyword.trim() ? 'è¯•è¯•å…¶ä»–å…³é”®è¯' : 'ç‚¹å‡»å³ä¸Šè§’è®°å½•ä½ çš„å­¦ä¹ å¿ƒå¾—å§')
          .fontSize(14)
          .fontColor('#CCCCCC')
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .height('70%')
    } else {
      Column() { List({ space: 12 }) {
        ForEach(this.diaries, (diary: StudyDiaryModel) => {
          this.buildDiaryCard(diary)
        }, (diary: StudyDiaryModel) => diary.id.toString())
      }
      .padding(16)
      .width('100%').height('100%')}.layoutWeight(1)

    }
  }

  @Builder
  buildDiaryCard(diary: StudyDiaryModel) {
    Column() {
      // æ—¥è®°æ ‡é¢˜å’Œå¿ƒæƒ…
      Row() {
        Column({ space: 4 }) {
          Text(diary.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Row({ space: 8 }) {
            Text(diary.getFormattedDate())
              .fontSize(12)
              .fontColor('#999999')

            Text(diary.getFormattedTime())
              .fontSize(12)
              .fontColor('#999999')
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Row({ space: 8 }) {
          Text(diary.getMoodEmoji())
            .fontSize(20)

          Text(diary.getMoodDisplayText())
            .fontSize(12)
            .fontColor(diary.getMoodColor())
        }
      }
      .width('100%')

      Row() {
        // æ—¥è®°å†…å®¹é¢„è§ˆ
        Text(diary.content)
          .fontSize(14)
          .fontColor('#666666')
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }.width('100%')


      // å­¦ä¹ æ•°æ®
      Row({ space: 16 }) {
        if (diary.studyDuration > 0) {
          Row({ space: 4 }) {
            Text('â±ï¸')
              .fontSize(14)
            Text(diary.getStudyDurationText())
              .fontSize(12)
              .fontColor('#666666')
          }
        }

        if (diary.problemsSolved > 0) {
          Row({ space: 4 }) {
            Text('âœ…')
              .fontSize(14)
            Text(`${diary.problemsSolved}é¢˜`)
              .fontSize(12)
              .fontColor('#666666')
          }
        }
      }
      .width('100%')

      // æ ‡ç­¾
      if (diary.tags) {
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(diary.getTagsArray(), (tag: string) => {
            Text(`#${tag}`)
              .fontSize(12)
              .fontColor('#F34F40')
              .backgroundColor('#FFF5F5')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
          }, (tag: string) => tag)
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .onClick(() => {
      router.pushUrl({
        url: 'pages/AddEditStudyDiaryPage',
        params: { diary: diary }
      }).catch((error: Error) => {
        console.error('è·³è½¬åˆ°ç¼–è¾‘æ—¥è®°é¡µé¢å¤±è´¥:', error);
      });
    })
  }

  @Builder
  buildAddDiaryDialog() {
    Column() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#00000080')
        .onClick(() => {
          this.hideAddDiaryDialog();
        })

      // å¯¹è¯æ¡†å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          Text('å†™å­¦ä¹ æ—¥è®°')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')

          this.buildDiaryForm()

          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#666666')
              .backgroundColor('#F0F0F0')
              .borderRadius(8)
              .layoutWeight(1)
              .onClick(() => {
                this.hideAddDiaryDialog();
              })

            Button('ä¿å­˜')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#F34F40')
              .borderRadius(8)
              .layoutWeight(1)
              .onClick(() => {
                this.addDiary();
              })
          }
          .width('100%')
        }
        .width('90%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
      }
      .width('90%')
      .height('80%')
      .position({ x: '5%', y: '10%' })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(1000)
    }

  @Builder
  buildEditDiaryDialog() {
    Column() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#00000080')
        .onClick(() => {
          this.hideEditDiaryDialog();
        })

      // å¯¹è¯æ¡†å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          Text('ç¼–è¾‘å­¦ä¹ æ—¥è®°')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')

          this.buildDiaryForm()

          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#666666')
              .backgroundColor('#F0F0F0')
              .borderRadius(8)
              .layoutWeight(1)
              .onClick(() => {
                this.hideEditDiaryDialog();
              })

            Button('ä¿å­˜')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#F34F40')
              .borderRadius(8)
              .layoutWeight(1)
              .onClick(() => {
                this.updateDiary();
              })
          }
          .width('100%')
        }
        .width('90%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
      }
      .width('90%')
      .height('80%')
      .position({ x: '5%', y: '10%' })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  @Builder
  buildDetailDialog() {
    if (!this.currentDetailDiary) {
      Column()
    } else {

      Column() {
        // é®ç½©å±‚
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#00000080')
          .onClick(() => {
            this.hideDetailDialog();
          })

        // å¯¹è¯æ¡†å†…å®¹
        Scroll() {
          Column({ space: 20 }) {
            // æ ‡é¢˜å’Œå¿ƒæƒ…
            Row() {
              Text(this.currentDetailDiary.title)
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .layoutWeight(1)

              Row({ space: 8 }) {
                Text(this.currentDetailDiary.getMoodEmoji())
                  .fontSize(24)
                Text(this.currentDetailDiary.getMoodDisplayText())
                  .fontSize(14)
                  .fontColor(this.currentDetailDiary.getMoodColor())
              }
            }
            .width('100%')

            // æ—¥æœŸæ—¶é—´
            Text(`${this.currentDetailDiary.getFormattedDate()} ${this.currentDetailDiary.getFormattedTime()}`)
              .fontSize(14)
              .fontColor('#999999')

            // å†…å®¹
            Text(this.currentDetailDiary.content)
              .fontSize(16)
              .fontColor('#333333')
              .lineHeight(24)

            // å­¦ä¹ æ•°æ®
            if (this.currentDetailDiary.studyDuration > 0 || this.currentDetailDiary.problemsSolved > 0) {
              Column({ space: 8 }) {
                Text('å­¦ä¹ æ•°æ®')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')

                Row({ space: 16 }) {
                  if (this.currentDetailDiary.studyDuration > 0) {
                    Column({ space: 4 }) {
                      Text('â±ï¸')
                        .fontSize(20)
                      Text(this.currentDetailDiary.getStudyDurationText())
                        .fontSize(14)
                        .fontColor('#666666')
                    }
                  }

                  if (this.currentDetailDiary.problemsSolved > 0) {
                    Column({ space: 4 }) {
                      Text('âœ…')
                        .fontSize(20)
                      Text(`${this.currentDetailDiary.problemsSolved}é¢˜`)
                        .fontSize(14)
                        .fontColor('#666666')
                    }
                  }
                }
              }
              .alignItems(HorizontalAlign.Start)
            }

            // æ ‡ç­¾
            if (this.currentDetailDiary.tags) {
              Column({ space: 8 }) {
                Text('æ ‡ç­¾')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                  .alignSelf(ItemAlign.Start)

                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.currentDetailDiary.getTagsArray(), (tag: string) => {
                    Text(`#${tag}`)
                      .fontSize(14)
                      .fontColor('#F34F40')
                      .backgroundColor('#FFF5F5')
                      .padding({
                        left: 12,
                        right: 12,
                        top: 6,
                        bottom: 6
                      })
                      .borderRadius(16)
                  }, (tag: string) => tag)
                }
              }
              .alignItems(HorizontalAlign.Start)
            }

            Button('å…³é—­')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#F34F40')
              .borderRadius(8)
              .width('100%')
              .onClick(() => {
                this.hideDetailDialog();
              })
          }
          .width('90%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
        }
        .width('90%')
        .height('80%')
        .position({ x: '5%', y: '10%' })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(1000)
    }
  }

  @Builder
  buildDiaryForm() {
    Column({ space: 16 }) {
      // æ—¥è®°æ ‡é¢˜
      Column({ space: 8 }) {
        Text('æ ‡é¢˜')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)

        TextInput({ placeholder: 'è¯·è¾“å…¥æ—¥è®°æ ‡é¢˜' })
          .fontSize(14)
          .backgroundColor('#F8F9FA')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 10, bottom: 10 })
          .onChange((value: string) => {
            this.formTitle = value;
          })
      }

      // å¿ƒæƒ…é€‰æ‹©
      Column({ space: 8 }) {
        Text('ä»Šæ—¥å¿ƒæƒ…')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)

        Row({ space: 12 }) {
          ForEach([
            { mood: DiaryMood.EXCELLENT, emoji: 'ğŸ˜„', text: 'éå¸¸å¥½' },
            { mood: DiaryMood.GOOD, emoji: 'ğŸ˜Š', text: 'è‰¯å¥½' },
            { mood: DiaryMood.NORMAL, emoji: 'ğŸ˜', text: 'ä¸€èˆ¬' },
            { mood: DiaryMood.BAD, emoji: 'ğŸ˜”', text: 'ä¸å¥½' },
            { mood: DiaryMood.TERRIBLE, emoji: 'ğŸ˜¢', text: 'å¾ˆå·®' }
          ], (item: MoodOption) => {
            Column({ space: 4 }) {
              Text(item.emoji)
                .fontSize(24)
              Text(item.text)
                .fontSize(12)
                .fontColor(this.formMood === item.mood ? '#F34F40' : '#999999')
            }
            .padding(8)
            .backgroundColor(this.formMood === item.mood ? '#FFF5F5' : '#F8F9FA')
            .borderRadius(8)
            .onClick(() => {
              this.formMood = item.mood;
            })
          }, (item: MoodOption) => item.mood)
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
      }

      // å­¦ä¹ æ—¶é•¿
      Row({ space: 12 }) {
        Column({ space: 8 }) {
          Text('å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰')
            .fontSize(14)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)

          TextInput({ placeholder: '0' })
            .fontSize(14)
            .backgroundColor('#F8F9FA')
            .borderRadius(8)
            .padding({ left: 12, right: 12, top: 10, bottom: 10 })
            .type(InputType.Number)
            .onChange((value: string) => {
              this.formStudyDuration = value;
            })
        }
        .layoutWeight(1)

        Column({ space: 8 }) {
          Text('è§£å†³é¢˜ç›®æ•°')
            .fontSize(14)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)

          TextInput({ placeholder: '0' })
            .fontSize(14)
            .backgroundColor('#F8F9FA')
            .borderRadius(8)
            .padding({ left: 12, right: 12, top: 10, bottom: 10 })
            .type(InputType.Number)
            .onChange((value: string) => {
              this.formProblemsSolved = value;
            })
        }
        .layoutWeight(1)
      }

      // æ—¥è®°å†…å®¹
      Column({ space: 8 }) {
        Text('å­¦ä¹ å¿ƒå¾—')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)

        TextArea({ placeholder: 'è®°å½•ä»Šå¤©çš„å­¦ä¹ å¿ƒå¾—ã€é‡åˆ°çš„é—®é¢˜ã€æ”¶è·ç­‰...' })
          .fontSize(14)
          .backgroundColor('#F8F9FA')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 10, bottom: 10 })
          .height(120)
          .onChange((value: string) => {
            this.formContent = value;
          })
      }

      // æ ‡ç­¾
      Column({ space: 8 }) {
        Text('æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)

        TextInput({ placeholder: 'ä¾‹å¦‚ï¼šç®—æ³•,æ•°æ®ç»“æ„,åŠ¨æ€è§„åˆ’' })
          .fontSize(14)
          .backgroundColor('#F8F9FA')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 10, bottom: 10 })
          .onChange((value: string) => {
            this.formTags = value;
          })
      }
    }
  }

  private showAddDiaryDialog(): void {
    this.clearForm();
    this.showAddDialog = true;
  }

  private hideAddDiaryDialog(): void {
    this.showAddDialog = false;
  }

  private showEditDiaryDialog(diary?: StudyDiaryModel): void {
    if (diary) {
      this.currentEditDiary = diary;
      this.formTitle = diary.title;
      this.formContent = diary.content;
      this.formMood = diary.mood;
      this.formStudyDuration = diary.studyDuration.toString();
      this.formProblemsSolved = diary.problemsSolved.toString();
      this.formTags = diary.tags;
    }
    this.showEditDialog = true;
  }

  private hideEditDiaryDialog(): void {
    this.showEditDialog = false;
    this.currentEditDiary = null;
  }

  private showDetailDiaryDialog(diary: StudyDiaryModel): void {
    this.currentDetailDiary = diary;
    this.showDetailDialog = true;
  }

  private hideDetailDialog(): void {
    this.showDetailDialog = false;
    this.currentDetailDiary = null;
  }

  private clearForm(): void {
    this.formTitle = '';
    this.formContent = '';
    this.formMood = DiaryMood.NORMAL;
    this.formStudyDuration = '';
    this.formProblemsSolved = '';
    this.formTags = '';
  }

  private async addDiary(): Promise<void> {
    if (!this.formTitle.trim() || !this.formContent.trim()) {
      console.error('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
      return;
    }

    try {
      const diary = new StudyDiaryModel();
      diary.title = this.formTitle.trim();
      diary.content = this.formContent.trim();
      diary.mood = this.formMood;
      diary.studyDuration = parseInt(this.formStudyDuration) || 0;
      diary.problemsSolved = parseInt(this.formProblemsSolved) || 0;
      diary.tags = this.formTags.trim();

      await this.studyDiaryDao.addDiary(diary);
      await this.loadDiaries();
      this.hideAddDiaryDialog();
      console.info('æ·»åŠ å­¦ä¹ æ—¥è®°æˆåŠŸ');
    } catch (error) {
      console.error('æ·»åŠ å­¦ä¹ æ—¥è®°å¤±è´¥:', error);
    }
  }

  private async updateDiary(): Promise<void> {
    if (!this.currentEditDiary || !this.formTitle.trim() || !this.formContent.trim()) {
      console.error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      return;
    }

    try {
      this.currentEditDiary.title = this.formTitle.trim();
      this.currentEditDiary.content = this.formContent.trim();
      this.currentEditDiary.mood = this.formMood;
      this.currentEditDiary.studyDuration = parseInt(this.formStudyDuration) || 0;
      this.currentEditDiary.problemsSolved = parseInt(this.formProblemsSolved) || 0;
      this.currentEditDiary.tags = this.formTags.trim();

      await this.studyDiaryDao.updateDiary(this.currentEditDiary);
      await this.loadDiaries();
      this.hideEditDiaryDialog();
      console.info('æ›´æ–°å­¦ä¹ æ—¥è®°æˆåŠŸ');
    } catch (error) {
      console.error('æ›´æ–°å­¦ä¹ æ—¥è®°å¤±è´¥:', error);
    }
  }

  private async deleteDiary(id: number): Promise<void> {
    try {
      await this.studyDiaryDao.deleteDiary(id);
      await this.loadDiaries();
      console.info('åˆ é™¤å­¦ä¹ æ—¥è®°æˆåŠŸ');
    } catch (error) {
      console.error('åˆ é™¤å­¦ä¹ æ—¥è®°å¤±è´¥:', error);
    }
  }
}
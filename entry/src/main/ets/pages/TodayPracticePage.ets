import { ProblemModel, ProblemDifficulty, ProblemCategory } from '../model/ProblemModel';
import { UserProgressModel, ProblemStatus } from '../model/UserProgressModel';
import { ProblemMockData } from '../mock/ProblemMockData';
import { UserProgressDao } from '../dao/UserProgressDao';
import { TabNavigationService } from '../service/TabNavigationService';
import router from '@ohos.router';

@Component
export struct TodayPracticePage {
  @State dailyProblem: ProblemModel | null = null;
  @State reviewProblem: ProblemModel | null = null;
  @State continuousDays: number = 0;
  @State totalSolved: number = 0;
  @State todayCompleted: number = 0;
  @State isDailyProblemCompleted: boolean = false;
  @StorageLink('refreshTodayPage') @Watch('onRefreshTrigger') refreshTrigger: number = 0;

  // ä½¿ç”¨mockæ•°æ®ï¼Œä¸å†éœ€è¦æ•°æ®åº“å®ä¾‹
  private userProgressDao: UserProgressDao = new UserProgressDao();

  async aboutToAppear() {
    this.loadTodayData();
  }

  /**
   * ç›‘å¬é¡µé¢åˆ·æ–°è§¦å‘å™¨
   */
  onRefreshTrigger() {
    if (this.refreshTrigger > 0) {
      console.info('é¦–é¡µæ•°æ®åˆ·æ–°è§¦å‘');
      this.loadTodayData();
      // æ¸…é™¤è§¦å‘å™¨
      AppStorage.setOrCreate('refreshTodayPage', 0);
    }
  }

  build() {
    Scroll() {
      Column({ space: 20 }) {
        // é¡¶éƒ¨æ¨ªå¹…
        this.buildHeader()

        // æ¯æ—¥ä¸€é¢˜å¡ç‰‡
        this.buildDailyProblemCard()

        // éšæœºå¤ä¹ å¡ç‰‡
        this.buildReviewCard()

        // å­¦ä¹ çŠ¶æ€å¡ç‰‡
        this.buildStudyStatsCard()

        // å¿«æ·å…¥å£
        this.buildQuickActions()

        // åº•éƒ¨ç•™ç™½ï¼Œç¡®ä¿æœ€åä¸€ä¸ªå…ƒç´ ä¸ä¼šè¢«é®æŒ¡
        Column()
          .height(30)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 16 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Auto)
    .edgeEffect(EdgeEffect.Spring)
  }

  @Builder
  buildHeader() {
    Column({ space: 8 }) {
      Text(this.getCurrentDateText())
        .fontSize(16)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)

      Row({ space: 8 }) {
        Text('å¼€å¯ä»Šæ—¥çš„ç»ƒä¹ å§')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
      }
      .justifyContent(FlexAlign.Center)
      .width('100%')
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .padding({ top: 20, bottom: 20 })
  }

  @Builder
  buildDailyProblemCard() {
    Column({ space: 12 }) {
      Row() {
        Row({ space: 8 }) {
          Text('æ¯æ—¥ä¸€é¢˜')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }

        Blank()

        Text('æ¨è')
          .fontSize(12)
          .fontColor('#ffffff')
          .backgroundColor('#ff6b35')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(10)
      }
      .width('100%')

      if (this.dailyProblem) {
        Column({ space: 12 }) {
          // é¢˜ç›®æ ‡é¢˜åŒºåŸŸ
          Column({ space: 8 }) {
            Text(this.dailyProblem.title)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .lineHeight(22)

            // æ ‡ç­¾åŒºåŸŸ - å¢å¼ºè§†è§‰ä¸€ä½“æ€§
            Row({ space: 8 }) {
              Text(this.dailyProblem.getDifficultyText())
                .fontSize(12)
                .fontColor('#ffffff')
                .backgroundColor(this.dailyProblem.getDifficultyColor())
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(6)

              Text(this.dailyProblem.getCategoryText())
                .fontSize(12)
                .fontColor('#FFFFFF')
                .backgroundColor('#787408')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(6)
            }
            .justifyContent(FlexAlign.Start)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

          if (this.isDailyProblemCompleted) {
            // å·²å®ŒæˆçŠ¶æ€çš„UI
            Row({ space: 8 }) {
              Image($r('app.media.icon_check'))
                .width(16)
                .height(16)
                .fillColor('#52c41a')

              Text('ä»Šæ—¥å·²å®Œæˆ')
                .fontSize(14)
                .fontColor('#52c41a')
                .fontWeight(FontWeight.Medium)
            }
            .justifyContent(FlexAlign.Center)
            .width('100%')
            .height(40)
            .backgroundColor('#f6ffed')
            .borderRadius(8)
            .border({ width: 1, color: '#b7eb8f' })
          }
        }
        .alignItems(HorizontalAlign.Start)
      } else {
        Text('æ­£åœ¨åŠ è½½ä»Šæ—¥é¢˜ç›®...')
          .fontSize(14)
          .fontColor('#999999')
          .textAlign(TextAlign.Center)
          .width('100%')
          .height(80)
      }
    }
      .width('100%')
      .padding(16)
      .backgroundColor('#ffffff')
      .borderRadius(12)
      .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
      .onClick(() => {
        if (this.dailyProblem) {
          this.navigateToDailyProblem(this.dailyProblem.id);
        }
      })
    }

  @Builder
  buildReviewCard() {
    Column({ space: 12 }) {
      Row() {
        Row({ space: 8 }) {
          Text('éšæœºå¤ä¹ ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }

        Blank()

        if (this.reviewProblem) {
          Text('æ¥è‡ªé”™é¢˜æœ¬')
            .fontSize(12)
            .fontColor('#ffffff')
            .backgroundColor('#ff6b35')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(10)
        }
      }
      .width('100%')

      if (this.reviewProblem) {
        Column({ space: 12 }) {
          // é¢˜ç›®æ ‡é¢˜åŒºåŸŸ
          Column({ space: 8 }) {
            Text(this.reviewProblem.title)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .lineHeight(22)

            // æ ‡ç­¾åŒºåŸŸ - å¢å¼ºè§†è§‰ä¸€ä½“æ€§
            Row({ space: 8 }) {
              Text(this.reviewProblem.getDifficultyText())
                .fontSize(12)
                .fontColor('#ffffff')
                .backgroundColor(this.reviewProblem.getDifficultyColor())
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(6)

              Text(this.reviewProblem.getCategoryText())
                .fontSize(12)
                .fontColor('#FFFFFF')
                .backgroundColor('#787408')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(6)
            }
            .justifyContent(FlexAlign.Start)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

        }    
        .alignItems(HorizontalAlign.Start)
      } else {
        Column({ space: 8 }) {
          Text('æš‚æ— éœ€è¦å¤ä¹ çš„é¢˜ç›®')
            .fontSize(14)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)

          Text('å®Œæˆæ›´å¤šç»ƒä¹ åä¼šæœ‰å¤ä¹ æ¨è')
            .fontSize(12)
            .fontColor('#cccccc')
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .height(80)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
    .onClick(() => {
      if (this.reviewProblem) {
        this.navigateToProblemDetail(this.reviewProblem.id);
      }
    })
  }

  @Builder
  buildStudyStatsCard() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('å­¦ä¹ çŠ¶æ€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .alignSelf(ItemAlign.Start)

      Row({ space: 16 }) {
        this.buildContinuousDayStatItem('è¿ç»­å­¦ä¹ ', '#ff6b35')
        this.buildTotalSoledStatItem('æ€»æ”»å…‹é¢˜æ•°', '#1890ff')
        this.buildTodayCompletedStatItem('ä»Šæ—¥å®Œæˆ', '#52c41a')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
    .onClick(() => {
      // è·³è½¬åˆ°ç»Ÿè®¡é¡µé¢
      console.info('Navigate to statistics page');
    })
  }

  @Builder
  buildContinuousDayStatItem(title: string, color: string) {
    Column({ space: 4 }) {
      Text(`${this.continuousDays}å¤©`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      this.navigateToPage('pages/ContinuousStudyPage');
    })
  }

  @Builder
  buildTotalSoledStatItem(title: string, color: string) {
    Column({ space: 4 }) {
      Text(`${this.totalSolved}é¢˜`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      this.navigateToPage('pages/TotalSolvedPage');
    })
  }

  @Builder
  buildTodayCompletedStatItem(title: string, color: string) {
    Column({ space: 4 }) {
      Text(`${this.todayCompleted}é¢˜`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      this.navigateToPage('pages/TodayCompletedPage');
    })
  }

  @Builder
  buildQuickActions() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('å¿«æ·å…¥å£')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .alignSelf(ItemAlign.Start)

      // ç¬¬ä¸€è¡Œ
      Row({ space: 16 }) {
        this.buildQuickActionItem($r('app.media.icon_like'), 'æ”¶è—å¤¹', () => {
          this.navigateToPage('pages/FavoritesPage');
        })

        this.buildQuickActionItem($r('app.media.icon_error'), 'é”™é¢˜æœ¬', () => {
          this.navigateToPage('pages/WrongProblemsPage');
        })

        this.buildQuickActionItem($r('app.media.icon_note'), 'å­¦ä¹ ç¬”è®°', () => {
          this.navigateToPage('pages/StudyNotesPage');
        })

        this.buildQuickActionItem($r('app.media.icon_exam'), 'æ¨¡æ‹Ÿè€ƒè¯•', () => {
          console.info('ç‚¹å‡»æ¨¡æ‹Ÿè€ƒè¯•');
          const tabNavigationService = TabNavigationService.getInstance();
          tabNavigationService.switchToExam();
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)

      // ç¬¬äºŒè¡Œ
      Row({ space: 16 }) {
        this.buildQuickActionItem($r('app.media.icon_tj'), 'æ•°æ®ç»Ÿè®¡', () => {
          this.navigateToPage('pages/StatisticsPage');
        })

        // å ä½ç¬¦ï¼Œä¿æŒå¯¹é½
        Column()
          .width(60)
          .height(60)

        Column()
          .width(60)
          .height(60)

        Column()
          .width(60)
          .height(60)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildQuickActionItem(iconResource: Resource, title: string, onClick: () => void) {
    Column({ space: 8 }) {
      Image(iconResource)
        .width(24)
        .height(24)
        .fillColor('#666666')

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .width(60)
    .height(60)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 2, color: '#00000008', offsetX: 0, offsetY: 1 })
    .onClick(onClick)
  }

  private getCurrentDateText(): string {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const weekday = weekdays[now.getDay()];

    return `${year}å¹´${month}æœˆ${day}æ—¥ ${weekday}`;
  }

  private async loadTodayData(): Promise<void> {
    try {
      console.info('å¼€å§‹åŠ è½½é¦–é¡µæ•°æ®');
      // åŠ è½½æ¯æ—¥é¢˜ç›®
      await this.loadDailyProblem();

      // åŠ è½½å¤ä¹ é¢˜ç›®
      await this.loadReviewProblem();

      // åŠ è½½å­¦ä¹ ç»Ÿè®¡
      await this.loadStudyStats();

      console.info('é¦–é¡µæ•°æ®åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('Failed to load today data:', error);
    }
  }

  private async loadDailyProblem(): Promise<void> {
    try {
      // è·å–æ‰€æœ‰å¯ç”¨çš„é¢˜ç›®
      const allProblems = ProblemMockData.getAllProblems();
      if (allProblems.length === 0) {
        this.dailyProblem = this.createDefaultProblem();
        return;
      }

      // æ ¹æ®æ—¥æœŸç”Ÿæˆæ¯æ—¥é¢˜ç›®ç´¢å¼•ï¼ˆä½¿ç”¨å®é™…é¢˜ç›®æ•°é‡ï¼‰
      const today = new Date();
      const dayOfYear = Math.floor((today.getTime() - new Date(today.getFullYear(), 0, 0).getTime()) / 86400000);
      const problemIndex = dayOfYear % allProblems.length;

      this.dailyProblem = allProblems[problemIndex];

      // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°é¢˜ç›®ï¼Œä½¿ç”¨ç¬¬ä¸€é¢˜ä½œä¸ºé»˜è®¤
      if (!this.dailyProblem) {
        this.dailyProblem = allProblems[0];
      }

      // æ£€æŸ¥æ¯æ—¥é¢˜ç›®æ˜¯å¦å·²å®Œæˆ
      if (this.dailyProblem) {
        await this.checkDailyProblemStatus();
      }
    } catch (error) {
      console.error('Failed to load daily problem:', error);
      // åˆ›å»ºä¸€ä¸ªé»˜è®¤é¢˜ç›®
      this.dailyProblem = this.createDefaultProblem();
    }
  }

  // æ£€æŸ¥æ¯æ—¥é¢˜ç›®å®ŒæˆçŠ¶æ€
  private async checkDailyProblemStatus(): Promise<void> {
    if (!this.dailyProblem) return;

    try {
      const progress = await this.userProgressDao.getUserProgress(this.dailyProblem.id);
      // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»å®Œæˆè¯¥é¢˜ç›®
      if (progress && progress.status === ProblemStatus.COMPLETED) {
        const today = new Date();
        const completedDate = new Date(progress.lastAttempted);
        // åˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¤©å®Œæˆçš„
        const isCompletedToday = today.toDateString() === completedDate.toDateString();
        this.isDailyProblemCompleted = isCompletedToday;
      } else {
        this.isDailyProblemCompleted = false;
      }
    } catch (error) {
      console.error('Failed to check daily problem status:', error);
      this.isDailyProblemCompleted = false;
    }
  }

  private async loadReviewProblem(): Promise<void> {
    try {
      console.info('ğŸ”„ å¼€å§‹åŠ è½½å¤ä¹ é¢˜ç›®');
      // è·å–ç”¨æˆ·åšé”™çš„é¢˜ç›®è¿›è¡Œå¤ä¹ 
      const wrongProblems = await this.userProgressDao.getWrongProblems();
      console.info(`ğŸ“Š é”™é¢˜æ•°é‡ï¼š${wrongProblems.length}`);
      console.info('ğŸ“ é”™é¢˜åˆ—è¡¨ï¼š', wrongProblems.map(p => `ID:${p.problemId}, çŠ¶æ€:${p.status}`));

      if (wrongProblems.length > 0) {
        // éšæœºé€‰æ‹©ä¸€ä¸ªé”™é¢˜
        const randomIndex = Math.floor(Math.random() * wrongProblems.length);
        const selectedWrongProblem = wrongProblems[randomIndex];
        const problemId = selectedWrongProblem.problemId;
        console.info(`ğŸ¯ éšæœºé€‰ä¸­é”™é¢˜ID: ${problemId} (ç´¢å¼•: ${randomIndex})`);

        this.reviewProblem = ProblemMockData.getProblemById(problemId);
        if (this.reviewProblem) {
          console.info(`âœ… å¤ä¹ é¢˜ç›®åŠ è½½æˆåŠŸ: ${this.reviewProblem.title}`);
        } else {
          console.error(`âŒ æ‰¾ä¸åˆ°é¢˜ç›®ID ${problemId} å¯¹åº”çš„é¢˜ç›®ä¿¡æ¯`);
          this.reviewProblem = null;
        }
      } else {
        this.reviewProblem = null;
        console.info('ğŸ”´ æš‚æ— é”™é¢˜éœ€è¦å¤ä¹ ');
      }
    } catch (error) {
      console.error('âŒ åŠ è½½å¤ä¹ é¢˜ç›®å¤±è´¥:', error);
      this.reviewProblem = null;
    }
  }

  private async loadStudyStats(): Promise<void> {
    try {
      console.info('ğŸ“Š å¼€å§‹åŠ è½½å­¦ä¹ ç»Ÿè®¡æ•°æ®');
      // è·å–ç”¨æˆ·å­¦ä¹ ç»Ÿè®¡
      const totalSolvedResult = await this.userProgressDao.getCompletedCount();
      const todayCompletedResult = await this.userProgressDao.getTodayCompletedCount();
      const continuousDaysResult = await this.userProgressDao.getContinuousDays();

      console.info('ğŸ“‹ æŸ¥è¯¢ç»“æœ - è¿ç»­å¤©æ•°:', continuousDaysResult, 'ç±»å‹:', typeof continuousDaysResult);
      console.info('ğŸ“‹ æŸ¥è¯¢ç»“æœ - æ€»é¢˜æ•°:', totalSolvedResult, 'ç±»å‹:', typeof totalSolvedResult);
      console.info('ğŸ“‹ æŸ¥è¯¢ç»“æœ - ä»Šæ—¥å®Œæˆ:', todayCompletedResult, 'ç±»å‹:', typeof todayCompletedResult);

      console.info('ğŸ”„ æ›´æ–°å‰çš„æ•°æ®:', `è¿ç»­:${this.continuousDays}, æ€»æ•°:${this.totalSolved}, ä»Šæ—¥:${this.todayCompleted}`);

      // ç›´æ¥æ›´æ–°å„ä¸ªçŠ¶æ€å˜é‡
      this.continuousDays = parseInt(String(continuousDaysResult)) || 0;
      this.totalSolved = parseInt(String(totalSolvedResult)) || 0;
      this.todayCompleted = parseInt(String(todayCompletedResult)) || 0;

      console.info('âœ… æ›´æ–°åçš„æ•°æ®:', `è¿ç»­:${this.continuousDays}, æ€»æ•°:${this.totalSolved}, ä»Šæ—¥:${this.todayCompleted}`);

      console.info('å­¦ä¹ ç»Ÿè®¡ï¼šè¿ç»­å¤©æ•°', this.continuousDays);
      console.info('å­¦ä¹ ç»Ÿè®¡ï¼šæ€»é¢˜æ•°', this.totalSolved);
      console.info('å­¦ä¹ ç»Ÿè®¡ï¼šä»Šæ—¥å®Œæˆ', this.todayCompleted);

      // const all = await this.userProgressDao.getAllUserProgress()
      // console.log('lucky all haha' + JSON.stringify(all) )
    } catch (error) {
      console.error('âŒ åŠ è½½å­¦ä¹ ç»Ÿè®¡å¤±è´¥:', error);
      // ä½¿ç”¨é»˜è®¤æ•°æ®
      this.continuousDays = 1;
      this.totalSolved = 0;
      this.todayCompleted = 0;
    }
  }

  private createDefaultProblem(): ProblemModel {
    const problem = new ProblemModel();
    problem.id = 1;
    problem.title = 'ä¸¤æ•°ä¹‹å’Œ';
    problem.description = 'ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸€ä¸ªæ•´æ•°ç›®æ ‡å€¼ targetï¼Œè¯·ä½ åœ¨è¯¥æ•°ç»„ä¸­æ‰¾å‡ºå’Œä¸ºç›®æ ‡å€¼ target çš„é‚£ä¸¤ä¸ªæ•´æ•°ï¼Œå¹¶è¿”å›å®ƒä»¬çš„æ•°ç»„ä¸‹æ ‡ã€‚';
    problem.difficulty = ProblemDifficulty.EASY;
    problem.category = ProblemCategory.ARRAY;
    return problem;
  }

  private navigateToProblemDetail(problemId: number): void {
    router.pushUrl({
      url: 'pages/ProblemDetailPage',
      params: { problemId: problemId }
    }).catch((error: Error) => {
      console.error('Failed to navigate to problem detail:', error);
    });
  }

  private navigateToDailyProblem(problemId: number): void {
    router.pushUrl({
      url: 'pages/DailyProblemPage',
      params: { problemId: problemId }
    }).catch((error: Error) => {
      console.error('Failed to navigate to daily problem:', error);
    });
  }

  private navigateToPage(url: string): void {
    router.pushUrl({
      url: url
    }).catch((error: Error) => {
      console.error('Failed to navigate to page:', error);
    });
  }
}
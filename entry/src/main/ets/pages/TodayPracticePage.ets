import { ProblemModel, ProblemDifficulty, ProblemCategory } from '../model/ProblemModel';
import { UserProgressModel, ProblemStatus } from '../model/UserProgressModel';
import { ProblemMockData } from '../mock/ProblemMockData';
import { UserProgressDao } from '../dao/UserProgressDao';
import { TabNavigationService } from '../service/TabNavigationService';
import { TimeUtils } from '../utils/TimeUtils';
import router from '@ohos.router';

interface CategoryInfo {
  key: ProblemCategory;
  name: string;
}

@Component
export struct TodayPracticePage {
  @State dailyProblem: ProblemModel | null = null;
  @State reviewProblem: ProblemModel | null = null;
  @State continuousDays: number = 0;
  @State totalSolved: number = 0;
  @State todayCompleted: number = 0;
  @State isDailyProblemCompleted: boolean = false;
  @StorageLink('refreshTodayPage') @Watch('onRefreshTrigger') refreshTrigger: number = 0;
  
  // åˆ†ç±»è¿›åº¦æ•°æ®
  @State categoryProgress: Map<string, number> = new Map();

  // ä½¿ç”¨mockæ•°æ®ï¼Œä¸å†éœ€è¦æ•°æ®åº“å®ä¾‹
  private userProgressDao: UserProgressDao = new UserProgressDao();

  async aboutToAppear() {
    this.loadTodayData();
  }

  /**
   * ç›‘å¬é¡µé¢åˆ·æ–°è§¦å‘å™¨
   */
  onRefreshTrigger() {
    if (this.refreshTrigger > 0) {
      console.info('é¦–é¡µæ•°æ®åˆ·æ–°è§¦å‘');
      this.loadTodayData();
      // æ¸…é™¤è§¦å‘å™¨
      AppStorage.setOrCreate('refreshTodayPage', 0);
    }
  }

  build() {
    Scroll() {
      Column({ space: 20 }) {
        // é¡¶éƒ¨æ—¥æœŸå’Œæ¬¢è¿è¯­
        this.buildHeader()

        // åŠŸèƒ½å›¾æ ‡ç½‘æ ¼ï¼ˆ3è¡Œ4åˆ—ï¼Œå…±9ä¸ªå›¾æ ‡ï¼‰
        this.buildFunctionGrid()

        // æ¯æ—¥ä¸€é¢˜å¡ç‰‡
        this.buildDailyProblemCard()

        // éšæœºå¤ä¹ å¡ç‰‡
        this.buildReviewCard()

        // å­¦ä¹ çŠ¶æ€å¡ç‰‡
        this.buildStudyStatsCard()

        // å½“å‰å­¦ä¹ è¿›åº¦
        this.buildStudyProgressCard()

        // åº•éƒ¨ç•™ç™½ï¼Œç¡®ä¿æœ€åä¸€ä¸ªå…ƒç´ ä¸ä¼šè¢«é®æŒ¡
        Column()
          .height(30)
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }

  @Builder
  buildHeader() {
    Column({ space: 8 }) {
      Text(this.getCurrentDateText())
        .fontSize(16)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)

      Row({ space: 8 }) {
        Text('å¼€å¯ä»Šæ—¥çš„ç»ƒä¹ å§')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
      }
      .justifyContent(FlexAlign.Center)
      .width('100%')
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius({bottomLeft: 16, bottomRight: 16})
    .padding({ top: 20, bottom: 20 })
  }

  @Builder
  buildDailyProblemCard() {
    Stack() {
      Column({ space: 16 }) {
        // å¡ç‰‡å¤´éƒ¨
        Row() {
          Row({ space: 12 }) {
            // å›¾æ ‡èƒŒæ™¯
            Column() {
              Image($r('app.media.icon_rl')).width(26).height(26).fillColor('#FFFFFF')
            }
            .width(48)
            .height(48)
            .backgroundColor('#FF6B35')
            .borderRadius(24)
            .justifyContent(FlexAlign.Center)

            Column({ space: 4 }) {
              Text('æ¯æ—¥ä¸€é¢˜')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF6B35')

              Text('åšæŒæ¯æ—¥ç»ƒä¹ ï¼Œæå‡ç®—æ³•èƒ½åŠ›')
                .fontSize(12)
                .fontColor('#8c8c8c')
            }
            .alignItems(HorizontalAlign.Start)
          }

          Blank()

          if (this.dailyProblem && !this.isDailyProblemCompleted) {
            Column() {
              Text('å¼€å§‹')
                .fontSize(14)
                .fontColor('#ffffff')
                .fontWeight(FontWeight.Medium)
            }
            .width(60)
            .height(32)
            .backgroundColor('#FF6B35')
            .borderRadius(16)
            .justifyContent(FlexAlign.Center)
          }
        }
        .width('100%')

      if (this.dailyProblem) {
        Column({ space: 16 }) {
          // é¢˜ç›®å†…å®¹åŒºåŸŸ
          Column({ space: 12 }) {
            Text(this.dailyProblem.title)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .lineHeight(24)

            // æ ‡ç­¾åŒºåŸŸ
            Row({ space: 12 }) {
              Row({ space: 6 }) {
                Text(this.dailyProblem.getDifficultyText())
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor(this.dailyProblem.getDifficultyColor())
                  .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                  .borderRadius(4)
              }

              Row({ space: 6 }) {
                Text(this.dailyProblem.getCategoryText())
                  .fontSize(12)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#787408')
                  .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                  .borderRadius(4)
              }
            }
            .justifyContent(FlexAlign.Start)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

          if (this.isDailyProblemCompleted) {
            // å·²å®ŒæˆçŠ¶æ€çš„UI
            Row({ space: 12 }) {
              Image($r('app.media.icon_wc')).width(26).height(26).fillColor('#52c41a')

              Column({ space: 2 }) {
                Text('ä»Šæ—¥æŒ‘æˆ˜å·²å®Œæˆ')
                  .fontSize(15)
                  .fontColor('#52c41a')
                  .fontWeight(FontWeight.Medium)

                Text('æ˜å¤©ç»§ç»­åŠ æ²¹ï¼')
                  .fontSize(12)
                  .fontColor('#8c8c8c')
              }
              .alignItems(HorizontalAlign.Start)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#f6ffed')
            .borderRadius(12)
            .border({ width: 1, color: '#d9f7be' })
          }
        }
        .alignItems(HorizontalAlign.Start)
      } else {
        Row({ space: 12 }) {
          Text('â³')
            .fontSize(20)

          Text('æ­£åœ¨ä¸ºæ‚¨å‡†å¤‡ä»Šæ—¥é¢˜ç›®...')
            .fontSize(14)
            .fontColor('#8c8c8c')
        }
        .width('100%')
        .height(60)
        .justifyContent(FlexAlign.Center)
      }
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#ffffff')
      .borderRadius(16)
      .shadow({ radius: 8, color: '#00000008', offsetX: 0, offsetY: 4 })

      // å®ŒæˆçŠ¶æ€å›¾æ ‡ - å³ä¸Šè§’
      if (this.isDailyProblemCompleted) {
        Row() {
          Image($r('app.media.icon_complete'))
            .width(78)
            .fillColor(Color.Red)
            .height(78)
            .zIndex(10)
        }
        .width(100)
        .height(100)
        .justifyContent(FlexAlign.Start)
        .alignItems(VerticalAlign.Center)

      }
    }
    .alignContent(Alignment.TopEnd)
    .onClick(() => {
      if (this.dailyProblem) {
        this.navigateToDailyProblem(this.dailyProblem.id);
      }
    })
  }

  @Builder
  buildReviewCard() {
    Column({ space: 16 }) {
      // å¡ç‰‡å¤´éƒ¨
      Row() {
        Row({ space: 12 }) {
          // å›¾æ ‡èƒŒæ™¯
          Column() {
            Image($r('app.media.icon_fx')).width(26).height(26).fillColor('#FFFFFF')
          }
          .width(48)
          .height(48)
          .backgroundColor('#fa8c16')
          .borderRadius(24)
          .justifyContent(FlexAlign.Center)

          Column({ space: 4 }) {
            Text('æ™ºèƒ½å¤ä¹ ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fa8c16')

            Text('å·©å›ºè–„å¼±çŸ¥è¯†ç‚¹ï¼Œæå‡è§£é¢˜èƒ½åŠ›')
              .fontSize(12)
              .fontColor('#8c8c8c')
          }
          .alignItems(HorizontalAlign.Start)
        }

        Blank()

        if (this.reviewProblem) {
          Column() {
            Text('å¤ä¹ ')
              .fontSize(14)
              .fontColor('#ffffff')
              .fontWeight(FontWeight.Medium)
          }
          .width(60)
          .height(32)
          .backgroundColor('#fa8c16')
          .borderRadius(16)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')

      if (this.reviewProblem) {
        Column({ space: 16 }) {
          // é¢˜ç›®å†…å®¹åŒºåŸŸ
          Column({ space: 12 }) {
            Text(this.reviewProblem.title)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#262626')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .lineHeight(24)

            // æ ‡ç­¾åŒºåŸŸ
            Row({ space: 12 }) {
              Row({ space: 6 }) {
                Text(this.reviewProblem.getDifficultyText())
                  .fontSize(12)
                  .fontColor('#ffffff')
                  .backgroundColor(this.reviewProblem.getDifficultyColor())
                  .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                  .borderRadius(4)
              }

              Row({ space: 6 }) {
                Text(this.reviewProblem.getCategoryText())
                  .fontSize(12)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#787408')
                  .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                  .borderRadius(4)
              }
            }
            .justifyContent(FlexAlign.Start)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

          // å¤ä¹ æç¤º
          Row({ space: 12 }) {
            Text('æ¥è‡ªé”™é¢˜æœ¬ï¼Œå»ºè®®é‡ç‚¹å¤ä¹ ')
              .fontSize(13)
              .fontColor('#fa8c16')
              .fontWeight(FontWeight.Medium)
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#fff7e6')
          .borderRadius(8)
          .border({ width: 1, color: '#ffd591' })
        }
        .alignItems(HorizontalAlign.Start)
      } else {
        Column({ space: 12 }) {
          Image($r('app.media.icon_empty'))
            .width(58)
            .height(42)

          Column({ space: 6 }) {
            Text('æš‚æ— éœ€è¦å¤ä¹ çš„é¢˜ç›®')
              .fontSize(16)
              .fontColor('#262626')
              .fontWeight(FontWeight.Medium)

            Text('å®Œæˆæ›´å¤šç»ƒä¹ åä¼šæœ‰æ™ºèƒ½å¤ä¹ æ¨è')
              .fontSize(13)
              .fontColor('#8c8c8c')
          }
          .alignItems(HorizontalAlign.Center)
        }
        .width('100%')
        .height(100)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(16)
    .shadow({ radius: 8, color: '#00000008', offsetX: 0, offsetY: 4 })
    .onClick(() => {
      if (this.reviewProblem) {
        this.navigateToProblemDetail(this.reviewProblem.id);
      }
    })
  }

  @Builder
  buildStudyStatsCard() {
    Column({ space: 20 }) {
      // å¡ç‰‡å¤´éƒ¨
      Row() {
        Row({ space: 12 }) {
          // å›¾æ ‡èƒŒæ™¯
          Column() {
            Image($r('app.media.icon_tj')).width(26).height(26).fillColor('#FFFFFF')
          }
          .width(48)
          .height(48)
          .backgroundColor('#0ea5e9')
          .borderRadius(24)
          .justifyContent(FlexAlign.Center)

          Column({ space: 4 }) {
            Text('å­¦ä¹ ç»Ÿè®¡')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#0ea5e9')

            Text('æŸ¥çœ‹æ‚¨çš„å­¦ä¹ æˆæœå’Œè¿›æ­¥')
              .fontSize(12)
              .fontColor('#8c8c8c')
          }
          .alignItems(HorizontalAlign.Start)
        }

        Blank()

        Column() {
          Text('è¯¦æƒ…')
            .fontSize(14)
            .fontColor('#ffffff')
            .fontWeight(FontWeight.Medium)
        }
        .width(60)
        .height(32)
        .backgroundColor('#0ea5e9')
        .borderRadius(16)
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')

      // ç»Ÿè®¡æ•°æ®åŒºåŸŸ
      Row({ space: 20 }) {
        this.buildContinuousDayStatItem('è¿ç»­å­¦ä¹ ', '#ff6b35')
        this.buildTotalSoledStatItem('æ€»æ”»å…‹æ•°', '#1890ff')
        this.buildTodayCompletedStatItem('ä»Šæ—¥å®Œæˆ', '#52c41a')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(16)
    .shadow({ radius: 8, color: '#00000008', offsetX: 0, offsetY: 4 })
    .onClick(() => {
      this.navigateToPage('pages/StatisticsPage');
    })
  }

  @Builder
  buildModernStatItem(icon: string, value: string, label: string, color: string) {
    Column({ space: 8 }) {
      // æ•°å€¼
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      // æ ‡ç­¾
      Text(label)
        .fontSize(12)
        .fontColor('#8c8c8c')
        .fontWeight(FontWeight.Medium)
    }
    .alignItems(HorizontalAlign.Center)
    .padding(12)
    .backgroundColor('#fafafa')
    .borderRadius(12)
    .layoutWeight(1)
  }

  @Builder
  buildContinuousDayStatItem(title: string, color: string) {
    Column({ space: 8 }) {
      // æ•°å€¼
      Text(`${this.continuousDays}å¤©`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      // æ ‡ç­¾
      Text(title)
        .fontSize(12)
        .fontColor('#8c8c8c')
        .fontWeight(FontWeight.Medium)
    }
    .alignItems(HorizontalAlign.Center)
    .padding(12)
    .backgroundColor('#fafafa')
    .borderRadius(12)
    .layoutWeight(1)
    .onClick(() => {
      this.navigateToPage('pages/ContinuousStudyPage');
    })
  }

  @Builder
  buildTotalSoledStatItem(title: string, color: string) {
    Column({ space: 8 }) {
      // æ•°å€¼
      Text(`${this.totalSolved}é¢˜`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      // æ ‡ç­¾
      Text(title)
        .fontSize(12)
        .fontColor('#8c8c8c')
        .fontWeight(FontWeight.Medium)
    }
    .alignItems(HorizontalAlign.Center)
    .padding(12)
    .backgroundColor('#fafafa')
    .borderRadius(12)
    .layoutWeight(1)
    .onClick(() => {
      this.navigateToPage('pages/TotalSolvedPage');
    })
  }

  @Builder
  buildTodayCompletedStatItem(title: string, color: string) {
    Column({ space: 8 }) {
      // æ•°å€¼
      Text(`${this.todayCompleted}é¢˜`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      // æ ‡ç­¾
      Text(title)
        .fontSize(12)
        .fontColor('#8c8c8c')
        .fontWeight(FontWeight.Medium)
    }
    .alignItems(HorizontalAlign.Center)
    .padding(12)
    .backgroundColor('#fafafa')
    .borderRadius(12)
    .layoutWeight(1)
    .onClick(() => {
      this.navigateToPage('pages/TodayCompletedPage');
    })
  }

  @Builder
  buildQuickActions() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('å¿«æ·å…¥å£')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .alignSelf(ItemAlign.Start)

      // ç¬¬ä¸€è¡Œ
      Row({ space: 16 }) {
        this.buildQuickActionItem($r('app.media.icon_like'), 'æ”¶è—å¤¹', () => {
          this.navigateToPage('pages/FavoritesPage');
        })

        this.buildQuickActionItem($r('app.media.icon_error'), 'é”™é¢˜æœ¬', () => {
          this.navigateToPage('pages/WrongProblemsPage');
        })

        this.buildQuickActionItem($r('app.media.icon_note'), 'å­¦ä¹ ç¬”è®°', () => {
          this.navigateToPage('pages/StudyNotesPage');
        })

        this.buildQuickActionItem($r('app.media.icon_exam'), 'æ¨¡æ‹Ÿè€ƒè¯•', () => {
          console.info('ç‚¹å‡»æ¨¡æ‹Ÿè€ƒè¯•');
          const tabNavigationService = TabNavigationService.getInstance();
          tabNavigationService.switchToExam();
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)

      // ç¬¬äºŒè¡Œ
      Row({ space: 16 }) {
        this.buildQuickActionItem($r('app.media.icon_tj'), 'æ•°æ®ç»Ÿè®¡', () => {
          this.navigateToPage('pages/StatisticsPage');
        })

        // å ä½ç¬¦ï¼Œä¿æŒå¯¹é½
        Column()
          .width(60)
          .height(60)

        Column()
          .width(60)
          .height(60)

        Column()
          .width(60)
          .height(60)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildQuickActionItem(iconResource: Resource, title: string, onClick: () => void) {
    Column({ space: 8 }) {
      Image(iconResource)
        .width(24)
        .height(24)
        .fillColor('#666666')

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .width(60)
    .height(60)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 2, color: '#00000008', offsetX: 0, offsetY: 1 })
    .onClick(onClick)
  }

  private getCurrentDateText(): string {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const weekday = weekdays[now.getDay()];

    return `${year}å¹´${month}æœˆ${day}æ—¥ ${weekday}`;
  }

  private async loadTodayData(): Promise<void> {
    try {
      console.info('å¼€å§‹åŠ è½½é¦–é¡µæ•°æ®');
      // åŠ è½½æ¯æ—¥é¢˜ç›®
      await this.loadDailyProblem();

      // åŠ è½½å¤ä¹ é¢˜ç›®
      await this.loadReviewProblem();

      // åŠ è½½å­¦ä¹ ç»Ÿè®¡
      await this.loadStudyStats();

      // åŠ è½½åˆ†ç±»è¿›åº¦
      await this.loadCategoryProgress();

      console.info('é¦–é¡µæ•°æ®åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('Failed to load today data:', error);
    }
  }

  private async loadDailyProblem(): Promise<void> {
    try {
      // è·å–æ‰€æœ‰å¯ç”¨çš„é¢˜ç›®
      const allProblems = ProblemMockData.getAllProblems();
      if (allProblems.length === 0) {
        this.dailyProblem = this.createDefaultProblem();
        return;
      }

      // æ ¹æ®æ—¥æœŸç”Ÿæˆæ¯æ—¥é¢˜ç›®ç´¢å¼•ï¼ˆä½¿ç”¨å®é™…é¢˜ç›®æ•°é‡ï¼‰
      const today = new Date();
      const dayOfYear = Math.floor((today.getTime() - new Date(today.getFullYear(), 0, 0).getTime()) / 86400000);
      const problemIndex = dayOfYear % allProblems.length;

      this.dailyProblem = allProblems[problemIndex];

      // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°é¢˜ç›®ï¼Œä½¿ç”¨ç¬¬ä¸€é¢˜ä½œä¸ºé»˜è®¤
      if (!this.dailyProblem) {
        this.dailyProblem = allProblems[0];
      }

      // æ£€æŸ¥æ¯æ—¥é¢˜ç›®æ˜¯å¦å·²å®Œæˆ
      if (this.dailyProblem) {
        console.log('lucky dailyProblem is ' + JSON.stringify(this.dailyProblem))
        await this.checkDailyProblemStatus();
      }
    } catch (error) {
      console.error('Failed to load daily problem:', error);
      // åˆ›å»ºä¸€ä¸ªé»˜è®¤é¢˜ç›®
      this.dailyProblem = this.createDefaultProblem();
    }
  }

  // æ£€æŸ¥æ¯æ—¥é¢˜ç›®å®ŒæˆçŠ¶æ€
  private async checkDailyProblemStatus(): Promise<void> {
    if (!this.dailyProblem) return;

    try {
      const progress = await this.userProgressDao.getUserProgress(this.dailyProblem.id);
      console.log('lucky daily progress is ' + JSON.stringify(progress))
      // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»å®Œæˆè¯¥é¢˜ç›®
      if (progress && progress.status !== ProblemStatus.NOT_ATTEMPTED) {
        // ä½¿ç”¨ç»Ÿä¸€çš„æœ¬åœ°æ—¶é—´æ ¼å¼è¿›è¡Œæ¯”è¾ƒï¼Œé¿å…æ—¶åŒºé—®é¢˜
        const todayDateString = TimeUtils.getLocalDateString(); // YYYY-MM-DDæ ¼å¼
        const completedDateString = TimeUtils.getLocalDateString(new Date(progress.lastAttempted)); // YYYY-MM-DDæ ¼å¼
        // åˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¤©å®Œæˆçš„
        const isCompletedToday = todayDateString === completedDateString;
        this.isDailyProblemCompleted = isCompletedToday;
        
        console.log(`æ—¶é—´æ¯”è¾ƒ: ä»Šå¤©=${todayDateString}, å®Œæˆæ—¥æœŸ=${completedDateString}, æ˜¯å¦ä»Šå¤©å®Œæˆ=${isCompletedToday}`);
      } else {
        this.isDailyProblemCompleted = false;
      }
    } catch (error) {
      console.error('Failed to check daily problem status:', error);
      this.isDailyProblemCompleted = false;
    }
  }

  private async loadReviewProblem(): Promise<void> {
    try {
      console.info('ğŸ”„ å¼€å§‹åŠ è½½å¤ä¹ é¢˜ç›®');
      // è·å–ç”¨æˆ·åšé”™çš„é¢˜ç›®è¿›è¡Œå¤ä¹ 
      const wrongProblems = await this.userProgressDao.getWrongProblems();
      console.info(`ğŸ“Š é”™é¢˜æ•°é‡ï¼š${wrongProblems.length}`);
      console.info('ğŸ“ é”™é¢˜åˆ—è¡¨ï¼š', wrongProblems.map(p => `ID:${p.problemId}, çŠ¶æ€:${p.status}`));

      if (wrongProblems.length > 0) {
        // éšæœºé€‰æ‹©ä¸€ä¸ªé”™é¢˜
        const randomIndex = Math.floor(Math.random() * wrongProblems.length);
        const selectedWrongProblem = wrongProblems[randomIndex];
        const problemId = selectedWrongProblem.problemId;
        console.info(`ğŸ¯ éšæœºé€‰ä¸­é”™é¢˜ID: ${problemId} (ç´¢å¼•: ${randomIndex})`);

        this.reviewProblem = ProblemMockData.getProblemById(problemId);
        if (this.reviewProblem) {
          console.info(`âœ… å¤ä¹ é¢˜ç›®åŠ è½½æˆåŠŸ: ${this.reviewProblem.title}`);
        } else {
          console.error(`âŒ æ‰¾ä¸åˆ°é¢˜ç›®ID ${problemId} å¯¹åº”çš„é¢˜ç›®ä¿¡æ¯`);
          this.reviewProblem = null;
        }
      } else {
        this.reviewProblem = null;
        console.info('ğŸ”´ æš‚æ— é”™é¢˜éœ€è¦å¤ä¹ ');
      }
    } catch (error) {
      console.error('âŒ åŠ è½½å¤ä¹ é¢˜ç›®å¤±è´¥:', error);
      this.reviewProblem = null;
    }
  }

  private async loadStudyStats(): Promise<void> {
    try {
      console.info('ğŸ“Š å¼€å§‹åŠ è½½å­¦ä¹ ç»Ÿè®¡æ•°æ®');
      // è·å–ç”¨æˆ·å­¦ä¹ ç»Ÿè®¡
      const totalSolvedResult = await this.userProgressDao.getCompletedCount();
      const todayCompletedResult = await this.userProgressDao.getTodayCompletedCount();
      const continuousDaysResult = await this.userProgressDao.getContinuousDays();

      console.info('ğŸ“‹ æŸ¥è¯¢ç»“æœ - è¿ç»­å¤©æ•°:', continuousDaysResult, 'ç±»å‹:', typeof continuousDaysResult);
      console.info('ğŸ“‹ æŸ¥è¯¢ç»“æœ - æ€»é¢˜æ•°:', totalSolvedResult, 'ç±»å‹:', typeof totalSolvedResult);
      console.info('ğŸ“‹ æŸ¥è¯¢ç»“æœ - ä»Šæ—¥å®Œæˆ:', todayCompletedResult, 'ç±»å‹:', typeof todayCompletedResult);

      console.info('ğŸ”„ æ›´æ–°å‰çš„æ•°æ®:', `è¿ç»­:${this.continuousDays}, æ€»æ•°:${this.totalSolved}, ä»Šæ—¥:${this.todayCompleted}`);

      // ç›´æ¥æ›´æ–°å„ä¸ªçŠ¶æ€å˜é‡
      this.continuousDays = parseInt(String(continuousDaysResult)) || 0;
      this.totalSolved = parseInt(String(totalSolvedResult)) || 0;
      this.todayCompleted = parseInt(String(todayCompletedResult)) || 0;

      console.info('âœ… æ›´æ–°åçš„æ•°æ®:', `è¿ç»­:${this.continuousDays}, æ€»æ•°:${this.totalSolved}, ä»Šæ—¥:${this.todayCompleted}`);

      console.info('å­¦ä¹ ç»Ÿè®¡ï¼šè¿ç»­å¤©æ•°', this.continuousDays);
      console.info('å­¦ä¹ ç»Ÿè®¡ï¼šæ€»é¢˜æ•°', this.totalSolved);
      console.info('å­¦ä¹ ç»Ÿè®¡ï¼šä»Šæ—¥å®Œæˆ', this.todayCompleted);

      // const all = await this.userProgressDao.getAllUserProgress()
      // console.log('lucky all haha' + JSON.stringify(all) )
    } catch (error) {
      console.error('âŒ åŠ è½½å­¦ä¹ ç»Ÿè®¡å¤±è´¥:', error);
      // ä½¿ç”¨é»˜è®¤æ•°æ®
      this.continuousDays = 0;
      this.totalSolved = 0;
      this.todayCompleted = 0;
    }
  }

  private getCategoryColor(categoryName: string): string {
    const colorMap: Record<string, string> = {
      'æ•°ç»„ä¸å­—ç¬¦ä¸²': '#1890ff',
      'é“¾è¡¨æ“ä½œ': '#52c41a',
      'å­—ç¬¦ä¸²ç®—æ³•': '#fa8c16',
      'äºŒå‰æ ‘': '#13c2c2',
      'åŒæŒ‡é’ˆæŠ€å·§': '#722ed1',
      'åŠ¨æ€è§„åˆ’': '#eb2f96',
      'äºŒåˆ†æŸ¥æ‰¾': '#f5222d',
      'æ•°å­¦ç®—æ³•': '#fa541c',
      'æ ˆä¸é˜Ÿåˆ—': '#52c41a',
      'å“ˆå¸Œè¡¨': '#2f54eb',
      'å›æº¯ç®—æ³•': '#722ed1',
      'è´ªå¿ƒç®—æ³•': '#52c41a',
      'ä½è¿ç®—': '#13c2c2',
      'è®¾è®¡é¢˜': '#fa8c16',
      'åˆ†æ²»ç®—æ³•': '#eb2f96',
      'æ»‘åŠ¨çª—å£': '#f5222d',
      'å‰ç¼€å’Œ': '#fa541c',
      'å•è°ƒæ ˆ': '#1890ff',
      'å­—å…¸æ ‘': '#722ed1',
      'å›¾ç®—æ³•': '#13c2c2',
      'æ’åºç®—æ³•': '#52c41a'
    };
    
    return colorMap[categoryName] || '#666666';
  }

  private async loadCategoryProgress(): Promise<void> {
    try {
      console.info('ğŸ“Š å¼€å§‹åŠ è½½åˆ†ç±»è¿›åº¦æ•°æ®');
      
      // è·å–å„åˆ†ç±»çš„æ€»é¢˜ç›®æ•°é‡
      const allProblems = ProblemMockData.getAllProblems();
      const categoryTotals = new Map<string, number>();
      
      // ç»Ÿè®¡å„åˆ†ç±»çš„æ€»é¢˜ç›®æ•°
      allProblems.forEach(problem => {
        const category = problem.category;
        const currentCount = categoryTotals.get(category) || 0;
        categoryTotals.set(category, currentCount + 1);
      });
      
      // è·å–å„åˆ†ç±»çš„å­¦ä¹ è¿›åº¦
      const progressMap = new Map<string, number>();
      
      // ä½¿ç”¨ä¸å­¦ä¹ è·¯çº¿é¡µé¢ç›¸åŒçš„æ‰€æœ‰ç±»ç›®é…ç½®
      const allCategories: CategoryInfo[] = [];
      
      // æ·»åŠ æ‰€æœ‰21ä¸ªåˆ†ç±»
      allCategories.push({ key: ProblemCategory.ARRAY, name: 'æ•°ç»„ä¸å­—ç¬¦ä¸²' });
      allCategories.push({ key: ProblemCategory.LINKED_LIST, name: 'é“¾è¡¨æ“ä½œ' });
      allCategories.push({ key: ProblemCategory.STRING, name: 'å­—ç¬¦ä¸²ç®—æ³•' });
      allCategories.push({ key: ProblemCategory.BINARY_TREE, name: 'äºŒå‰æ ‘' });
      allCategories.push({ key: ProblemCategory.TWO_POINTERS, name: 'åŒæŒ‡é’ˆæŠ€å·§' });
      allCategories.push({ key: ProblemCategory.DYNAMIC_PROGRAMMING, name: 'åŠ¨æ€è§„åˆ’' });
      allCategories.push({ key: ProblemCategory.BINARY_SEARCH, name: 'äºŒåˆ†æŸ¥æ‰¾' });
      allCategories.push({ key: ProblemCategory.MATH, name: 'æ•°å­¦ç®—æ³•' });
      allCategories.push({ key: ProblemCategory.STACK, name: 'æ ˆä¸é˜Ÿåˆ—' });
      allCategories.push({ key: ProblemCategory.HASH_TABLE, name: 'å“ˆå¸Œè¡¨' });
      allCategories.push({ key: ProblemCategory.BACKTRACKING, name: 'å›æº¯ç®—æ³•' });
      allCategories.push({ key: ProblemCategory.GREEDY, name: 'è´ªå¿ƒç®—æ³•' });
      allCategories.push({ key: ProblemCategory.BIT_MANIPULATION, name: 'ä½è¿ç®—' });
      allCategories.push({ key: ProblemCategory.DESIGN, name: 'è®¾è®¡é¢˜' });
      allCategories.push({ key: ProblemCategory.DIVIDE_CONQUER, name: 'åˆ†æ²»ç®—æ³•' });
      allCategories.push({ key: ProblemCategory.SLIDING_WINDOW, name: 'æ»‘åŠ¨çª—å£' });
      allCategories.push({ key: ProblemCategory.PREFIX_SUM, name: 'å‰ç¼€å’Œ' });
      allCategories.push({ key: ProblemCategory.MONOTONIC_STACK, name: 'å•è°ƒæ ˆ' });
      allCategories.push({ key: ProblemCategory.TRIE, name: 'å­—å…¸æ ‘' });
      allCategories.push({ key: ProblemCategory.GRAPH, name: 'å›¾ç®—æ³•' });
      allCategories.push({ key: ProblemCategory.SORT, name: 'æ’åºç®—æ³•' });
      
      for (const category of allCategories) {
        const studiedCount = await this.userProgressDao.getStudyProgressCountByCategory(category.key);
        const totalCount = categoryTotals.get(category.key) || 1; // é¿å…é™¤é›¶
        const progress = totalCount > 0 ? studiedCount / totalCount : 0;
        progressMap.set(category.name, progress);
        
        console.info(`ğŸ“ˆ åˆ†ç±»è¿›åº¦ - ${category.name}: ${studiedCount}/${totalCount} = ${(progress * 100).toFixed(1)}%`);
      }
      
      this.categoryProgress = progressMap;
      console.info('âœ… åˆ†ç±»è¿›åº¦æ•°æ®åŠ è½½å®Œæˆ');
      
    } catch (error) {
      console.error('âŒ åŠ è½½åˆ†ç±»è¿›åº¦å¤±è´¥:', error);
      // ä½¿ç”¨é»˜è®¤æ•°æ®
      this.categoryProgress = new Map();
    }
  }

  private createDefaultProblem(): ProblemModel {
    const problem = new ProblemModel();
    problem.id = 1;
    problem.title = 'ä¸¤æ•°ä¹‹å’Œ';
    problem.description = 'ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸€ä¸ªæ•´æ•°ç›®æ ‡å€¼ targetï¼Œè¯·ä½ åœ¨è¯¥æ•°ç»„ä¸­æ‰¾å‡ºå’Œä¸ºç›®æ ‡å€¼ target çš„é‚£ä¸¤ä¸ªæ•´æ•°ï¼Œå¹¶è¿”å›å®ƒä»¬çš„æ•°ç»„ä¸‹æ ‡ã€‚';
    problem.difficulty = ProblemDifficulty.EASY;
    problem.category = ProblemCategory.ARRAY;
    return problem;
  }

  private navigateToProblemDetail(problemId: number): void {
    router.pushUrl({
      url: 'pages/ProblemDetailPage',
      params: { problemId: problemId }
    }).catch((error: Error) => {
      console.error('Failed to navigate to problem detail:', error);
    });
  }

  private navigateToDailyProblem(problemId: number): void {
    router.pushUrl({
      url: 'pages/DailyProblemPage',
      params: { problemId: problemId }
    }).catch((error: Error) => {
      console.error('Failed to navigate to daily problem:', error);
    });
  }



  @Builder
  buildFunctionGrid() {
    Column({ space: 16 }) {
      // ç¬¬ä¸€è¡Œï¼šå­¦ä¹ è·¯çº¿ã€é¢˜åº“ã€è€ƒæ ¸ã€ç»Ÿè®¡
      Row({ space: 20 }) {
        this.buildFunctionItem($r('app.media.icon_route'), 'å­¦ä¹ è·¯çº¿', () => this.switchToTab(1))
        this.buildFunctionItem($r('app.media.icon_train_center'), 'é¢˜åº“', () => this.switchToTab(2))
        this.buildFunctionItem($r('app.media.icon_exam'), 'è€ƒæ ¸', () => this.switchToTab(3))
        this.buildFunctionItem($r('app.media.icon_tj'), 'ç»Ÿè®¡', () => this.navigateToPage('pages/StatisticsPage'))
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)

      // ç¬¬äºŒè¡Œï¼šå­¦ä¹ ç¬”è®°ã€é”™é¢˜æœ¬ã€æˆ‘çš„æ”¶è—ã€å­¦ä¹ æ—¥è®°
      Row({ space: 20 }) {
        this.buildFunctionItem($r('app.media.icon_note'), 'å­¦ä¹ ç¬”è®°', () => this.navigateToPage('pages/StudyNotesPage'))
        this.buildFunctionItem($r('app.media.icon_error'), 'é”™é¢˜æœ¬', () => this.navigateToPage('pages/WrongProblemsPage'))
        this.buildFunctionItem($r('app.media.icon_like'), 'æˆ‘çš„æ”¶è—', () => this.navigateToPage('pages/FavoritesPage'))
        this.buildFunctionItem($r('app.media.icon_rj'), 'å­¦ä¹ æ—¥è®°', () => this.navigateToPage('pages/StudyDiaryPage'))
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)

      // ç¬¬ä¸‰è¡Œï¼šå­¦ä¹ ç›®æ ‡ï¼ˆåªæœ‰ä¸€ä¸ªï¼Œå±…ä¸­æ˜¾ç¤ºï¼‰
      Row() {
        this.buildFunctionItem($r('app.media.icon_traget'), 'å­¦ä¹ ç›®æ ‡', () => this.navigateToPage('pages/StudyGoalsPage'))// æ·»åŠ å ä½ç©ºé—´ï¼Œä¿æŒä¸ä¸Šä¸€è¡Œå¯¹é½
        Blank().width(220) // ä¸å›¾æ ‡å®½åº¦ç›¸åŒ
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildFunctionItem(icon: Resource, title: string, onClickAction: () => void) {
    Column({ space: 8 }) {
      Stack() {
        Circle({ width: 60, height: 60 })
          .fill('#FF6B35')
          .shadow({
            radius: 8,
            color: '#00000010',
            offsetX: 0,
            offsetY: 2
          })

        Image(icon)
          .width(32)
          .height(32)
          .fillColor('#FFFFFF')
      }
      .width(60)
      .height(60)

      Text(title)
        .fontSize(12)
        .fontColor('#333333')
        .textAlign(TextAlign.Center)
    }
    .width(60)
    .onClick(onClickAction)
  }

  @Builder
  buildStudyProgressCard() {
    Column({ space: 20 }) {
      // å¡ç‰‡å¤´éƒ¨
      Row() {
        Row({ space: 12 }) {
          // å›¾æ ‡èƒŒæ™¯
          Column() {
            Image($r('app.media.icon_progress')).width(26).height(26).fillColor('#FFFFFF')
          }
          .width(48)
          .height(48)
          .backgroundColor('#722ed1')
          .borderRadius(24)
          .justifyContent(FlexAlign.Center)

          Column({ space: 4 }) {
            Text('å­¦ä¹ è¿›åº¦')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#722ed1')

            Text('å„ç±»ç›®æŒæ¡æƒ…å†µä¸€è§ˆ')
              .fontSize(12)
              .fontColor('#8c8c8c')
          }
          .alignItems(HorizontalAlign.Start)
        }
      }
      .width('100%')

      // è¿›åº¦æ¡åŒºåŸŸ
      Column({ space: 16 }) {
        ForEach(Array.from(this.categoryProgress.keys()), (categoryName: string) => {
          this.buildModernProgressItem(
            categoryName, 
            this.categoryProgress.get(categoryName) || 0, 
            this.getCategoryColor(categoryName)
          )
        }, (categoryName: string) => categoryName)
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(16)
    .shadow({ radius: 8, color: '#00000008', offsetX: 0, offsetY: 4 })
  }

  @Builder
  buildProgressItem(category: string, progress: number, color: string) {
    Column({ space: 8 }) {
      Row() {
        Text(category)
          .fontSize(14)
          .fontColor('#333333')
          .layoutWeight(1)

        Text(`${Math.round(progress * 100)}%`)
          .fontSize(12)
          .fontColor('#666666')
      }
      .width('100%')

      Row() {
        Progress({ value: progress * 100, total: 100, type: ProgressType.Linear })
          .width('100%')
          .color(color)
          .backgroundColor('#F0F0F0')
      }
    }
    .width('100%')
  }

  @Builder
  buildModernProgressItem(category: string, progress: number, color: string) {
    Row({ space: 16 }) {
      // å·¦ä¾§å›¾æ ‡å’Œç±»åˆ«
      Row({ space: 12 }) {
        Column({ space: 2 }) {
          Text(category)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#262626')

          Text(`${Math.round(progress * 100)}% å®Œæˆ`)
            .fontSize(12)
            .fontColor('#8c8c8c')
        }
        .alignItems(HorizontalAlign.Start)
      }

      Blank()

      // å³ä¾§è¿›åº¦æ¡
      Column({ space: 6 }) {
        Row() {
          Text(`${Math.round(progress * 100)}%`)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(color)
        }
        .width(60)
        .justifyContent(FlexAlign.End)

        Progress({ value: progress * 100, total: 100, type: ProgressType.Linear })
          .width(120)
          .height(6)
          .color(color)
          .backgroundColor('#F1EEEE')
          .borderRadius(3)
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor('#fafafa')
    .borderRadius(12)
    .border({ width: 1, color: '#f0f0f0' })
  }

  private switchToTab(tabIndex: number): void {
    const tabNavigationService = TabNavigationService.getInstance();
    tabNavigationService.switchToTab(tabIndex);
  }

  private navigateToPage(pagePath: string): void {
    router.pushUrl({
      url: pagePath
    }).catch((error: Error) => {
      console.error('é¡µé¢è·³è½¬å¤±è´¥:', error);
    });
  }
}
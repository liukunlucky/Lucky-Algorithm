import { ProblemModel } from '../model/ProblemModel';
import { UserNoteModel } from '../model/UserNoteModel';
import { UserNoteDao } from '../dao/UserNoteDao';
import { ProblemMockData } from '../mock/ProblemMockData';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

interface NoteWithProblem {
  note: UserNoteModel;
  problem: ProblemModel | null;
}

@Entry
@Component
struct StudyNotesPage {
  @State allNotes: UserNoteModel[] = [];
  @State notesWithProblems: NoteWithProblem[] = [];
  @State isLoading: boolean = true;
  @State searchText: string = '';
  @State filteredNotes: NoteWithProblem[] = [];
  @State selectedNote: NoteWithProblem | null = null;
  @State isEditingNote: boolean = false;
  @State editingContent: string = '';
  @State showEditSheet: boolean = false; // æ–°å¢ï¼šæ§åˆ¶ç¼–è¾‘Sheetçš„æ˜¾ç¤º
  
  private userNoteDao: UserNoteDao = new UserNoteDao();

  onPageShow(): void {
    this.loadNotes();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()

      // æœç´¢æ 
      this.buildSearchBar()

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        this.buildLoadingState()
      } else if (this.filteredNotes.length === 0) {
        this.buildEmptyState()
      } else {
        this.buildNotesList()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row() {
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .backgroundColor('transparent')
      .onClick(() => {
        router.back();
      })

      Text('å­¦ä¹ ç¬”è®°')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // å ä½å…ƒç´ ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
      Blank().width(32)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
    .shadow({
      radius: 2,
      color: '#00000010',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  buildSearchBar() {
    Row({ space: 12 }) {
      TextInput({
        placeholder: 'æœç´¢ç¬”è®°å†…å®¹æˆ–é¢˜ç›®æ ‡é¢˜...',
        text: this.searchText
      })
        .layoutWeight(1)
        .placeholderColor('#D5DBDB')
        .height(40)
        .fontSize(14)
        .backgroundColor('#f8f9fa')
        .borderRadius(20)
        .onChange((value: string) => {
          this.searchText = value;
          this.filterNotes();
        })

    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor('#ffffff')
  }

  @Builder
  buildLoadingState() {
    Column({ space: 16 }) {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#52c41a')

      Text('æ­£åœ¨åŠ è½½ç¬”è®°...')
        .fontSize(14)
        .fontColor('#666666')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildEmptyState() {
    Column({ space: 16 }) {
      Image($r('app.media.icon_empty'))
        .width(173)
        .height(128)

      Text('è¿˜æ²¡æœ‰å­¦ä¹ ç¬”è®°')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#666666')

      Text('åœ¨åšé¢˜è¿‡ç¨‹ä¸­è®°å½•ç¬”è®°ï¼Œ\næ€»ç»“è§£é¢˜æ€è·¯å’ŒçŸ¥è¯†ç‚¹')
        .fontSize(14)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)
        .lineHeight(20)

      Button('å»ç»ƒä¹ é¢˜ç›®')
        .fontSize(14)
        .fontColor('#ffffff')
        .backgroundColor('#F34F40')
        .borderRadius(20)
        .padding({ left: 24, right: 24, top: 12, bottom: 12 })
        .onClick(() => {
          // åˆ‡æ¢åˆ°ç»ƒä¹ ä¸­å¿ƒ
          router.back();
          // å¯ä»¥é€šè¿‡AppStorageè§¦å‘Tabåˆ‡æ¢
          AppStorage.setOrCreate('switchToTabIndex', 2);
        })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .padding(32)
  }

  @Builder
  buildNotesList() {
    List({ space: 12 }) {
      ForEach(this.filteredNotes, (noteWithProblem: NoteWithProblem, index: number) => {
        ListItem() {
          this.buildNoteItem(noteWithProblem)
        }
      })
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ left: 16, right: 16, top: 8, bottom: 16 })
    .scrollBar(BarState.Auto)
    .edgeEffect(EdgeEffect.Spring)
    .bindSheet($$this.showEditSheet, this.buildEditSheet(), {
      height: 500,
      dragBar: true,
      preferType:SheetType.CENTER,
      showClose: false,
      backgroundColor: '#ffffff'
    })
  }

  @Builder
  buildNoteItem(noteWithProblem: NoteWithProblem) {
    Column({ space: 12 }) {
      // é¢˜ç›®æ ‡é¢˜å’Œæ—¶é—´
      Row() {
        Column({ space: 4 }) {
          Text(noteWithProblem.problem?.title || 'æœªçŸ¥é¢˜ç›®')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Row({ space: 8 }) {
            Text(this.formatDate(noteWithProblem.note.updatedAt))
              .fontSize(12)
              .fontColor('#999999')

            if (noteWithProblem.problem) {
              Text(noteWithProblem.problem.getCategoryText())
                .fontSize(12)
                .fontColor('#ffffff')
                .backgroundColor('#52c41a')
                .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                .borderRadius(4)
            }
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // å³ä¸‹è§’æŸ¥çœ‹é¢˜ç›®æŒ‰é’®
        Row() {
          Blank()
          
          Row({ space: 8 }) {
            Button() {
              Image($r('app.media.icon_delete'))
                .width(16)
                .height(16)
                .fillColor('#ff4757')
            }
            .backgroundColor('transparent')
            .width(32)
            .height(32)
            .onClick(() => {
              this.showDeleteConfirmDialog(noteWithProblem.note.id);
            })
          }
        }
      }
      .width('100%')

      Row() {
        // ç¬”è®°å†…å®¹é¢„è§ˆ
        Text(noteWithProblem.note.content)
          .fontSize(14)
          .fontColor('#666666')
          .lineHeight(20)
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)
          .textAlign(TextAlign.Start)
        Blank().width(40)
        Button() {
          Text('æŸ¥çœ‹é¢˜ç›®')
            .fontSize(12)
            .fontColor(Color.White)
        }
        .backgroundColor('#ff4757')
        .borderRadius(16)
        .height(28)
        .padding({ left: 8, right: 8 })
        .onClick(() => {
          if (noteWithProblem.problem) {
            this.navigateToProblemDetail(noteWithProblem.problem.id);
          }
        })
      }.justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 2, color: '#00000008', offsetX: 0, offsetY: 1 })
    .onClick(() => {
      // ç‚¹å‡»ç¬”è®°æœ¬èº«è¿›å…¥ç¼–è¾‘æ¨¡å¼
      this.editNote(noteWithProblem);
    })
  }

  // åŠ è½½æ‰€æœ‰ç¬”è®°
  private async loadNotes(): Promise<void> {
    try {
      this.isLoading = true;
      console.info('ğŸ“ å¼€å§‹åŠ è½½å­¦ä¹ ç¬”è®°');

      // ä»æ•°æ®åº“è·å–æ‰€æœ‰ç¬”è®°
      this.allNotes = await this.userNoteDao.getAllNotes();
      console.info(`ğŸ“‹ æ‰¾åˆ° ${this.allNotes.length} æ¡ç¬”è®°`);

      // ä¸ºæ¯ä¸ªç¬”è®°å…³è”é¢˜ç›®ä¿¡æ¯
      this.notesWithProblems = [];
      for (const note of this.allNotes) {
        const problem = ProblemMockData.getProblemById(note.problemId);
        this.notesWithProblems.push({
          note: note,
          problem: problem
        });
      }

      // æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åº
      this.notesWithProblems.sort((a, b) => {
        return new Date(b.note.updatedAt).getTime() - new Date(a.note.updatedAt).getTime();
      });

      this.filterNotes();
      console.info('âœ… å­¦ä¹ ç¬”è®°åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('âŒ åŠ è½½å­¦ä¹ ç¬”è®°å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // è¿‡æ»¤ç¬”è®°
  private filterNotes(): void {
    console.info('ğŸ” å¼€å§‹è¿‡æ»¤ç¬”è®°ï¼Œæœç´¢æ–‡æœ¬:', this.searchText);
    
    if (this.searchText.trim() === '') {
      // åˆ›å»ºå®Œå…¨æ–°çš„æ•°ç»„å‰¯æœ¬ï¼Œç¡®ä¿çŠ¶æ€å˜åŒ–
      this.filteredNotes = this.notesWithProblems.map((item: NoteWithProblem): NoteWithProblem => {
        const noteWithProblem: NoteWithProblem = {
          note: item.note,
          problem: item.problem
        };
        return noteWithProblem;
      });
    } else {
      const searchLower = this.searchText.toLowerCase();
      this.filteredNotes = this.notesWithProblems
        .filter((noteWithProblem: NoteWithProblem): boolean => {
          const contentMatch = noteWithProblem.note.content.toLowerCase().includes(searchLower);
          const titleMatch = noteWithProblem.problem?.title.toLowerCase().includes(searchLower) || false;
          return contentMatch || titleMatch;
        })
        .map((item: NoteWithProblem): NoteWithProblem => {
          const noteWithProblem: NoteWithProblem = {
            note: item.note,
            problem: item.problem
          };
          return noteWithProblem;
        });
    }
    
    console.info('ğŸ” ç¬”è®°è¿‡æ»¤å®Œæˆï¼Œæ˜¾ç¤º', this.filteredNotes.length, 'æ¡ç¬”è®°');
    console.info('ğŸ” è¿‡æ»¤ç»“æœçš„ç¬¬ä¸€æ¡ç¬”è®°å†…å®¹:', JSON.stringify(this.filteredNotes[0]?.note));
  }

  // ç¼–è¾‘ç¬”è®°
  private editNote(noteWithProblem: NoteWithProblem): void {
    this.selectedNote = noteWithProblem;
    this.editingContent = noteWithProblem.note.content;
    this.isEditingNote = true;
    
    // æ˜¾ç¤ºç¼–è¾‘Sheet
    this.showEditSheet = true;
  }

  // æ„å»ºç¼–è¾‘Sheet
  @Builder
  buildEditSheet() {
    Column({ space: 16 }) {
      // æ ‡é¢˜
      Row() {
        Text('ç¼–è¾‘ç¬”è®°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Button('å–æ¶ˆ')
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('transparent')
          .onClick(() => {
            this.showEditSheet = false;
            this.isEditingNote = false;
            this.selectedNote = null;
          })
      }
      .width('100%')
      
      // é¢˜ç›®ä¿¡æ¯
      if (this.selectedNote?.problem) {
        Row({ space: 8 }) {
          Text('é¢˜ç›®ï¼š')
            .fontSize(14)
            .fontColor('#666666')
          
          Text(this.selectedNote.problem.title)
            .fontSize(14)
            .fontColor('#333333')
            .fontWeight(FontWeight.Medium)
            .layoutWeight(1)
        }
        .width('100%')
      }
      
      // ç¼–è¾‘åŒºåŸŸ
      Column({ space: 8 }) {
        Text('ç¬”è®°å†…å®¹')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
        
        TextArea({
          placeholder: 'è¯·è¾“å…¥ç¬”è®°å†…å®¹...',
          text: this.editingContent
        })
          .width('100%')
          .height(200)
          .fontSize(14)
          .backgroundColor('#f8f9fa')
          .borderRadius(8)
          .padding(12)
          .onChange((value: string) => {
            this.editingContent = value;
          })
      }
      .width('100%')
      
      // æ“ä½œæŒ‰é’®
      Row({ space: 12 }) {
        Button('ä¿å­˜')
          .layoutWeight(1)
          .height(40)
          .backgroundColor('#52c41a')
          .fontColor('#ffffff')
          .borderRadius(8)
          .enabled(this.editingContent.trim().length > 0)
          .opacity(this.editingContent.trim().length > 0 ? 1 : 0.5)
          .onClick(() => {
            this.saveEditedNote();
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
  }



  // ä¿å­˜ç¼–è¾‘çš„ç¬”è®°
  private async saveEditedNote(): Promise<void> {
    if (!this.selectedNote || this.editingContent.trim() === '') {
      promptAction.showToast({
        message: 'ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º',
        duration: 2000
      });
      return;
    }

    try {
      console.info('ğŸ”„ å¼€å§‹ä¿å­˜ç¬”è®°ï¼ŒåŸå†…å®¹:', this.selectedNote.note.content);
      console.info('ğŸ”„ æ–°å†…å®¹:', this.editingContent.trim());
      
      // æ›´æ–°ç¬”è®°å†…å®¹å’Œæ—¶é—´æˆ³
      this.selectedNote.note.updateContent(this.editingContent.trim());
      const updatedTimestamp = this.selectedNote.note.updatedAt; // ä¿å­˜æ›´æ–°åçš„æ—¶é—´æˆ³
      
      console.info('ğŸ”„ æ›´æ–°æ—¶é—´æˆ³:', updatedTimestamp);
      
      // ä¿å­˜åˆ°æ•°æ®åº“
      await this.userNoteDao.saveNote(this.selectedNote.note);
      
      console.info('âœ… ç¬”è®°ä¿å­˜åˆ°æ•°æ®åº“æˆåŠŸ');

      // åˆ›å»ºæ–°çš„ç¬”è®°å¯¹è±¡ä»¥ç¡®ä¿å¼•ç”¨å˜åŒ–ï¼Œä½¿ç”¨ç›¸åŒçš„æ—¶é—´æˆ³
      const updatedNote = new UserNoteModel();
      updatedNote.id = this.selectedNote.note.id;
      updatedNote.problemId = this.selectedNote.note.problemId;
      updatedNote.content = this.editingContent.trim();
      updatedNote.createdAt = this.selectedNote.note.createdAt;
      updatedNote.updatedAt = updatedTimestamp; // ä½¿ç”¨ç›¸åŒçš„æ—¶é—´æˆ³

      // æ›´æ–°æœ¬åœ°æ•°æ® - å®Œå…¨é‡å»ºæ•°ç»„ä»¥ç¡®ä¿çŠ¶æ€å˜åŒ–
      const index = this.notesWithProblems.findIndex(item => item.note.id === this.selectedNote!.note.id);
      if (index !== -1) {
        // åˆ›å»ºå®Œå…¨æ–°çš„æ•°ç»„å’Œå¯¹è±¡
        const updatedNotes = [...this.notesWithProblems];
        const updatedNoteWithProblem: NoteWithProblem = {
          note: updatedNote, // ä½¿ç”¨æ–°åˆ›å»ºçš„ç¬”è®°å¯¹è±¡
          problem: updatedNotes[index].problem
        };
        updatedNotes[index] = updatedNoteWithProblem;
        this.notesWithProblems = updatedNotes;
        
        console.info('âœ… æœ¬åœ°æ•°æ®æ›´æ–°å®Œæˆï¼Œæ–°å†…å®¹:', updatedNotes[index].note.content);
        console.info('âœ… æœ¬åœ°æ•°æ®æ›´æ–°æ—¶é—´:', updatedNotes[index].note.updatedAt);
      }

      // é‡æ–°æ’åºç¬”è®°ï¼ˆæŒ‰æ›´æ–°æ—¶é—´é™åºï¼‰
      this.notesWithProblems.sort((a, b) => {
        return new Date(b.note.updatedAt).getTime() - new Date(a.note.updatedAt).getTime();
      });

      // å¼ºåˆ¶é‡æ–°è¿‡æ»¤ç¬”è®°ä»¥æ›´æ–°æ˜¾ç¤º
      this.filterNotes();

      // é‡ç½®ç¼–è¾‘çŠ¶æ€
      this.isEditingNote = false;
      this.selectedNote = null;
      this.showEditSheet = false; // å…³é—­Sheet

      promptAction.showToast({
        message: 'ç¬”è®°ä¿å­˜æˆåŠŸ',
        duration: 2000
      });
    } catch (error) {
      console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
  private showDeleteConfirmDialog(noteId: number): void {
    AlertDialog.show({
      title: 'åˆ é™¤ç¬”è®°',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          console.info('ç”¨æˆ·å–æ¶ˆåˆ é™¤ç¬”è®°');
        }
      },
      secondaryButton: {
        value: 'åˆ é™¤',
        fontColor: '#ff4757',
        action: () => {
          this.deleteNote(noteId);
        }
      }
    });
  }

  // åˆ é™¤ç¬”è®°
  private async deleteNote(noteId: number): Promise<void> {
    try {
      await this.userNoteDao.deleteNote(noteId);

      // ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
      this.notesWithProblems = this.notesWithProblems.filter(item => item.note.id !== noteId);
      this.filterNotes();

      promptAction.showToast({
        message: 'ç¬”è®°å·²åˆ é™¤',
        duration: 2000
      });
    } catch (error) {
      console.error('åˆ é™¤ç¬”è®°å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  // è·³è½¬åˆ°é¢˜ç›®è¯¦æƒ…é¡µé¢
  private navigateToProblemDetail(problemId: number): void {
    router.pushUrl({
      url: 'pages/ProblemDetailPage',
      params: {
        problemId: problemId,
        fromNotes: true
      }
    }).catch((error: Error) => {
      console.error('è·³è½¬é¢˜ç›®è¯¦æƒ…å¤±è´¥:', error);
      promptAction.showToast({
        message: 'é¡µé¢è·³è½¬å¤±è´¥',
        duration: 2000
      });
    });
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  private formatDate(dateString: string): string {
    const date = new Date(dateString);
    const now = new Date();
    
    // è·å–å½“åœ°æ—¶é—´çš„å¹´æœˆæ—¥ï¼Œå¿½ç•¥æ—¶åˆ†ç§’
    const dateYear = date.getFullYear();
    const dateMonth = date.getMonth();
    const dateDay = date.getDate();
    
    const nowYear = now.getFullYear();
    const nowMonth = now.getMonth();
    const nowDay = now.getDate();
    
    // åˆ›å»ºå½“åœ°æ—¶é—´çš„æ—¥æœŸå¯¹è±¡ç”¨äºæ¯”è¾ƒï¼ˆåªæ¯”è¾ƒå¹´æœˆæ—¥ï¼‰
    const dateOnly = new Date(dateYear, dateMonth, dateDay);
    const nowOnly = new Date(nowYear, nowMonth, nowDay);
    
    const diffMs = nowOnly.getTime() - dateOnly.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    console.info(`ğŸ“… æ—¶é—´æ ¼å¼åŒ–è°ƒè¯•: åŸå§‹æ—¶é—´=${dateString}, è§£æå=${date.toLocaleString('zh-CN')}, å½“å‰æ—¶é—´=${now.toLocaleString('zh-CN')}, å¤©æ•°å·®=${diffDays}`);

    if (diffDays === 0) {
      // ä»Šå¤©
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `ä»Šå¤© ${hours}:${minutes}`;
    } else if (diffDays === 1) {
      // æ˜¨å¤©
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `æ˜¨å¤© ${hours}:${minutes}`;
    } else if (diffDays < 7) {
      // ä¸€å‘¨å†…
      return `${diffDays}å¤©å‰`;
    } else {
      // è¶…è¿‡ä¸€å‘¨
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      return `${month}-${day}`;
    }
  }
}
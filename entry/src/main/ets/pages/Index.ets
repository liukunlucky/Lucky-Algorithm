import { TodayPracticePage } from './TodayPracticePage';
import { LearningPathPage } from './LearningPathPage';
import { PracticeCenterPage } from './PracticeCenterPage';
import { ExamPage } from './ExamPage';
import { TabNavigationService } from '../service/TabNavigationService';
import { DatabaseHelper } from '../database/DatabaseHelper';
import { ProfilePage } from './ProfilePage';

@Entry
@Component
struct Index {
  @State currentTabIndex: number = 0;
  @State lastLearningPathVisit: number = 0; // è®°å½•ä¸Šæ¬¡è®¿é—®å­¦ä¹ è·¯çº¿çš„æ—¶é—´
  @StorageLink('switchToPracticeCenter') @Watch('onSwitchToPracticeCenter') switchTrigger: number = 0;
  @StorageLink('switchToTabIndex') @Watch('onSwitchToTab') switchToTabIndex: number = 0;
  private tabsController: TabsController = new TabsController();
  private tabNavigationService: TabNavigationService = TabNavigationService.getInstance();
  private static readonly REFRESH_THRESHOLD = 300000; // 5åˆ†é’Ÿå†…ä¸é‡å¤åˆ·æ–°

  aboutToAppear() {
    // ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
    this.ensureDatabaseInitialized();
  }

  private async ensureDatabaseInitialized(): Promise<void> {
    try {
      const dbHelper = DatabaseHelper.getInstance();
      const store = dbHelper.getStore();

      if (!store) {
        // å¦‚æœæ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
        console.info('Database not initialized, attempting to initialize...');
        await dbHelper.initDatabase(getContext(this));
        console.info('Database initialized successfully in Index page');
      }
    } catch (error) {
      console.error('Failed to ensure database initialization:', error);
    }
  }

  /**
   * ç›‘å¬Tabåˆ‡æ¢ä¿¡å·
   */
  onSwitchToTab() {
    if (this.switchToTabIndex >= 0) {
      console.info(`ğŸ”„ Indexæ¥æ”¶åˆ°Tabåˆ‡æ¢ä¿¡å·: ${this.switchToTabIndex}`);
      this.currentTabIndex = this.switchToTabIndex;
      this.tabsController.changeIndex(this.switchToTabIndex);
      this.tabNavigationService.setCurrentTabIndex(this.switchToTabIndex);
      
      console.info(`âœ… Tabåˆ‡æ¢å®Œæˆ: ${this.switchToTabIndex}`);
      // æ¸…é™¤è§¦å‘å™¨
      AppStorage.setOrCreate('switchToTabIndex', -1);
    }
  }

  /**
   * ç›‘å¬åˆ‡æ¢åˆ°ç»ƒä¹ ä¸­å¿ƒçš„è§¦å‘å™¨
   */
  onSwitchToPracticeCenter() {
    if (this.switchTrigger > 0) {
      this.currentTabIndex = 2; // åˆ‡æ¢åˆ°ç»ƒä¹ ä¸­å¿ƒTab
      this.tabsController.changeIndex(2);
      this.tabNavigationService.setCurrentTabIndex(2);
      
      // æ¸…é™¤è§¦å‘å™¨
      AppStorage.setOrCreate('switchToPracticeCenter', 0);
    }
  }

  build() {
    Tabs({ barPosition: BarPosition.End, controller: this.tabsController }) {
      // ä»Šæ—¥ç»ƒä¹ Tab
      TabContent() {
        TodayPracticePage()
      }
      .tabBar(this.buildTabBarItem($r('app.media.icon_home'), 'é¦–é¡µ', 0))

      // å­¦ä¹ è·¯çº¿Tab
      TabContent() {
        LearningPathPage()
      }
      .tabBar(this.buildTabBarItem($r('app.media.icon_route'), 'å­¦ä¹ è·¯çº¿', 1))

      // ç»ƒä¹ ä¸­å¿ƒTab
      TabContent() {
        PracticeCenterPage()
      }
      .tabBar(this.buildTabBarItem($r('app.media.icon_train_center'), 'ç»ƒä¹ ä¸­å¿ƒ', 2))

      // æ¨¡æ‹Ÿè€ƒæ ¸Tab
      TabContent() {
        ExamPage()
      }
      .tabBar(this.buildTabBarItem($r('app.media.icon_exam'), 'æ¨¡æ‹Ÿè€ƒæ ¸', 3))

      // æˆ‘çš„ç»Ÿè®¡Tab
      TabContent() {
        ProfilePage()
      }
      .tabBar(this.buildTabBarItem($r('app.media.icon_mine'), 'æˆ‘çš„', 4))
    }
    .animationDuration(300)
    .scrollable(false)
    .backgroundColor('#F8F9FA')
    .barMode(BarMode.Fixed)
    .barHeight(56)
    .onChange((index: number) => {
      this.currentTabIndex = index;
      this.tabNavigationService.setCurrentTabIndex(index);
      
      // å½“åˆ‡æ¢åˆ°å­¦ä¹ è·¯çº¿Tabæ—¶ï¼Œæ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ·æ–°
      if (index === 1) {
        const currentTime = Date.now();
        // åªæœ‰åœ¨è¶…è¿‡é—¾å€¼æ—¶é—´æˆ–é¦–æ¬¡è®¿é—®æ—¶æ‰è§¦å‘åˆ·æ–°
        if (this.lastLearningPathVisit === 0 || (currentTime - this.lastLearningPathVisit) > Index.REFRESH_THRESHOLD) {
          console.info('è§¦å‘å­¦ä¹ è·¯çº¿æ•°æ®åˆ·æ–°');
          AppStorage.setOrCreate('learningPathRefreshTrigger', currentTime);
          this.lastLearningPathVisit = currentTime;
        } else {
          console.info('è·³è¿‡å­¦ä¹ è·¯çº¿æ•°æ®åˆ·æ–°ï¼Œè·ç¦»ä¸Šæ¬¡è®¿é—®æ—¶é—´è¿‡çŸ­');
        }
      }
    })
  }

  @Builder
  buildTabBarItem(icon: Resource, title: string, index: number) {
    Column({ space: 4 }) {
      Image(icon)
        .width(20)
        .height(20)
        .fillColor(this.currentTabIndex === index ? '#F34F40' : '#999999')

      Text(title)
        .fontSize(10)
        .fontColor(this.currentTabIndex === index ? '#F34F40' : '#999999')
        .fontWeight(this.currentTabIndex === index ? FontWeight.Medium : FontWeight.Normal)
    }
    .width('100%')
    .height(56)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor('#F8F9FA')
  }
}
// ä½¿ç”¨æ•°æ®åº“æ•°æ®ï¼Œå¯¼å…¥ç›¸å…³DAOç±»
import { ProblemMockData } from '../mock/ProblemMockData';
import { UserProgressDao } from '../dao/UserProgressDao';
import { ProblemDao } from '../dao/ProblemDao';
import { router } from '@kit.ArkUI';
import { ProblemCategory } from '../model/ProblemModel';
import { pasteboard } from '@kit.BasicServicesKit';
import promptAction from '@ohos.promptAction';

// å¯¼å…¥hm_chartå›¾è¡¨ç»„ä»¶


interface StudyStats {
  totalSolved: number;
  continuousDays: number;
  totalStudyTime: number; // åˆ†é’Ÿ
  averageAccuracy: number; // ç™¾åˆ†æ¯”
  favoriteCount: number;
  wrongCount: number;
}

interface ChartDataset {
  label?: string;
  data: number[];
  backgroundColor?: string | string[];
  borderColor?: string;
  borderWidth?: number;
  borderRadius?: number;
  tension?: number;
}

interface ChartData {
  labels: string[];
  datasets: ChartDataset[];
}

interface CategoryProgress {
  categoryName: string;
  icon: Resource;
  solved: number;
  total: number;
  accuracy: number;
  color: string;
}

interface WeeklyData {
  date: string;
  solved: number;
}

// åˆ†ç±»é…ç½®æ¥å£
interface CategoryConfig {
  category: ProblemCategory;
  name: string;
  icon: Resource;
  color: string;
}

@Entry
@Component
struct StatisticsPage {
  @State studyStats: StudyStats = {
    totalSolved: 0,
    continuousDays: 0,
    totalStudyTime: 0,
    averageAccuracy: 0,
    favoriteCount: 0,
    wrongCount: 0
  };
  @State categoryProgress: CategoryProgress[] = [];
  @State weeklyData: WeeklyData[] = [];
  @State selectedTab: number = 0; // 0: æ€»è§ˆ, 1: åˆ†ç±», 2: è¶‹åŠ¿
  @State isLoading: boolean = false;
  
  // DAOå®ä¾‹
  private userProgressDao: UserProgressDao = new UserProgressDao();
  private problemDao: ProblemDao = new ProblemDao();

  aboutToAppear() {
    this.loadStatistics();
  }

  build() {
    Column() {
      // é¡µé¢æ ‡é¢˜
      this.buildHeader()
      Blank().height(16)
      // Tabåˆ‡æ¢
      this.buildTabBar()
      Blank().height(16)
      
      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column({ space: 16 }) {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#F34F40')
          
          Text('æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...')
            .fontSize(14)
            .fontColor('#666666')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // æ­£å¸¸å†…å®¹
        if (this.selectedTab === 0) {
          this.buildOverviewTab()
        } else if (this.selectedTab === 1) {
          this.buildCategoryTab()
        } else if (this.selectedTab === 2) {
          this.buildTrendTab()
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row({ space: 16 }) {
      // è¿”å›æŒ‰é’®
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(40)
      .height(40)
      .backgroundColor('transparent')
      .onClick(() => {
        router.back();
      })

      // æ ‡é¢˜
      Text('æˆ‘çš„ç»Ÿè®¡')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Blank().width(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildTabBar() {
    Row() {
      this.buildTabItem('æ€»è§ˆ', 0)
      this.buildTabItem('åˆ†ç±»', 1)
      this.buildTabItem('è¶‹åŠ¿', 2)
    }
    .margin(16)
    .height(44)
    .backgroundColor('#ffffff')
    .borderRadius(22)
    .shadow({ radius: 2, color: '#00000008', offsetX: 0, offsetY: 1 })
  }

  @Builder
  buildTabItem(title: string, index: number) {
    Text(title)
      .fontSize(14)
      .fontColor(this.selectedTab === index ? '#ffffff' : '#666666')
      .fontWeight(this.selectedTab === index ? FontWeight.Medium : FontWeight.Normal)
      .textAlign(TextAlign.Center)
      .layoutWeight(1)
      .height('100%')
      .backgroundColor(this.selectedTab === index ? '#F34F40' : 'transparent')
      .borderRadius(22)
      .onClick(() => {
        this.selectedTab = index;
      })
  }

  @Builder
  buildOverviewTab() {
    Column({ space: 16 }) {
      // æ ¸å¿ƒæ•°æ®å¡ç‰‡
      this.buildCoreStatsCard()

      // å­¦ä¹ æˆå°±
      this.buildAchievementsCard()

      // å¿«æ·æ“ä½œ
      this.buildQuickActions()
    }
    .width('100%')
    .padding({left: 16, right: 16})
    .layoutWeight(1)
  }

  @Builder
  buildCoreStatsCard() {
    Column({ space: 16 }) {
      Row({ space: 8 }) {
          Text('æ ¸å¿ƒæ•°æ®')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .alignSelf(ItemAlign.Start)

      Grid() {
        GridItem() {
          this.buildStatItem('å­¦ä¹ é¢˜æ•°', this.studyStats.totalSolved + 'é¢˜', $r('app.media.target_icon'), '#1890ff')
        }
        GridItem() {
          this.buildStatItem('è¿ç»­å­¦ä¹ ', this.studyStats.continuousDays + 'å¤©', $r('app.media.star_icon'), '#ff6b35')
        }
        GridItem() {
          this.buildStatItem('å­¦ä¹ æ—¶é•¿', this.formatStudyTime(this.studyStats.totalStudyTime), $r('app.media.star_icon'), '#52c41a')
        }
        GridItem() {
          this.buildStatItem('å¹³å‡æ­£ç¡®ç‡', this.studyStats.averageAccuracy + '%', $r('app.media.target_icon'), '#722ed1')
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .rowsGap(12)
      .columnsGap(12)
      .width('100%')
      .height(160)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildStatItem(title: string, value: string, _icon: Resource, color: string) {
    Column({ space: 8 }) {
      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor('#f8f9fa')
    .borderRadius(8)
  }

  @Builder
  buildAchievementsCard() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
          Text('å­¦ä¹ æˆå°±')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .alignSelf(ItemAlign.Start)

      Row({ space: 16 }) {
        this.buildAchievementItem('æ”¶è—é¢˜ç›®', this.studyStats.favoriteCount + 'é¢˜', $r('app.media.star_icon'), '#fa8c16')
        this.buildAchievementItem('é”™é¢˜å›é¡¾', this.studyStats.wrongCount + 'é¢˜', $r('app.media.note_icon'), '#f5222d')
        this.buildAchievementItem('å­¦ä¹ ç­‰çº§', this.getStudyLevel(), $r('app.media.target_icon'), '#13c2c2')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildAchievementItem(title: string, value: string, _icon: Resource, color: string) {
    Column({ space: 6 }) {
      Text(value)
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(title)
        .fontSize(12)
        .fontColor('#666666')
    }
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildQuickActions() {
    Row({ space: 12 }) {
      Button('æŸ¥çœ‹æ”¶è—')
        .layoutWeight(1)
        .height(40)
        .backgroundColor('#ffffff')
        .fontColor('#fa8c16')
        .border({ width: 1, color: '#fa8c16' })
        .borderRadius(8)
        .onClick(() => {
          this.navigateToFavorites();
        })

      Button('é”™é¢˜æœ¬')
        .layoutWeight(1)
        .height(40)
        .backgroundColor('#ffffff')
        .fontColor('#f5222d')
        .border({ width: 1, color: '#f5222d' })
        .borderRadius(8)
        .onClick(() => {
          this.navigateToWrongProblems();
        })

      Button('å­¦ä¹ æŠ¥å‘Š')
        .layoutWeight(1)
        .height(40)
        .backgroundColor('#1890ff')
        .fontColor('#ffffff')
        .borderRadius(8)
        .onClick(() => {
          this.generateReport();
        })
    }
    .width('100%')
  }

  @Builder
  buildCategoryTab() {
    Column({ space: 16 }) {
      Row({ space: 8 }) {
          Text('åˆ†ç±»è¿›åº¦')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .alignSelf(ItemAlign.Start)

      // // åˆ†ç±»å®Œæˆåº¦æŸ±çŠ¶å›¾
      // Column({ space: 12 }) {
      //   Text('å„åˆ†ç±»å®Œæˆåº¦å¯¹æ¯”')
      //     .fontSize(16)
      //     .fontWeight(FontWeight.Medium)
      //     .fontColor('#333333')
      //     .alignSelf(ItemAlign.Start)
      //
      //   // æš‚æ—¶ä½¿ç”¨ç®€å•çš„å›¾è¡¨æ›¿ä»£ï¼Œç­‰å¾…hm_chartç»„ä»¶ä¿®å¤
      //   Column({ space: 8 }) {
      //     Text('åˆ†ç±»å®Œæˆåº¦ç»Ÿè®¡')
      //       .fontSize(14)
      //       .fontColor('#666666')
      //
      //     // ç®€å•çš„è¿›åº¦æ¡å›¾è¡¨
      //     ForEach(this.categoryProgress.slice(0, 5), (category: CategoryProgress) => {
      //       Row({ space: 8 }) {
      //         Text(category.categoryName)
      //           .fontSize(12)
      //           .fontColor('#333333')
      //           .width(60)
      //
      //         Progress({
      //           value: category.solved,
      //           total: category.total,
      //           type: ProgressType.Linear
      //         })
      //         .width('100%')
      //         .height(8)
      //         .color(category.color)
      //         .backgroundColor('#f0f0f0')
      //         .layoutWeight(1)
      //
      //         Text(category.solved + '/' + category.total)
      //           .fontSize(12)
      //           .fontColor('#666666')
      //           .width(40)
      //       }
      //       .width('100%')
      //     }, (category: CategoryProgress) => category.categoryName)
      //   }
      //   .width('100%')
      //   .height(250)
      //   .justifyContent(FlexAlign.SpaceEvenly)
      // }
      // .width('100%')
      // .padding(16)
      // .backgroundColor('#ffffff')
      // .borderRadius(12)
      // .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })

      List({ space: 12 }) {
        ForEach(this.categoryProgress, (category: CategoryProgress) => {
          ListItem() {
            this.buildCategoryProgressCard(category)
          }
        }, (category: CategoryProgress) => category.categoryName)
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .padding({left: 16, right: 16})
    .layoutWeight(1)
  }

  @Builder
  buildCategoryProgressCard(category: CategoryProgress) {
    Row({ space: 12 }) {
      Column({ space: 6 }) {
        Row() {
          Text(category.categoryName)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')

          Blank()

          Text(category.solved + '/' + category.total)
            .fontSize(14)
            .fontColor('#666666')
        }
        .width('100%')

        Progress({
          value: category.solved,
          total: category.total,
          type: ProgressType.Linear
        })
        .width('100%')
        .height(6)
        .color(category.color)
        .backgroundColor('#f0f0f0')

        Row() {
          Text('å­¦ä¹ è¿›åº¦: ' + Math.round((category.solved / category.total) * 100) + '%')
            .fontSize(12)
            .fontColor('#666666')

          Blank()

          Text('æ­£ç¡®ç‡: ' + category.accuracy + '%')
            .fontSize(12)
            .fontColor('#666666')
        }
        .width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .shadow({ radius: 2, color: '#00000008', offsetX: 0, offsetY: 1 })
  }

  @Builder
  buildTrendTab() {
    Scroll() {
      Column({ space: 16 }) {
        Row({ space: 8 }) {
          Text('å­¦ä¹ è¶‹åŠ¿')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .alignSelf(ItemAlign.Start)

        // å‘¨å­¦ä¹ ç»Ÿè®¡
        this.buildWeeklyChart()

        // å­¦ä¹ å»ºè®®
        this.buildStudySuggestions()
      }
      .width('100%')
      .padding({left: 16, right: 16})
    }.layoutWeight(1)

  }

  @Builder
  buildWeeklyChart() {
    Column({ space: 16 }) {
      Text('è¿‘7å¤©å­¦ä¹ æƒ…å†µ')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .alignSelf(ItemAlign.Start)

      // æš‚æ—¶ä½¿ç”¨ç®€å•çš„è¶‹åŠ¿å›¾æ›¿ä»£
      Column({ space: 8 }) {
        Text('è¿‘7å¤©è§£é¢˜è¶‹åŠ¿')
          .fontSize(14)
          .fontColor('#666666')
        
        Row({ space: 4 }) {
          ForEach(this.weeklyData, (item: WeeklyData, index: number) => {
            Column({ space: 4 }) {
              // ç®€å•çš„æŸ±çŠ¶å›¾è¡¨ç¤º - ä¿®å¤å¯¹é½é—®é¢˜
              Column()
                .width(30)
                .height(Math.max(item.solved * 12, 5)) // è°ƒæ•´é«˜åº¦è®¡ç®—
                .backgroundColor('#1890ff')
                .borderRadius(2)
              
              Text(item.solved.toString())
                .fontSize(10)
                .fontColor('#333333')
              
              Text(item.date)
                .fontSize(10)
                .fontColor('#666666')
            }
            .justifyContent(FlexAlign.End)
            .height(100) // å›ºå®šé«˜åº¦ç¡®ä¿åº•éƒ¨å¯¹é½
          }, (item: WeeklyData) => item.date)
        }
        .width('100%')
        .height(120)
        .justifyContent(FlexAlign.SpaceEvenly)
        .alignItems(VerticalAlign.Bottom)
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)

      // åˆ†ç±»è¿›åº¦é¥¼å›¾
      Text('åˆ†ç±»å­¦ä¹ è¿›åº¦åˆ†å¸ƒ')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .alignSelf(ItemAlign.Start)
        .margin({ top: 16 })

      // æš‚æ—¶ä½¿ç”¨ç®€å•çš„åˆ†ç±»ç»Ÿè®¡æ›¿ä»£
      Column({ space: 8 }) {
        Text('åˆ†ç±»å­¦ä¹ è¿›åº¦åˆ†å¸ƒ')
          .fontSize(14)
          .fontColor('#666666')
        
        Grid() {
          ForEach(this.categoryProgress.slice(0, 6), (category: CategoryProgress) => {
            GridItem() {
              Column({ space: 4 }) {
                // åœ†å½¢è¿›åº¦æŒ‡ç¤ºå™¨
                Stack() {
                  Circle({ width: 40, height: 40 })
                    .fill('#f0f0f0')
                  
                  Circle({ width: 40, height: 40 })
                    .fill('transparent')
                    .stroke(category.color)
                    .strokeWidth(4)
                    .strokeDashArray([
                      (category.solved / category.total) * 125, 
                      125 - (category.solved / category.total) * 125
                    ])
                  
                  Text(Math.round((category.solved / category.total) * 100) + '%')
                    .fontSize(8)
                    .fontColor('#333333')
                }
                .width(40)
                .height(40)
                
                Text(category.categoryName)
                  .fontSize(10)
                  .fontColor('#333333')
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .width('100%')
              .alignItems(HorizontalAlign.Center)
            }
          }, (category: CategoryProgress) => category.categoryName)
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsTemplate('1fr 1fr')
        .width('100%')
        .height(120)
        .columnsGap(8)
        .rowsGap(8)
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)

      // å­¦ä¹ æ—¶é—´æŸ±çŠ¶å›¾
      Text('æ¯æ—¥å­¦ä¹ æ—¶é•¿ç»Ÿè®¡')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .alignSelf(ItemAlign.Start)
        .margin({ top: 16 })

      // æš‚æ—¶ä½¿ç”¨ç®€å•çš„æŸ±çŠ¶å›¾æ›¿ä»£
      Column({ space: 8 }) {
        Text('æ¯æ—¥å­¦ä¹ æ—¶é•¿ç»Ÿè®¡')
          .fontSize(14)
          .fontColor('#666666')
        
        Row({ space: 4 }) {
          ForEach(this.weeklyData, (item: WeeklyData, index: number) => {
            Column({ space: 4 }) {
              // æŸ±çŠ¶å›¾ - ä¿®å¤å¯¹é½é—®é¢˜ï¼Œä½¿ç”¨çœŸå®æ•°æ®
              Column()
                .width(30)
                .height(Math.max(item.solved * 15, 5)) // ä½¿ç”¨çœŸå®æ•°æ®ï¼Œé«˜åº¦åŸºäºè§£é¢˜æ•°
                .backgroundColor(['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'][index])
                .borderRadius(2)
              
              Text(item.solved + 'é¢˜')
                .fontSize(9)
                .fontColor('#333333')
              
              Text(item.date)
                .fontSize(10)
                .fontColor('#666666')
            }
            .justifyContent(FlexAlign.End)
            .height(120) // å›ºå®šé«˜åº¦ç¡®ä¿åº•éƒ¨å¯¹é½
          }, (item: WeeklyData) => item.date)
        }
        .width('100%')
        .height(140)
        .justifyContent(FlexAlign.SpaceEvenly)
        .alignItems(VerticalAlign.Bottom)
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildStudySuggestions() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
          Text('å­¦ä¹ å»ºè®®')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
        }
        .alignSelf(ItemAlign.Start)

      Column({ space: 8 }) {
        this.buildSuggestionItem('ä¿æŒæ¯æ—¥ç»ƒä¹ ä¹ æƒ¯ï¼Œè¿ç»­å­¦ä¹ æ•ˆæœæ›´ä½³')
        this.buildSuggestionItem('é‡ç‚¹å…³æ³¨é”™è¯¯ç‡è¾ƒé«˜çš„ç®—æ³•åˆ†ç±»')
        this.buildSuggestionItem('å®šæœŸå¤ä¹ å·²å®Œæˆçš„é¢˜ç›®ï¼Œå·©å›ºçŸ¥è¯†ç‚¹')
        this.buildSuggestionItem('å°è¯•æŒ‘æˆ˜æ›´é«˜éš¾åº¦çš„é¢˜ç›®')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  @Builder
  buildSuggestionItem(text: string) {
    Row({ space: 8 }) {
      Text('â€¢')
        .fontSize(14)
        .fontColor('#1890ff')

      Text(text)
        .fontSize(14)
        .fontColor('#666666')
        .layoutWeight(1)
    }
    .width('100%')
    .alignItems(VerticalAlign.Center)
  }

  private async loadStatistics(): Promise<void> {
    try {
      this.isLoading = true;
      console.info('ğŸ“Š å¼€å§‹åŠ è½½ç»Ÿè®¡æ•°æ®');
      
      // ä»æ•°æ®åº“åŠ è½½çœŸå®ç»Ÿè®¡æ•°æ®
      await this.loadStudyStatistics();
      await this.loadCategoryProgress();
      await this.loadWeeklyData();
      
      console.info('âœ… ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('âŒ åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      // ä½¿ç”¨é»˜è®¤æ•°æ®ä½œä¸ºé™çº§æ–¹æ¡ˆ
      this.setDefaultData();
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½å­¦ä¹ ç»Ÿè®¡æ•°æ®
   */
  private async loadStudyStatistics(): Promise<void> {
    try {
      // è·å–å­¦ä¹ è¿›åº¦æ•°ï¼ˆåŒ…æ‹¬ç­”å¯¹å’Œç­”é”™çš„é¢˜ç›®ï¼‰
      const totalStudied = await this.userProgressDao.getStudyProgressCount();
      
      // è·å–è¿ç»­å­¦ä¹ å¤©æ•°
      const continuousDays = await this.userProgressDao.getContinuousDays();
      
      // è·å–ä»Šæ—¥å­¦ä¹ æ•°ï¼ˆåŒ…æ‹¬ç­”å¯¹å’Œç­”é”™ï¼‰
      const todayCompleted = await this.userProgressDao.getTodayCompletedCount();
      
      // è·å–æ”¶è—é¢˜ç›®æ•°
      const favoriteProblems = await this.userProgressDao.getFavoriteProblems();
      
      // è·å–é”™é¢˜æ•°
      const wrongProblems = await this.userProgressDao.getWrongProblems();
      
      // è·å–ç»Ÿè®¡ä¿¡æ¯ï¼ˆåŒ…æ‹¬å‡†ç¡®ç‡ï¼‰
      const statistics = await this.userProgressDao.getStatistics();
      
      // è®¡ç®—å­¦ä¹ æ—¶é•¿ï¼ˆæš‚æ—¶ä½¿ç”¨ä¼°ç®—ï¼šæ¯é¢˜å¹³å‡5åˆ†é’Ÿï¼‰
      const estimatedStudyTime = totalStudied * 5;
      
      this.studyStats = {
        totalSolved: totalStudied, // ä¿®æ”¹ï¼šä½¿ç”¨å­¦ä¹ è¿›åº¦æ•°ï¼ˆåŒ…æ‹¬ç­”å¯¹å’Œç­”é”™ï¼‰
        continuousDays: continuousDays,
        totalStudyTime: estimatedStudyTime,
        averageAccuracy: statistics.overallAccuracy,
        favoriteCount: favoriteProblems.length,
        wrongCount: wrongProblems.length
      };
      
      console.info('ğŸ“ˆ å­¦ä¹ ç»Ÿè®¡æ•°æ®:', this.studyStats);
      console.info('ğŸ¯ å­¦ä¹ è¿›åº¦æ•°ï¼ˆåŒ…æ‹¬ç­”å¯¹å’Œç­”é”™ï¼‰:', totalStudied);
      console.info('ğŸ¯ æ­£ç¡®ç‡:', statistics.overallAccuracy + '%');
    } catch (error) {
      console.error('âŒ åŠ è½½å­¦ä¹ ç»Ÿè®¡å¤±è´¥:', error);
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      throw new Error('åŠ è½½å­¦ä¹ ç»Ÿè®¡å¤±è´¥: ' + errorMessage);
    }
  }

  /**
   * åŠ è½½åˆ†ç±»è¿›åº¦æ•°æ®
   */
  private async loadCategoryProgress(): Promise<void> {
    try {
      const categories: CategoryConfig[] = [
        { category: ProblemCategory.ARRAY, name: 'æ•°ç»„', icon: $r('app.media.chart_icon'), color: '#1890ff' },
        { category: ProblemCategory.STRING, name: 'å­—ç¬¦ä¸²', icon: $r('app.media.note_icon'), color: '#52c41a' },
        { category: ProblemCategory.LINKED_LIST, name: 'é“¾è¡¨', icon: $r('app.media.link_icon'), color: '#fa8c16' },
        { category: ProblemCategory.BINARY_TREE, name: 'äºŒå‰æ ‘', icon: $r('app.media.tree_icon'), color: '#13c2c2' },
        { category: ProblemCategory.TWO_POINTERS, name: 'åŒæŒ‡é’ˆ', icon: $r('app.media.target_icon'), color: '#722ed1' },
        { category: ProblemCategory.BINARY_SEARCH, name: 'äºŒåˆ†æŸ¥æ‰¾', icon: $r('app.media.search_icon'), color: '#eb2f96' },
        { category: ProblemCategory.MATH, name: 'æ•°å­¦', icon: $r('app.media.computer_icon'), color: '#f5222d' },
        { category: ProblemCategory.DYNAMIC_PROGRAMMING, name: 'åŠ¨æ€è§„åˆ’', icon: $r('app.media.laptop_icon'), color: '#fa541c' },
        { category: ProblemCategory.STACK, name: 'æ ˆ', icon: $r('app.media.book_icon'), color: '#faad14' },
        { category: ProblemCategory.HASH_TABLE, name: 'å“ˆå¸Œè¡¨', icon: $r('app.media.computer_icon'), color: '#52c41a' },
        { category: ProblemCategory.BACKTRACKING, name: 'å›æº¯', icon: $r('app.media.star_icon'), color: '#13c2c2' },
        { category: ProblemCategory.GREEDY, name: 'è´ªå¿ƒ', icon: $r('app.media.target_icon'), color: '#722ed1' },
        { category: ProblemCategory.BIT_MANIPULATION, name: 'ä½è¿ç®—', icon: $r('app.media.computer_icon'), color: '#eb2f96' },
        { category: ProblemCategory.DESIGN, name: 'è®¾è®¡', icon: $r('app.media.computer_icon'), color: '#f5222d' },
        { category: ProblemCategory.DIVIDE_CONQUER, name: 'åˆ†æ²»', icon: $r('app.media.star_icon'), color: '#fa541c' },
        { category: ProblemCategory.SLIDING_WINDOW, name: 'æ»‘åŠ¨çª—å£', icon: $r('app.media.chart_icon'), color: '#1890ff' },
        { category: ProblemCategory.PREFIX_SUM, name: 'å‰ç¼€å’Œ', icon: $r('app.media.chart_icon'), color: '#faad14' },
        { category: ProblemCategory.MONOTONIC_STACK, name: 'å•è°ƒæ ˆ', icon: $r('app.media.book_icon'), color: '#52c41a' },
        { category: ProblemCategory.TRIE, name: 'å­—å…¸æ ‘', icon: $r('app.media.tree_icon'), color: '#13c2c2' },
        { category: ProblemCategory.GRAPH, name: 'å›¾', icon: $r('app.media.map_icon'), color: '#722ed1' },
        { category: ProblemCategory.SORT, name: 'æ’åº', icon: $r('app.media.target_icon'), color: '#eb2f96' }
      ];
      
      const progressList: CategoryProgress[] = [];
      
      for (const categoryConfig of categories) {
        // è·å–è¯¥åˆ†ç±»çš„æ€»é¢˜ç›®æ•°
        const allProblems = ProblemMockData.getAllProblems();
        const totalProblems = allProblems.filter(p => p.category === categoryConfig.category).length;
        
        // è·å–è¯¥åˆ†ç±»çš„å­¦ä¹ è¿›åº¦æ•°ï¼ˆåŒ…æ‹¬ç­”å¯¹å’Œç­”é”™çš„é¢˜ç›®ï¼‰
        const studiedCount = await this.userProgressDao.getStudyProgressCountByCategory(categoryConfig.category);
        
        // è·å–è¯¥åˆ†ç±»çš„æ­£ç¡®ç‡
        const accuracy = await this.userProgressDao.getAccuracyByCategory(categoryConfig.category);
        
        const progress: CategoryProgress = {
          categoryName: categoryConfig.name,
          icon: categoryConfig.icon,
          solved: studiedCount, // ä¿®æ”¹ï¼šä½¿ç”¨å­¦ä¹ è¿›åº¦æ•°è€Œä¸æ˜¯åªè®¡ç®—ç­”å¯¹çš„
          total: totalProblems,
          accuracy: accuracy, // ä¿®æ”¹ï¼šä½¿ç”¨çœŸå®çš„æ­£ç¡®ç‡è®¡ç®—
          color: categoryConfig.color
        };
        
        progressList.push(progress);
      }
      
      this.categoryProgress = progressList;
      console.info('ğŸ“Š åˆ†ç±»è¿›åº¦æ•°æ®:', this.categoryProgress);
    } catch (error) {
      console.error('âŒ åŠ è½½åˆ†ç±»è¿›åº¦å¤±è´¥:', error);
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      throw new Error('åŠ è½½åˆ†ç±»è¿›åº¦å¤±è´¥: ' + errorMessage);
    }
  }

  /**
   * åŠ è½½å‘¨å­¦ä¹ æ•°æ®
   */
  private async loadWeeklyData(): Promise<void> {
    try {
      // ç”Ÿæˆè¿‘7å¤©çš„æ•°æ®
      const weeklyData: WeeklyData[] = [];
      const today = new Date();
      const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        
        // è·å–è¯¥æ—¥æœŸçš„å®Œæˆé¢˜ç›®æ•°ï¼ˆä»æ•°æ®åº“æŸ¥è¯¢çœŸå®æ•°æ®ï¼‰
        const solved = await this.userProgressDao.getCompletedCountByDate(date);
        
        weeklyData.push({
          date: dayNames[date.getDay()],
          solved: solved
        });
      }
      
      this.weeklyData = weeklyData;
      console.info('ğŸ“… å‘¨å­¦ä¹ æ•°æ®:', this.weeklyData);
    } catch (error) {
      console.error('âŒ åŠ è½½å‘¨å­¦ä¹ æ•°æ®å¤±è´¥:', error);
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      throw new Error('åŠ è½½å‘¨å­¦ä¹ æ•°æ®å¤±è´¥: ' + errorMessage);
    }
  }

  /**
   * è®¾ç½®é»˜è®¤æ•°æ®ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
   */
  private setDefaultData(): void {
    console.info('ğŸ¯ ä½¿ç”¨é»˜è®¤ç»Ÿè®¡æ•°æ®');
    this.studyStats = {
      totalSolved: 0,
      continuousDays: 0,
      totalStudyTime: 0,
      averageAccuracy: 0,
      favoriteCount: 0,
      wrongCount: 0
    };

    this.categoryProgress = [
      { categoryName: 'æ•°ç»„', icon: $r('app.media.chart_icon'), solved: 0, total: 10, accuracy: 0, color: '#1890ff' },
      { categoryName: 'é“¾è¡¨', icon: $r('app.media.link_icon'), solved: 0, total: 10, accuracy: 0, color: '#52c41a' },
      { categoryName: 'æ ˆ', icon: $r('app.media.book_icon'), solved: 0, total: 10, accuracy: 0, color: '#fa8c16' },
      { categoryName: 'äºŒå‰æ ‘', icon: $r('app.media.tree_icon'), solved: 0, total: 10, accuracy: 0, color: '#13c2c2' },
      { categoryName: 'å›¾', icon: $r('app.media.map_icon'), solved: 0, total: 10, accuracy: 0, color: '#722ed1' },
      { categoryName: 'åŠ¨æ€è§„åˆ’', icon: $r('app.media.laptop_icon'), solved: 0, total: 10, accuracy: 0, color: '#eb2f96' },
      { categoryName: 'è´ªå¿ƒ', icon: $r('app.media.target_icon'), solved: 0, total: 10, accuracy: 0, color: '#f5222d' },
      { categoryName: 'å›æº¯', icon: $r('app.media.star_icon'), solved: 0, total: 10, accuracy: 0, color: '#fa541c' }
    ];

    this.weeklyData = [
      { date: 'å‘¨ä¸€', solved: 0 },
      { date: 'å‘¨äºŒ', solved: 0 },
      { date: 'å‘¨ä¸‰', solved: 0 },
      { date: 'å‘¨å››', solved: 0 },
      { date: 'å‘¨äº”', solved: 0 },
      { date: 'å‘¨å…­', solved: 0 },
      { date: 'å‘¨æ—¥', solved: 0 }
    ];
  }

  private formatStudyTime(minutes: number): string {
    if (minutes < 60) {
      return minutes + 'åˆ†é’Ÿ';
    } else {
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;
      return hours + 'å°æ—¶' + (remainingMinutes > 0 ? remainingMinutes + 'åˆ†é’Ÿ' : '');
    }
  }

  private getStudyLevel(): string {
    const solved = this.studyStats.totalSolved;
    if (solved < 10) return 'æ–°æ‰‹';
    if (solved < 30) return 'å…¥é—¨';
    if (solved < 60) return 'è¿›é˜¶';
    if (solved < 100) return 'ç†Ÿç»ƒ';
    return 'ä¸“å®¶';
  }

  // è·å–å‘¨å­¦ä¹ è¶‹åŠ¿å›¾è¡¨æ•°æ®
  private getWeeklyChartData(): ChartData {
    const result: ChartData = {
      labels: this.weeklyData.map((item: WeeklyData): string => item.date),
      datasets: []
    };
    
    const dataset: ChartDataset = {
      label: 'æ¯æ—¥è§£é¢˜æ•°',
      data: this.weeklyData.map((item: WeeklyData): number => item.solved),
      borderColor: '#1890ff',
      backgroundColor: 'rgba(24, 144, 255, 0.1)',
      tension: 0.4
    };
    result.datasets.push(dataset);
    
    return result;
  }

  // è·å–åˆ†ç±»è¿›åº¦é¥¼å›¾æ•°æ®
  private getCategoryPieData(): ChartData {
    const completedCategories: CategoryProgress[] = this.categoryProgress.filter((cat: CategoryProgress): boolean => cat.solved > 0);
    
    const result: ChartData = {
      labels: completedCategories.map((cat: CategoryProgress): string => cat.categoryName),
      datasets: []
    };
    
    const dataset: ChartDataset = {
      data: completedCategories.map((cat: CategoryProgress): number => cat.solved),
      backgroundColor: completedCategories.map((cat: CategoryProgress): string => cat.color),
      borderWidth: 2,
      borderColor: '#ffffff'
    };
    result.datasets.push(dataset);
    
    return result;
  }

  // è·å–å­¦ä¹ æ—¶é—´æŸ±çŠ¶å›¾æ•°æ®
  private getStudyTimeBarData(): ChartData {
    // æ¨¡æ‹Ÿæ¯æ—¥å­¦ä¹ æ—¶é—´æ•°æ®ï¼ˆåˆ†é’Ÿï¼‰
    const dailyStudyTime: number[] = [45, 60, 30, 75, 90, 40, 35];
    const days: string[] = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
    
    const result: ChartData = {
      labels: days,
      datasets: []
    };
    
    const colors: string[] = [
      '#ff6b6b', '#4ecdc4', '#45b7d1', 
      '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'
    ];
    
    const dataset: ChartDataset = {
      label: 'å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)',
      data: dailyStudyTime,
      backgroundColor: colors,
      borderRadius: 4
    };
    result.datasets.push(dataset);
    
    return result;
  }

  // è·å–åˆ†ç±»å®Œæˆåº¦æŸ±çŠ¶å›¾æ•°æ®
  private getCategoryBarData(): ChartData {
    const result: ChartData = {
      labels: this.categoryProgress.map((cat: CategoryProgress): string => cat.categoryName),
      datasets: []
    };
    
    const dataset1: ChartDataset = {
      label: 'å·²å®Œæˆ',
      data: this.categoryProgress.map((cat: CategoryProgress): number => cat.solved),
      backgroundColor: this.categoryProgress.map((cat: CategoryProgress): string => cat.color),
      borderRadius: 4
    };
    result.datasets.push(dataset1);
    
    const dataset2: ChartDataset = {
      label: 'æ€»é¢˜æ•°',
      data: this.categoryProgress.map((cat: CategoryProgress): number => cat.total),
      backgroundColor: this.categoryProgress.map((cat: CategoryProgress): string => cat.color + '30'),
      borderRadius: 4
    };
    result.datasets.push(dataset2);
    
    return result;
  }

  private navigateToFavorites(): void {
    // å¯¼èˆªåˆ°æ”¶è—é¡µé¢
    router.pushUrl({
      url: 'pages/FavoritesPage'
    }).then(() => {
      console.info('âœ… æˆåŠŸå¯¼èˆªåˆ°æ”¶è—é¡µé¢');
    }).catch((error: Error) => {
      console.error('âŒ å¯¼èˆªåˆ°æ”¶è—é¡µé¢å¤±è´¥:', error);
    });
  }

  private navigateToWrongProblems(): void {
    // å¯¼èˆªåˆ°é”™é¢˜æœ¬
    router.pushUrl({
      url: 'pages/WrongProblemsPage'
    }).then(() => {
      console.info('âœ… æˆåŠŸå¯¼èˆªåˆ°é”™é¢˜æœ¬é¡µé¢');
    }).catch((error: Error) => {
      console.error('âŒ å¯¼èˆªåˆ°é”™é¢˜æœ¬é¡µé¢å¤±è´¥:', error);
    });
  }

  private generateReport(): void {
    try {
      console.info('ğŸ“Š å¼€å§‹ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š');
      
      // ç”ŸæˆæŠ¥å‘Šå†…å®¹
      const reportContent = this.buildReportContent();
      
      // æ˜¾ç¤ºæŠ¥å‘Šå¯¹è¯æ¡†
      this.showReportDialog(reportContent);
      
      console.info('âœ… å­¦ä¹ æŠ¥å‘Šç”Ÿæˆå®Œæˆ');
    } catch (error) {
      console.error('âŒ ç”Ÿæˆå­¦ä¹ æŠ¥å‘Šå¤±è´¥:', error);
    }
  }

  /**
   * æ„å»ºæŠ¥å‘Šå†…å®¹
   */
  private buildReportContent(): string {
    const stats = this.studyStats;
    const topCategories = this.categoryProgress
      .filter(cat => cat.solved > 0)
      .sort((a, b) => b.solved - a.solved)
      .slice(0, 3);
    
    const currentDate = new Date().toLocaleDateString('zh-CN');
    
    let report = `ğŸ“Š å­¦ä¹ æŠ¥å‘Š\n\n`;
    report += `ğŸ“… æŠ¥å‘Šæ—¥æœŸï¼š${currentDate}\n\n`;
    
    // æ ¸å¿ƒæ•°æ®
    report += `ğŸ¯ æ ¸å¿ƒæˆå°±ï¼š\n`;
    report += `â€¢ å­¦ä¹ é¢˜æ•°ï¼š${stats.totalSolved}é¢˜\n`;
    report += `â€¢ è¿ç»­å­¦ä¹ ï¼š${stats.continuousDays}å¤©\n`;
    report += `â€¢ å­¦ä¹ æ—¶é•¿ï¼š${this.formatStudyTime(stats.totalStudyTime)}\n`;
    report += `â€¢ å¹³å‡æ­£ç¡®ç‡ï¼š${stats.averageAccuracy}%\n\n`;
    
    // å­¦ä¹ ç­‰çº§
    report += `ğŸ† å­¦ä¹ ç­‰çº§ï¼š${this.getStudyLevel()}\n\n`;
    
    // æ”¶è—å’Œé”™é¢˜
    report += `ğŸ“‚ å­¦ä¹ ç®¡ç†ï¼š\n`;
    report += `â€¢ æ”¶è—é¢˜ç›®ï¼š${stats.favoriteCount}é¢˜\n`;
    report += `â€¢ é”™é¢˜æ•°é‡ï¼š${stats.wrongCount}é¢˜\n\n`;
    
    // ä¼˜åŠ¿åˆ†ç±»
    if (topCategories.length > 0) {
      report += `ğŸ”¥ ä¼˜åŠ¿åˆ†ç±»ï¼š\n`;
      topCategories.forEach((cat, index) => {
        report += `${index + 1}. ${cat.categoryName}: ${cat.solved}/${cat.total}é¢˜ (å­¦ä¹ è¿›åº¦${Math.round((cat.solved/cat.total)*100)}%, æ­£ç¡®ç‡${cat.accuracy}%)\n`;
      });
      report += `\n`;
    }
    
    // å­¦ä¹ å»ºè®®
    report += `ğŸ“ å­¦ä¹ å»ºè®®ï¼š\n`;
    if (stats.continuousDays < 7) {
      report += `â€¢ å»ºè®®ä¿æŒæ¯æ—¥ç»ƒä¹ ï¼Œæé«˜è¿ç»­å­¦ä¹ å¤©æ•°\n`;
    }
    if (stats.wrongCount > 0) {
      report += `â€¢ å…³æ³¨é”™é¢˜æœ¬ï¼ŒåŠæ—¶å¤ä¹ é”™è¯¯é¢˜ç›®\n`;
    }
    if (stats.averageAccuracy < 80) {
      report += `â€¢ éœ€è¦åŠ å¼ºç»ƒä¹ ï¼Œæé«˜è§£é¢˜å‡†ç¡®ç‡\n`;
    }
    report += `â€¢ å°è¯•æŒ‘æˆ˜æ›´é«˜éš¾åº¦çš„é¢˜ç›®ï¼Œæ‹“å±•çŸ¥è¯†é¢\n`;
    
    return report;
  }

  /**
   * æ˜¾ç¤ºæŠ¥å‘Šå¯¹è¯æ¡†
   */
  private showReportDialog(content: string): void {
    // è¿™é‡Œä½¿ç”¨ç®€å•çš„æç¤ºï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨æ›´ç¾è§‚çš„å¯¹è¯æ¡†
    AlertDialog.show({
      title: 'ğŸ“Š å­¦ä¹ æŠ¥å‘Š',
      message: content,
      autoCancel: true,
      alignment: DialogAlignment.Center,
      primaryButton: {
        value: 'å…³é—­',
        action: () => {
          console.info('å…³é—­å­¦ä¹ æŠ¥å‘Šå¯¹è¯æ¡†');
        }
      },
      secondaryButton: {
        value: 'å¤åˆ¶æŠ¥å‘Š',
        action: () => {
          this.copyReportToClipboard(content);
        }
      }
    });
  }

  /**
   * å¤åˆ¶æŠ¥å‘Šåˆ°å‰ªè´´æ¿
   */
  private copyReportToClipboard(content: string): void {
    try {
      // åˆ›å»ºå‰ªè´´æ¿æ•°æ®
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, content);
      
      // è·å–ç³»ç»Ÿå‰ªè´´æ¿
      const systemPasteboard = pasteboard.getSystemPasteboard();
      
      // å°†æ•°æ®å†™å…¥å‰ªè´´æ¿
      systemPasteboard.setData(pasteData).then(() => {
        console.info('âœ… å­¦ä¹ æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        promptAction.showToast({
          message: 'å­¦ä¹ æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ ğŸ“‹',
          duration: 2000
        });
      }).catch((error: Error) => {
        console.error('âŒ å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        promptAction.showToast({
          message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•',
          duration: 2000
        });
      });
    } catch (error) {
      console.error('âŒ åˆ›å»ºå‰ªè´´æ¿æ•°æ®å¤±è´¥:', error);
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      promptAction.showToast({
        message: 'å¤åˆ¶åŠŸèƒ½æš‚ä¸å¯ç”¨',
        duration: 2000
      });
    }
  }
}
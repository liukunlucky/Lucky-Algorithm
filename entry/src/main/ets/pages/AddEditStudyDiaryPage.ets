import { StudyDiaryModel, DiaryMood } from '../model/StudyDiaryModel';
import { StudyDiaryDao } from '../dao/StudyDiaryDao';
import { TimeUtils } from '../utils/TimeUtils';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

interface MoodOption {
  mood: DiaryMood;
  emoji: string;
  text: string;
}

@Entry
@Component
struct AddEditStudyDiaryPage {
  @State isEditMode: boolean = false;
  @State diaryId: number = 0;
  @State isLoading: boolean = false;
  
  // è¡¨å•æ•°æ®
  @State formTitle: string = '';
  @State formContent: string = '';
  @State formMood: DiaryMood = DiaryMood.NORMAL;
  @State formStudyDuration: string = '';
  @State formProblemsSolved: string = '';
  @State formTags: string = '';

  private studyDiaryDao: StudyDiaryDao = new StudyDiaryDao();

  async aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params.diary) {
      this.isEditMode = true;
      const diary = params.diary as StudyDiaryModel;
      this.diaryId = diary.id;
      this.formTitle = diary.title;
      this.formContent = diary.content;
      this.formMood = diary.mood;
      this.formStudyDuration = diary.studyDuration.toString();
      this.formProblemsSolved = diary.problemsSolved.toString();
      this.formTags = diary.tags;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()

      // è¡¨å•å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          this.buildDiaryForm()
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)

      // åº•éƒ¨æŒ‰é’®åŒºåŸŸ
      this.buildBottomButtons()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  buildHeader() {
    Row() {
      // è¿”å›æŒ‰é’®
      Row({ space: 8 }) {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }.width(40).justifyContent(FlexAlign.Start)
      .onClick(() => {
        router.back();
      })

      // æ ‡é¢˜
      Text(this.isEditMode ? 'ç¼–è¾‘å­¦ä¹ æ—¥è®°' : 'å†™å­¦ä¹ æ—¥è®°')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333') .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // ä¿å­˜æŒ‰é’®
      Text('ä¿å­˜')
        .fontSize(16)
        .fontColor('#F34F40')
        .onClick(() => {
          this.saveDiary();
        }).width(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .border({ width: { bottom: 1 }, color: '#E5E5E5' })
  }

  @Builder
  buildDiaryForm() {
    Column({ space: 20 }) {
      // æ—¥è®°æ ‡é¢˜ - å¿…å¡«é¡¹
      Column({ space: 8 }) {
        Row() {
          Text('æ ‡é¢˜')
            .fontSize(14)
            .fontColor('#333333')
          
          Text(' *')
            .fontSize(14)
            .fontColor('#FF4444')
        }
        .alignSelf(ItemAlign.Start)

        TextInput({ placeholder: 'è¯·è¾“å…¥æ—¥è®°æ ‡é¢˜', text: this.formTitle })
          .fontSize(14)
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 12, bottom: 12 })
          .border({ width: 1, color: '#E5E5E5' })
          .onChange((value: string) => {
            this.formTitle = value;
          })
      }

      // å¿ƒæƒ…é€‰æ‹© - å¿…å¡«é¡¹
      Column({ space: 8 }) {
        Row() {
          Text('ä»Šæ—¥å¿ƒæƒ…')
            .fontSize(14)
            .fontColor('#333333')
          
          Text(' *')
            .fontSize(14)
            .fontColor('#FF4444')
        }
        .alignSelf(ItemAlign.Start)

        Row({ space: 12 }) {
          ForEach([
            { mood: DiaryMood.EXCELLENT, emoji: 'ğŸ˜„', text: 'éå¸¸å¥½' },
            { mood: DiaryMood.GOOD, emoji: 'ğŸ˜Š', text: 'è‰¯å¥½' },
            { mood: DiaryMood.NORMAL, emoji: 'ğŸ˜', text: 'ä¸€èˆ¬' },
            { mood: DiaryMood.BAD, emoji: 'ğŸ˜”', text: 'ä¸å¥½' },
            { mood: DiaryMood.TERRIBLE, emoji: 'ğŸ˜¢', text: 'å¾ˆå·®' }
          ], (item: MoodOption) => {
            Column({ space: 4 }) {
              Text(item.emoji)
                .fontSize(24)
              Text(item.text)
                .fontSize(12)
                .fontColor(this.formMood === item.mood ? '#F34F40' : '#999999')
            }
            .padding(8)
            .backgroundColor(this.formMood === item.mood ? '#FFF5F5' : '#FFFFFF')
            .borderRadius(8)
            .border({ width: 1, color: this.formMood === item.mood ? '#F34F40' : '#E5E5E5' })
            .onClick(() => {
              this.formMood = item.mood;
            })
          }, (item: MoodOption) => item.mood)
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
      }

      // å­¦ä¹ æ—¶é•¿å’Œè§£å†³é¢˜ç›®æ•°
      Row({ space: 12 }) {
        Column({ space: 8 }) {
          Text('å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰')
            .fontSize(14)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)

          TextInput({ placeholder: '0', text: this.formStudyDuration })
            .fontSize(14)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
            .padding({ left: 12, right: 12, top: 12, bottom: 12 })
            .border({ width: 1, color: '#E5E5E5' })
            .type(InputType.Number)
            .onChange((value: string) => {
              this.formStudyDuration = value;
            })
        }
        .layoutWeight(1)

        Column({ space: 8 }) {
          Text('è§£å†³é¢˜ç›®æ•°')
            .fontSize(14)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)

          TextInput({ placeholder: '0', text: this.formProblemsSolved })
            .fontSize(14)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
            .padding({ left: 12, right: 12, top: 12, bottom: 12 })
            .border({ width: 1, color: '#E5E5E5' })
            .type(InputType.Number)
            .onChange((value: string) => {
              this.formProblemsSolved = value;
            })
        }
        .layoutWeight(1)
      }

      // æ—¥è®°å†…å®¹ - å¿…å¡«é¡¹
      Column({ space: 8 }) {
        Row() {
          Text('å­¦ä¹ å¿ƒå¾—')
            .fontSize(14)
            .fontColor('#333333')
          
          Text(' *')
            .fontSize(14)
            .fontColor('#FF4444')
        }
        .alignSelf(ItemAlign.Start)

        TextArea({ placeholder: 'è®°å½•ä»Šå¤©çš„å­¦ä¹ å¿ƒå¾—ã€é‡åˆ°çš„é—®é¢˜ã€æ”¶è·ç­‰...', text: this.formContent })
          .fontSize(14)
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 12, bottom: 12 })
          .border({ width: 1, color: '#E5E5E5' })
          .height(120)
          .onChange((value: string) => {
            this.formContent = value;
          })
      }

      // æ ‡ç­¾
      Column({ space: 8 }) {
        Text('æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)

        TextInput({ placeholder: 'ä¾‹å¦‚ï¼šç®—æ³•,æ•°æ®ç»“æ„,åŠ¨æ€è§„åˆ’', text: this.formTags })
          .fontSize(14)
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 12, bottom: 12 })
          .border({ width: 1, color: '#E5E5E5' })
          .onChange((value: string) => {
            this.formTags = value;
          })
      }
    }
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .padding(20)
  }

  @Builder
  buildBottomButtons() {
    Column({ space: 16 }) {
      if (this.isEditMode) {
        // åˆ é™¤æŒ‰é’®ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
        Button('åˆ é™¤æ—¥è®°')
          .fontSize(16)
          .fontColor('#FF4444')
          .backgroundColor('#FFF0F0')
          .borderRadius(8)
          .width('100%')
          .height(48)
          .onClick(() => {
            this.showDeleteConfirmDialog();
          })
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20, bottom: 20 })
    .backgroundColor('#F5F5F5')
  }

  private validateForm(): boolean {
    if (!this.formTitle.trim()) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥æ—¥è®°æ ‡é¢˜',
        duration: 2000
      });
      return false;
    }

    if (!this.formContent.trim()) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥å­¦ä¹ å¿ƒå¾—',
        duration: 2000
      });
      return false;
    }

    return true;
  }

  private async saveDiary(): Promise<void> {
    if (!this.validateForm()) {
      return;
    }

    try {
      this.isLoading = true;
      
      const diary = new StudyDiaryModel();
      diary.title = this.formTitle.trim();
      diary.content = this.formContent.trim();
      diary.mood = this.formMood;
      diary.studyDuration = parseInt(this.formStudyDuration) || 0;
      diary.problemsSolved = parseInt(this.formProblemsSolved) || 0;
      diary.tags = this.formTags.trim();

      if (this.isEditMode) {
        diary.id = this.diaryId;
        diary.updatedAt = TimeUtils.getLocalISOString();
        await this.studyDiaryDao.updateDiary(diary);
        promptAction.showToast({
          message: 'æ—¥è®°æ›´æ–°æˆåŠŸ',
          duration: 2000
        });
      } else {
        diary.createdAt = TimeUtils.getLocalISOString();
        diary.updatedAt = TimeUtils.getLocalISOString();
        await this.studyDiaryDao.addDiary(diary);
        promptAction.showToast({
          message: 'æ—¥è®°ä¿å­˜æˆåŠŸ',
          duration: 2000
        });
      }

      // ç¡®ä¿æ•°æ®åº“æ“ä½œå®Œå…¨å®Œæˆåå†è¿”å›
      setTimeout(() => {
        router.back();
      }, 100);
    } catch (error) {
      console.error('ä¿å­˜æ—¥è®°å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  private showDeleteConfirmDialog(): void {
    AlertDialog.show({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™ç¯‡å­¦ä¹ æ—¥è®°å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          // å–æ¶ˆæ“ä½œ
        }
      },
      secondaryButton: {
        value: 'åˆ é™¤',
        fontColor: '#FF4444',
        action: () => {
          this.deleteDiary();
        }
      }
    });
  }

  private async deleteDiary(): Promise<void> {
    try {
      this.isLoading = true;
      await this.studyDiaryDao.deleteDiary(this.diaryId);
      promptAction.showToast({
        message: 'æ—¥è®°åˆ é™¤æˆåŠŸ',
        duration: 2000
      });
      // ç¡®ä¿æ•°æ®åº“æ“ä½œå®Œå…¨å®Œæˆåå†è¿”å›
      setTimeout(() => {
        router.back();
      }, 100);
    } catch (error) {
      console.error('åˆ é™¤æ—¥è®°å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }
}